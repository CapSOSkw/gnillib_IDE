'''
**
* @Author: Keyuan Wu
* @Update: 06/03/2018
**
'''
import pandas as pd
import numpy as np
import geocoder
import random
from time import sleep
import re
from datetime import datetime, timedelta
import sys
import os, math
import requests
from PyQt5.QtCore import QCoreApplication, Qt
from PyQt5.QtWidgets import QApplication, QTableWidgetItem, QTableWidget, QWidget, QMainWindow, QPushButton, QAction, QMessageBox, QVBoxLayout, QTabWidget, QFormLayout
from PyQt5.QtWidgets import QCalendarWidget, QFontDialog, QColorDialog, QTextEdit, QFileDialog, QComboBox
from PyQt5.QtWidgets import QCheckBox, QProgressBar, QComboBox, QLabel, QStyleFactory, QLineEdit, QInputDialog, QHBoxLayout, QGridLayout
from PyQt5.QtCore import pyqtSlot
import sqlite3
from sqlalchemy import create_engine
from pprint import pprint
from shapely.geometry import Point, Polygon
import arrow
from ast import literal_eval
pd.options.mode.chained_assignment = None


class info_locker():
    nyc_zip = [10001, 10002, 10003, 10004, 10005, 10006, 10007, 10008, 10009,
               10010, 10011, 10012, 10013, 10014, 10015, 10016, 10017, 10018, 10019, 10020, 10021, 10022, 10023, 10024,
               10025, 10026,
               10027, 10028, 10029, 10030, 10031, 10032, 10033, 10034, 10035, 10036, 10037, 10038, 10039, 10040, 10041,
               10043, 10044,
               10045, 10046, 10047, 10048, 10055, 10060, 10065, 10069, 10072, 10075, 10079, 10080, 10081, 10082, 10087,
               10090, 10094,
               10095, 10096, 10098, 10099, 10101, 10102, 10103, 10104, 10105, 10106, 10107, 10108, 10109, 10110, 10111,
               10112, 10113, 10114,
               10115, 10116, 10117, 10118, 10119, 10120, 10121, 10122, 10123, 10124, 10125, 10126, 10128, 10129, 10130,
               10131, 10132,
               10133, 10138, 10149, 10150, 10151, 10152, 10153, 10154, 10155, 10156, 10157, 10158, 10159, 10160, 10161,
               10162, 10163,
               10164, 10165, 10166, 10167, 10168, 10169, 10170, 10171, 10172, 10173, 10174, 10175, 10176, 10177, 10178,
               10179, 10184,
               10185, 10196, 10197, 10199, 10203, 10211, 10212, 10213, 10242, 10249, 10256, 10257, 10258, 10259, 10260,
               10261, 10265,
               10268, 10269, 10270, 10271, 10272, 10273, 10274, 10275, 10276, 10277, 10278, 10279, 10280, 10281, 10282,
               10285, 10286,
               10292, 10301, 10302, 10303, 10304, 10305, 10306, 10307, 10308, 10309, 10310, 10311, 10312, 10313, 10314,
               10451, 10452,
               10453, 10454, 10455, 10456, 10457, 10458, 10459, 10460, 10461, 10462, 10463, 10464, 10465, 10466, 10467,
               10468, 10469,
               10470, 10471, 10472, 10473, 10474, 10475, 10499, 11101, 11102, 11103, 11104, 11105, 11106, 11109, 11120,
               11201, 11202,
               11203, 11204, 11205, 11206, 11207, 11208, 11209, 11210, 11211, 11212, 11213, 11214, 11215, 11216, 11217,
               11218, 11219,
               11220, 11221, 11222, 11223, 11224, 11225, 11226, 11228, 11229, 11230, 11231, 11232, 11233, 11234, 11235,
               11236, 11237,
               11238, 11239, 11240, 11241, 11242, 11243, 11240, 11245, 11247, 11248, 11249, 11251, 11252, 11354, 11255,
               11256, 11351,
               11352, 11354, 11355, 11356, 11357, 11358, 11359, 11360, 11361, 11362, 11363, 11364, 11365, 11366, 11367,
               11368, 11369,
               11370, 11371, 11372, 11373, 11374, 11375, 11377, 11378, 11379, 11380, 11381, 11385, 11386, 11390, 11405,
               11411, 11412,
               11413, 11414, 11415, 11416, 11417, 11418, 11419, 11420, 11421, 11422, 11423, 11424, 11425, 11426, 11427,
               11428, 11429,
               11430, 11431, 11432, 11433, 11434, 11435, 11436, 11439, 11451, 11499, 11690, 11691, 11692, 11693, 11694,
               11695, 11697, ]

    under_110st_zip = [10001, 10002, 10003, 10004, 10005, 10006, 10007, 10008, 10009, 10010,
                       10011, 10012, 10013, 10014, 10015, 10016, 10017, 10018, 10019, 10020,
                       10021, 10022, 10023, 10024, 10028, 10036, 10038, 10041, 10043, 10044,
                       10045, 10048, 10055, 10060, 10065, 10069, 10075, 10080, 10081, 10087,
                       10090, 10095, 10101, 10102, 10103, 10104, 10105, 10106, 10107, 10108,
                       10109, 10110, 10111, 10112, 10113, 10114, 10116, 10117, 10118, 10119,
                       10120, 10121, 10122, 10123, 10124, 10125, 10126, 10128, 10129, 10130,
                       10131, 10132, 10133, 10138, 10150, 10151, 10152, 10153, 10154, 10155,
                       10156, 10157, 10158, 10159, 10160, 10161, 10162, 10163, 10164, 10165,
                       10166, 10167, 10168, 10169, 10170, 10171, 10172, 10173, 10174, 10175,
                       10176, 10177, 10178, 10179, 10185, 10199, 10203, 10211, 10212, 10213,
                       10242, 10249, 10256, 10257, 10258, 10259, 10260, 10261, 10265, 10268,
                       10269, 10270, 10271, 10272, 10273, 10274, 10275, 10276, 10277, 10278,
                       10279, 10280, 10281, 10282, 10285, 10286, 10292,]  # removed 10029, 10025 on 04/30

    zip_across_110 = [10025, 10026, 10029]

    queens_but_not_nass_zip = [11001, 11004, 11005, 11040]

    NYSDOH = {
        'name': 'NYSDOH',
        'ETIN': 'EMEDNYBAT',
        'id': '141797357',
        'address': 'CORNING TOWER EMPIRE STATE PLAZA',
        'city': 'ALBANY',
        'state': 'NY',
        'zipcode': '12237',

    }

    version_code = {
        '837': '005010X222A1',
        '276': '005010X212',
        '270': '005010X279A1'
    }

    decoding_info = {
        '0': {'code': 'A0100', 'modifier': "", 'price': 25.95},
        '1': {'code': 'A0100', 'modifier': "TN", 'price': 35},
        '2': {'code': 'S0215', 'modifier': "", 'price': 3.21},
        '3': {'code': 'S0215', 'modifier': "TN", 'price': 2.25},
        '4': {'code': 'A0100', 'modifier': "SC", 'price': 25},
        '5': {'code': 'A0170', 'modifier': "CG", }
    }

    MH_below_110st_polygon = Polygon([(-73.96109562266466, 40.80177529451055), (-73.9610282993473, 40.80174690506061), (-73.96011458392711, 40.8013331159968), (-73.95967058683217, 40.801140135471485), (-73.95963046105523, 40.80112370352036), (-73.95853011365138, 40.80065556635905), (-73.95854091783825, 40.8006194647867), (-73.95854185159912, 40.80058045167328), (-73.95853453455408, 40.80053674098381), (-73.95851857445938, 40.80049445531761), (-73.95849395948024, 40.800453811136045), (-73.9584534040728, 40.800409883904436), (-73.95838649477008, 40.80036406849812), (-73.95832572331538, 40.80033890424232), (-73.95827185799585, 40.80032531238351), (-73.95819072751458, 40.80031574774038), (-73.95813364979787, 40.80031796707371), (-73.95808233187158, 40.80032581578571), (-73.95806237440156, 40.80033097313737), (-73.95802255728151, 40.80034486434078), (-73.95794467605496, 40.800380686605806), (-73.95790284607394, 40.80041535032707), (-73.95786694679313, 40.800453574528895), (-73.9578502454948, 40.80048438729791), (-73.95623894093642, 40.799808316281336), (-73.95541566605267, 40.799461468533906), (-73.95538707088306, 40.79944938672205), (-73.95524742005465, 40.799390991267), (-73.95521682987317, 40.79937840603286), (-73.9525601391135, 40.79825327646094), (-73.95253437547682, 40.798242358985405), (-73.95242463571556, 40.798194064134655), (-73.95234510247283, 40.798160651989384), (-73.95231940768544, 40.798150075702), (-73.95095215957483, 40.797572651910016), (-73.95092542854965, 40.79756132311708), (-73.95041683139922, 40.79735265564789), (-73.94972389728869, 40.797066709759854), (-73.94967186364677, 40.79698044982609), (-73.94966685818844, 40.79694761345522), (-73.94968067203223, 40.79689806151958), (-73.94968067203224, 40.796826574673496), (-73.9496641343461, 40.79676959085577), (-73.94963863717082, 40.79672183547419), (-73.9495930250201, 40.796666439873974), (-73.9495184110697, 40.796608086230485), (-73.94947209777554, 40.796589694572575), (-73.94940485578994, 40.79657411678232), (-73.94931986801681, 40.79655666392094), (-73.94920186919195, 40.796554722584474), (-73.94911434851583, 40.79657466697009), (-73.9489886220094, 40.796631344614305), (-73.94891920424588, 40.79669316712561), (-73.94890074639801, 40.79672515591283), (-73.9488480870933, 40.79667554587236), (-73.94767103011091, 40.796177148390754), (-73.94760789979539, 40.79615042037855), (-73.94619472135334, 40.79555188080402), (-73.94586354938879, 40.7954109178937), (-73.94444391559604, 40.79481001910242), (-73.94438192059968, 40.79478362931331), (-73.94284530687713, 40.79413324331849), (-73.94278192110833, 40.79410598988543), (-73.94061134823234, 40.79318366418623), (-73.9382426041808, 40.79217775070103), (-73.93817942880604, 40.79215157056679), (-73.93614922801093, 40.79129743657388), (-73.93583106788908, 40.79109470487022), (-73.93602391823781, 40.790829128125935), (-73.93632010870607, 40.79042595764855), (-73.93669302210031, 40.78991304915909), (-73.93706168747065, 40.78941359021348), (-73.93705304578882, 40.78940641675741), (-73.93708104382303, 40.789366395709955), (-73.93707246262228, 40.78934584188616), (-73.93701479686742, 40.78932128118485), (-73.93614073314123, 40.78894907341049), (-73.93612836235297, 40.788938530059625), (-73.93612689279686, 40.788926867985396), (-73.93621859869954, 40.78880049757427), (-73.93622751295345, 40.78879561294979), (-73.93624303325052, 40.78879577415203), (-73.93714965461105, 40.78916844905946), (-73.93722890167295, 40.788996308037106), (-73.9373978860931, 40.78862171984344), (-73.93741675677393, 40.78857976201887), (-73.93754989162579, 40.78828374452882), (-73.93763482912287, 40.78809424481476), (-73.93768669385376, 40.787973560579), (-73.9376956302226, 40.78795729352048), (-73.93774122176191, 40.78785390435086), (-73.93777363255116, 40.78778335806257), (-73.93781722692913, 40.78768846868085), (-73.9379476897699, 40.787477299429206), (-73.93794590851226, 40.78746915925786), (-73.9379593077519, 40.78745627992998), (-73.93797181801395, 40.78743187338248), (-73.93811570089727, 40.78718476275638), (-73.9381335619299, 40.78716579039842), (-73.9381942962532, 40.78709733029975), (-73.9382451995141, 40.78704106810809), (-73.93853937331656, 40.7867107770001), (-73.93926642644561, 40.785888752564524), (-73.9398261969646, 40.78525655241547), (-73.93983453997878, 40.785253972861675), (-73.93984282390862, 40.78525141086657), (-73.93985267603381, 40.78524393165016), (-73.93988045560614, 40.78523237601269), (-73.93988852061746, 40.785223527347014), (-73.9399100328247, 40.78521196675798), (-73.93992974399461, 40.78520176553128), (-73.93995483679336, 40.78518952279445), (-73.9399897801904, 40.785170477290166), (-73.94001308386727, 40.78515687380637), (-73.94002473252537, 40.78515347642575), (-73.9400498270763, 40.785138513728846), (-73.94006415729082, 40.78513102962005), (-73.94011434323869, 40.785103824644665), (-73.94014947276264, 40.78508725537944), (-73.94018512931011, 40.78506620256322), (-73.94020230181297, 40.78505918714032), (-73.94022475284196, 40.7850451507884), (-73.94023795768312, 40.78503713468404), (-73.94026700995516, 40.78502210145345), (-73.94036209351331, 40.784971984082276), (-73.94045320748533, 40.78492287258088), (-73.94053377198219, 40.78487877160589), (-73.94055093807721, 40.784866742096156), (-73.94058130200904, 40.784853708709235), (-73.94059054968372, 40.78484668914209), (-73.9406235705766, 40.78482965041168), (-73.9406737440216, 40.78480359792665), (-73.94071732676319, 40.78478054106705), (-73.94072128361506, 40.78478054310241), (-73.94074901720526, 40.78476751820214), (-73.94076750825941, 40.7847574951213), (-73.940788680061, 40.784747448788615), (-73.94083088142585, 40.78472742455636), (-73.94102499731886, 40.78463522248635), (-73.94108573710648, 40.7846091665167), (-73.94111082838818, 40.78459714918305), (-73.94113723613098, 40.78458311400423), (-73.94117288854783, 40.78456607696247), (-73.94144612018938, 40.78443147385159), (-73.94152576810184, 40.784390900969875), (-73.94167454195745, 40.78431383063191), (-73.94185448592205, 40.78422074667741), (-73.94201431753095, 40.784137584897415), (-73.94217918595561, 40.78405136339483), (-73.94231388874277, 40.783981166269), (-73.94239128520968, 40.78394072618262), (-73.94243451137065, 40.783917830322345), (-73.94246970444772, 40.78389646094701), (-73.94257225524878, 40.783824724155345), (-73.94260442723565, 40.78380183093073), (-73.94267379818284, 40.78375374314715), (-73.94278137533362, 40.783678190096516), (-73.9428678379267, 40.78361865580254), (-73.94293520531137, 40.78357210608962), (-73.94301663136936, 40.78351486545848), (-73.94311516211302, 40.783446170629645), (-73.94316141910541, 40.78341182999218), (-73.9432056553694, 40.78336984298767), (-73.94323985739751, 40.78332785169434), (-73.9432700303563, 40.78328815517931), (-73.94331027382033, 40.78323318094638), (-73.94334749366392, 40.7831820329985), (-73.94339679077287, 40.78310950284639), (-73.94344105526419, 40.78304918212811), (-73.94355143839512, 40.78290350798574), (-73.94354420712477, 40.7828805243252), (-73.94364823539011, 40.78265616133327), (-73.94388068102414, 40.78153204386692), (-73.94387075988708, 40.781273026571576), (-73.94371468850565, 40.780629815528854), (-73.94360047475412, 40.78015909946618), (-73.94321386265223, 40.779317588659985), (-73.94300423950467, 40.779639495474164), (-73.94278066641971, 40.77950615406815), (-73.94271600545089, 40.77954416947611), (-73.94262799584376, 40.779323118968634), (-73.9427123747622, 40.779214856939795), (-73.94253556320854, 40.77909095606245), (-73.94289340818793, 40.778614093246105), (-73.94265530676857, 40.778124965573824), (-73.94245741056957, 40.77740747334794), (-73.94229506198594, 40.777331962985706), (-73.9422805004479, 40.7773474382286), (-73.94231968904049, 40.77745251876448), (-73.94236333715754, 40.777447010924156), (-73.9424554569809, 40.77774786483619), (-73.94242853953916, 40.77775282756716), (-73.94242491195635, 40.77774231956349), (-73.94238999173223, 40.77774727878926), (-73.94235943486034, 40.777753899191666), (-73.94236233471005, 40.777764959164834), (-73.94233541821139, 40.777768816876666), (-73.94224111393387, 40.777470174115656), (-73.94228549380644, 40.77746024282678), (-73.94224050534213, 40.77733414682101), (-73.94225579604492, 40.77731646027734), (-73.94211982454031, 40.777255566411725), (-73.94218537013923, 40.77716380876225), (-73.94230970713218, 40.777219719880705), (-73.9422936833316, 40.777242936750376), (-73.94243403895516, 40.777300461988794), (-73.94242964535643, 40.7772889494542), (-73.9423378939154, 40.77724890117764), (-73.94238467141903, 40.777171097604565), (-73.94232882916097, 40.77715521668639), (-73.9422762271658, 40.77713387982805), (-73.94222778303707, 40.777107459236944), (-73.94218434184418, 40.77707641580223), (-73.94214666138086, 40.777041291054786), (-73.94211539894573, 40.777002697720185), (-73.94209109987676, 40.77696130902994), (-73.94207418803877, 40.77691784697707), (-73.94200266722274, 40.776185317382705), (-73.94208160457377, 40.77595701631705), (-73.9424010094905, 40.77572692752613), (-73.9425876964068, 40.77521895652805), (-73.94293043781397, 40.77467626803581), (-73.9433389475049, 40.77421119259064), (-73.9436643181476, 40.77384076467938), (-73.94396084370834, 40.773530420594504), (-73.94442433595852, 40.77304532251586), (-73.94487889596707, 40.77256956200726), (-73.94561514012511, 40.77194302658768), (-73.94640418919069, 40.77126904561923), (-73.94690764133767, 40.77073391172355), (-73.9474897545637, 40.77011515401903), (-73.9481404018146, 40.76941675635802), (-73.94866416477885, 40.76885762439943), (-73.94908536768654, 40.76827827079567), (-73.94937332131504, 40.76788219105435), (-73.949579120714, 40.767628930179555), (-73.95006979303062, 40.7670250883833), (-73.9506634515425, 40.76638071134937), (-73.95122497666563, 40.76577119897344), (-73.95176480900405, 40.76516371184316), (-73.95230963181133, 40.76455428860599), (-73.95336559963583, 40.763368170911676), (-73.95441826078606, 40.762184104951054), (-73.95557264605313, 40.76116832623031), (-73.95587222339073, 40.760904712115575), (-73.95630917634158, 40.76050836805681), (-73.9563331896777, 40.760486585563875), (-73.9569784172763, 40.75989675444593), (-73.9573173758794, 40.759592212256564), (-73.9575986944528, 40.75934231825778), (-73.95763772742102, 40.759306739898285), (-73.95800496616825, 40.758971999629296), (-73.95825660841922, 40.75874926119302), (-73.9583612533256, 40.75866024195484), (-73.95838528673994, 40.75863979740053), (-73.95842620189605, 40.75860387300684), (-73.95845501743894, 40.75858090219749), (-73.9584911954165, 40.75854590383047), (-73.95854329679058, 40.758495622935804), (-73.95877790822699, 40.758270920848744), (-73.95907003031206, 40.75793909802028), (-73.95917264248838, 40.757864780393994), (-73.95918103219992, 40.75785611105221), (-73.95965770876657, 40.75726014512322), (-73.95966400300107, 40.75721141218687), (-73.96003900990617, 40.756725350238845), (-73.96036455140823, 40.75626941113339), (-73.96065638180474, 40.75592314955019), (-73.9607970991498, 40.75580477274062), (-73.96079722985934, 40.755804655851975), (-73.96102790867165, 40.75561058457904), (-73.96162927534917, 40.755152384259105), (-73.96213559058086, 40.75457323147327), (-73.96219381838414, 40.75450431515325), (-73.96223125165591, 40.75452213042186), (-73.96268703046536, 40.75400437328663), (-73.96289729202545, 40.75376551709429), (-73.96286896769232, 40.7537425091569), (-73.96316074049744, 40.753412207328125), (-73.96373572283169, 40.75278377577701), (-73.96426352137193, 40.75220690108016), (-73.96482214220784, 40.75159632558229), (-73.96532405586477, 40.75104771827202), (-73.96791272994395, 40.74797093564214), (-73.96811893399276, 40.74772582974988), (-73.96817376101073, 40.74766675374175), (-73.96823574753464, 40.74759121839251), (-73.96836519324148, 40.747433494620104), (-73.96823171715788, 40.7473684764892), (-73.96829622113238, 40.74729565136707), (-73.96829811451529, 40.74728339500281), (-73.96830191005877, 40.74727329974717), (-73.9683161371577, 40.747274024359285), (-73.968326104334, 40.747252034598795), (-73.96834696591318, 40.747241218310016), (-73.96836118844759, 40.747218145486315), (-73.96840008314163, 40.747166953964204), (-73.96843139158786, 40.74712945662025), (-73.96846363690706, 40.747094128485614), (-73.96847691942916, 40.74707250130826), (-73.96850064035854, 40.74704438450719), (-73.9685148595502, 40.747032843998056), (-73.96853479000781, 40.74700039777951), (-73.968544278662, 40.7469881423127), (-73.9685888522455, 40.74694344358074), (-73.96859169569542, 40.74693334755284), (-73.96860023472244, 40.74692109182235), (-73.96860971997503, 40.746914603605646), (-73.96861730876921, 40.746899455777815), (-73.96863912464646, 40.746879274646645), (-73.96866379796619, 40.74684682031493), (-73.96867043421345, 40.74683600997994), (-73.9686922519053, 40.74680860795763), (-73.96870458089755, 40.746800682796184), (-73.96871076544427, 40.74678826391711), (-73.96875271240373, 40.7467427152167), (-73.96894301109302, 40.7465183356965), (-73.96896670537491, 40.746530500799395), (-73.9689736684947, 40.74652900733647), (-73.96898899231675, 40.74650579199733), (-73.96899981595465, 40.74650193477237), (-73.96900302810072, 40.74649080888185), (-73.96901641754052, 40.746481152086254), (-73.96901961115921, 40.746472438902586), (-73.96907193333249, 40.74641298300633), (-73.96913096118847, 40.746340715306665), (-73.96921135921276, 40.74624451530383), (-73.96923432172326, 40.74622228401143), (-73.9692470758419, 40.746207781993604), (-73.96925028881702, 40.746196171442676), (-73.96932591437388, 40.74610408771041), (-73.96933228026558, 40.74610167233748), (-73.9693392445918, 40.746092656088365), (-73.96938290644789, 40.746035949024964), (-73.96940022327871, 40.74602084326546), (-73.96940086652106, 40.746014027129974), (-73.96941753399555, 40.74599696633198), (-73.96943292389864, 40.74597698923128), (-73.96946210038307, 40.7459445776336), (-73.96952046125196, 40.74586904111648), (-73.96955059658644, 40.745838827693575), (-73.9695974026117, 40.745782784111796), (-73.96962370583407, 40.74574671679442), (-73.96963204180261, 40.74574330564597), (-73.9696948777757, 40.74566679689092), (-73.96969678845922, 40.74565700029294), (-73.9698756140306, 40.74544478913761), (-73.96990575265258, 40.74545820514513), (-73.9699122797576, 40.74545175943621), (-73.96993139614953, 40.74546300191986), (-73.96992704959052, 40.745467792034994), (-73.96997377026275, 40.7454957474306), (-73.97004758904896, 40.7454028612993), (-73.97009123175708, 40.74535112915095), (-73.97012962576954, 40.74530536659431), (-73.97021602288636, 40.74520057903282), (-73.97033931161249, 40.74504963202245), (-73.97032571321422, 40.745036949464414), (-73.97032571931103, 40.74502326140015), (-73.97037811940494, 40.74495230608582), (-73.97044255489001, 40.74487037600953), (-73.97046063703624, 40.744864743390714), (-73.97047240576438, 40.74486624174764), (-73.97050560032659, 40.74482376425927), (-73.9705687722909, 40.74473186530609), (-73.97062381510653, 40.74465642621002), (-73.9707883477664, 40.74440621769032), (-73.97085704434353, 40.74443263739717), (-73.97087688233857, 40.74444557343096), (-73.97088963376717, 40.74444772970189), (-73.97089742067709, 40.7444547367797), (-73.9709094613216, 40.74445635209411), (-73.97091724845437, 40.744463360343325), (-73.97092858032359, 40.74446336320418), (-73.97094062960419, 40.74447144402538), (-73.97098222712388, 40.74440763421731), (-73.97101392396074, 40.74435861480509), (-73.97111438123977, 40.74420436093245), (-73.97078276128684, 40.74404724688683), (-73.97077757716114, 40.74404662471932), (-73.97075833953659, 40.74403919088488), (-73.97075084955141, 40.74402980466477), (-73.97071823494039, 40.744016927848136), (-73.97070578720823, 40.744002561986754), (-73.97070317531664, 40.743990495411325), (-73.97072277474838, 40.7439695162238), (-73.97074257272034, 40.743948324660025), (-73.97075061381992, 40.743948634113096), (-73.97076123524693, 40.743942108144225), (-73.97079209694716, 40.74395600993251), (-73.97079892989305, 40.74395279700377), (-73.9708358740414, 40.743969672238066), (-73.97083595486517, 40.743969703585954), (-73.97087357851338, 40.74398767476942), (-73.97095964992808, 40.744025696987066), (-73.97096300193468, 40.74402367277483), (-73.97117346753143, 40.7441075355108), (-73.97118193576082, 40.74410323270784), (-73.97120616502984, 40.744066029846614), (-73.97127362462311, 40.74396474842357), (-73.97135752941868, 40.74383845535943), (-73.9712342398151, 40.743784646190235), (-73.97120546301967, 40.7437715103013), (-73.97128101831679, 40.743651942051315), (-73.97135563409154, 40.74353964985202), (-73.97149421270419, 40.74333467446508), (-73.97163772240417, 40.74311720098464), (-73.97167921200818, 40.74305446405973), (-73.97188888913044, 40.7427248203555), (-73.97176261327057, 40.74267267153466), (-73.97174059715847, 40.74266357950892), (-73.9717750124802, 40.74261591264713), (-73.97195955856255, 40.742337921543665), (-73.97204926316714, 40.741887753776226), (-73.97206949682797, 40.74178890593476), (-73.97210163980682, 40.741623202060914), (-73.97215263572176, 40.7413885876012), (-73.97219804813784, 40.74114466869176), (-73.97228618248475, 40.74073827407892), (-73.97228992099217, 40.74072103903176), (-73.97221282599375, 40.740711663608245), (-73.97219567275302, 40.74070957946137), (-73.972182685701, 40.74070627990962), (-73.97216848387873, 40.740693120300485), (-73.97216477368657, 40.74067572212913), (-73.97216549760822, 40.74067216504992), (-73.97221525425901, 40.740426563519385), (-73.97222515614335, 40.74041669693116), (-73.97223504317165, 40.74041340340195), (-73.97223566211005, 40.74040541522519), (-73.97219641647808, 40.740402578750285), (-73.97221685422328, 40.74030762506154), (-73.97226753642127, 40.740313743277135), (-73.97227001334156, 40.74030857434567), (-73.9722533231916, 40.74030010555479), (-73.97224837803643, 40.740291171858686), (-73.97229979590863, 40.740034962742975), (-73.97231030439093, 40.740018512674816), (-73.97233141721729, 40.7400109081997), (-73.97243888981417, 40.740021749973224), (-73.97265743803038, 40.739222754276966), (-73.9726552896889, 40.73917826848004), (-73.97265060379681, 40.73905826571552), (-73.97264431062416, 40.73901746233531), (-73.97264512721948, 40.738958668310985), (-73.97264674830737, 40.73884587151235), (-73.97263256455145, 40.738789470052716), (-73.97263100998644, 40.73874026500811), (-73.97262787457514, 40.73870906197219), (-73.97262630543385, 40.73866586408445), (-73.9726279218979, 40.73859386967112), (-73.97262084766338, 40.73852066599611), (-73.97261929656231, 40.73846306804593), (-73.97262753952535, 40.738400385484816), (-73.9726388480015, 40.73839530977717), (-73.9726383333126, 40.73837968597649), (-73.97262807328735, 40.7383679672454), (-73.97262452608501, 40.73824336345697), (-73.97263274644142, 40.73823242426216), (-73.97263327107365, 40.738223833298434), (-73.9726225471807, 40.73821706821176), (-73.97261946865987, 40.73804427874751), (-73.97261474017301, 40.738029869348026), (-73.97260609997485, 40.737938672288735), (-73.97261872947438, 40.73791467680063), (-73.97261242656481, 40.737897872069055), (-73.97260457307685, 40.737822273075636), (-73.97261404225615, 40.737798276835846), (-73.97260621196624, 40.73766627757036), (-73.97259038224658, 40.736769655344816), (-73.97258292456084, 40.73674468509606), (-73.97257979798489, 40.736690689579284), (-73.97257525871026, 40.73664650893148), (-73.97255622610959, 40.736461485527485), (-73.97256333684314, 40.73644588163205), (-73.97248994174741, 40.73580328010761), (-73.97251016786021, 40.735787129859595), (-73.97286939178467, 40.73577086128555), (-73.97441385816532, 40.73641439385896), (-73.97445975070463, 40.736294019718315), (-73.97441677354789, 40.73627772610675), (-73.97441154346602, 40.73628527904678), (-73.97439952343295, 40.73628408408968), (-73.97402692104305, 40.73612576724549), (-73.97404679254456, 40.73609992993463), (-73.97442932366876, 40.736260633491455), (-73.97442775474407, 40.73626619954395), (-73.97446647047286, 40.73627845682991), (-73.97450376013228, 40.73606458844403), (-73.97447471755301, 40.73606238071297), (-73.97444082924042, 40.73605047965699), (-73.97443372879937, 40.73605371686953), (-73.97414062018372, 40.735955657167324), (-73.97415127634781, 40.735933792668064), (-73.97444722336765, 40.73603347295401), (-73.97444828612812, 40.7360377928591), (-73.97447828183081, 40.736044185451064), (-73.97450488285963, 40.73604228053671), (-73.97451459772599, 40.735894598411235), (-73.97450793938161, 40.73579694577236), (-73.97448854079045, 40.73587568074894), (-73.97445077717819, 40.735869129966694), (-73.97446233335455, 40.73583114456821), (-73.97424982468374, 40.735797182019994), (-73.97424630658303, 40.73578011045584), (-73.97425866775502, 40.73576626816384), (-73.9744704050787, 40.73579787225513), (-73.97446962023734, 40.73578786807184), (-73.97447775431175, 40.73578786216862), (-73.97447154941652, 40.73572722426049), (-73.97446537767371, 40.73566688606369), (-73.97439223918198, 40.73566753456822), (-73.9743918549318, 40.735671948637204), (-73.97426375884302, 40.7356714742932), (-73.97426474799444, 40.73567587660677), (-73.97419233708438, 40.73568012679809), (-73.9741895600019, 40.7356599127693), (-73.97415747430529, 40.735657841982714), (-73.9741461652345, 40.735671622012916), (-73.97409287937934, 40.735640725531404), (-73.97409007994668, 40.73564465423447), (-73.97341869582557, 40.73536773730012), (-73.97343881801847, 40.73534121781404), (-73.9732803029099, 40.73527336542803), (-73.97305698712047, 40.73517745341554), (-73.97280661710461, 40.73552391852113), (-73.97293673973685, 40.73559924929964), (-73.97293031926458, 40.73560761439666), (-73.97276308380353, 40.73550508747356), (-73.97299695202484, 40.73518650689109), (-73.97296395268074, 40.735169066679916), (-73.9729318560978, 40.73520531236896), (-73.97288512856933, 40.73518020390186), (-73.97286403116163, 40.735212267015214), (-73.97283745943461, 40.735199716704415), (-73.97294520758682, 40.73506517007111), (-73.97296719785798, 40.735078430766805), (-73.97294519031814, 40.7351077005131), (-73.97299560236567, 40.73512793848568), (-73.97297083635605, 40.735157216971274), (-73.97300291199267, 40.73517256003524), (-73.97303684713691, 40.7351279481501), (-73.9732989504614, 40.735242355077084), (-73.97332187458159, 40.73520191866479), (-73.97331638345146, 40.73519634278202), (-73.97329897672444, 40.73517681588363), (-73.97327881634085, 40.73514752741428), (-73.97327241144065, 40.73511893385147), (-73.97327700851476, 40.735079195798335), (-73.97329627362966, 40.73504085664251), (-73.97332929043598, 40.735010877391716), (-73.97336870942675, 40.73498927476267), (-73.97341821248351, 40.73497115816109), (-73.97345945915032, 40.73496837685119), (-73.973522708343, 40.734975360846946), (-73.97354472883961, 40.73494432610145), (-73.97444065082591, 40.73531677190054), (-73.97442616184144, 40.73523421968612), (-73.97441126714136, 40.7351782454519), (-73.97439063081423, 40.73509213293308), (-73.97437417946838, 40.735030636339424), (-73.97435054998002, 40.73494231313639), (-73.97431559737869, 40.73480367719344), (-73.97427147926832, 40.73463060898139), (-73.97425543467872, 40.73456688586326), (-73.9742119222655, 40.734405868942865), (-73.97418317281985, 40.734300956916485), (-73.97416917978917, 40.73423971179249), (-73.97415110840346, 40.73416396616608), (-73.97410591714225, 40.73399354354752), (-73.97406016216327, 40.73381107244231), (-73.97402174588258, 40.73366389393438), (-73.97399237089755, 40.73355457425366), (-73.97395905029711, 40.73342116553846), (-73.97394321924938, 40.73340308886323), (-73.97393531356985, 40.733366076783966), (-73.97390702695188, 40.733349716608224), (-73.9739013771137, 40.73332733730498), (-73.97389120382256, 40.733309261904495), (-73.97386631865598, 40.73331097608678), (-73.97386292958613, 40.733291182396066), (-73.97385275193642, 40.73328257140103), (-73.97384483854886, 40.733265361113745), (-73.97386520802412, 40.73324642803961), (-73.97385730036494, 40.73321630363855), (-73.97384145962661, 40.73321974036562), (-73.97384937381277, 40.73323265510628), (-73.97383126846691, 40.733245565109115), (-73.97380976846561, 40.733248999372925), (-73.97378375783401, 40.73322748070547), (-73.97380298847435, 40.73321198753978), (-73.97378376867152, 40.733199934826935), (-73.9737645264947, 40.73321284338783), (-73.97374076899372, 40.73320938893706), (-73.97372718707769, 40.73321971435088), (-73.9737079516958, 40.7332136852049), (-73.97368984982586, 40.73321885110604), (-73.9736762757606, 40.73320593388803), (-73.97369438098609, 40.733195609010984), (-73.97369212859826, 40.73317409574745), (-73.97371588914251, 40.733169796747134), (-73.97372607356357, 40.73315947055946), (-73.97373739762322, 40.73314311937236), (-73.97375776032726, 40.733139684862834), (-73.97377813922655, 40.73312419146021), (-73.9738052975529, 40.733120757484336), (-73.97381887171846, 40.733099247654565), (-73.97384036797052, 40.7331035562959), (-73.97387206174017, 40.73309495480662), (-73.97386810776207, 40.733065687195605), (-73.97377030826173, 40.73268844617683), (-73.97367702799234, 40.732310231251354), (-73.97364735766602, 40.73217549376651), (-73.9736273640125, 40.73210744560781), (-73.97360833346643, 40.73204268972966), (-73.97353969289706, 40.73176433282343), (-73.97352137914282, 40.73169016478124), (-73.97341321730858, 40.73128241642864), (-73.97338181410127, 40.73123602442194), (-73.97336591000702, 40.73122001994833), (-73.97334064688684, 40.73118304166194), (-73.97331715426381, 40.73115792717309), (-73.9732832111114, 40.731112675908534), (-73.97323625417937, 40.731056926741), (-73.97320012915412, 40.73101663239006), (-73.97314592791604, 40.73096088099611), (-73.97309858148473, 40.730913679890676), (-73.97305304853803, 40.73086730375558), (-73.9730060597538, 40.730823131910476), (-73.97291929100193, 40.73075024150263), (-73.97283215562837, 40.73068148130965), (-73.97274611643171, 40.73060583194688), (-73.97264270492411, 40.730523537807315), (-73.97255990007292, 40.73045809361812), (-73.97247970053022, 40.73040080736284), (-73.97245936471903, 40.730386329377666), (-73.97233277439494, 40.73029657297071), (-73.97224018578797, 40.730230497135935), (-73.97223370120912, 40.73022567784319), (-73.97208918590233, 40.73011835704164), (-73.97205385214976, 40.73008665043248), (-73.97201026033457, 40.73004517148759), (-73.97196340301248, 40.73000037721747), (-73.97190238512808, 40.729930708644424), (-73.97185608949049, 40.729875550267224), (-73.97182992841697, 40.7298456914702), (-73.97174822357015, 40.72974201454455), (-73.97174494790077, 40.729734548588496), (-73.9717002903813, 40.72966570245395), (-73.97162729998558, 40.72955788414599), (-73.97157719441805, 40.729469136637825), (-73.97151882628016, 40.72935136174013), (-73.97150816031574, 40.72932396649239), (-73.97147994907206, 40.729249577698404), (-73.97145716122309, 40.729169407557954), (-73.97143981566717, 40.72909584986445), (-73.97143221814216, 40.72906361904417), (-73.97142139208238, 40.728995843972214), (-73.97141235109775, 40.72887985602162), (-73.9714065967207, 40.728794471305726), (-73.97140617908519, 40.72871876425102), (-73.97141946379276, 40.72856882754402), (-73.97142718443529, 40.72848582638753), (-73.97145269559661, 40.72834143331312), (-73.97145662182929, 40.72831923851686), (-73.97147343819987, 40.728209255928014), (-73.97151048447927, 40.7280027639066), (-73.97155553514953, 40.72770310859809), (-73.97156931647098, 40.72769376719842), (-73.97157278760145, 40.72764591976768), (-73.97158965149985, 40.72764003369326), (-73.97161872706997, 40.727650558185786), (-73.97163586152148, 40.72764797412131), (-73.97165160075588, 40.72764321253462), (-73.97168514866583, 40.727405886636525), (-73.97158604106329, 40.72739693305268), (-73.97156114365914, 40.72739468824762), (-73.97153686592743, 40.72739296510078), (-73.97152076789605, 40.72738616623969), (-73.97151282181237, 40.7273743085811), (-73.97149260058237, 40.72737312335133), (-73.97149039092832, 40.72735009810991), (-73.97162697271727, 40.726628452996835), (-73.9716697270118, 40.726392327154336), (-73.97169587451619, 40.72624182930231), (-73.97171894361507, 40.72612199325951), (-73.97173843379365, 40.72599966755549), (-73.97176755410217, 40.7258333034546), (-73.97177410965313, 40.72582128133706), (-73.9717914296149, 40.72581422114905), (-73.97181650587731, 40.72581496675248), (-73.97185935830923, 40.72558296903027), (-73.97187437695217, 40.72550311607979), (-73.97188490951483, 40.725424405065766), (-73.9719112073207, 40.72529037069992), (-73.97193374501076, 40.72517629035121), (-73.97193975456322, 40.72515803861002), (-73.97196154778587, 40.7250399788108), (-73.97200511841208, 40.724841489708204), (-73.97203666966882, 40.72468407002005), (-73.97206595867414, 40.72455915832865), (-73.97207196960349, 40.724536350858095), (-73.97208098151926, 40.724497567930335), (-73.97208400057288, 40.72446790554567), (-73.97209751290906, 40.724423415234675), (-73.97215609001728, 40.7241701782781), (-73.97216585996642, 40.724131963273145), (-73.972216923762, 40.72393005464672), (-73.97223344676965, 40.723846779926305), (-73.97226499868242, 40.72371445733361), (-73.97232507731586, 40.723463499327295), (-73.97236115744649, 40.72331206047645), (-73.97239945748277, 40.723148816366596), (-73.97251011180381, 40.7226968860067), (-73.97288971396699, 40.7210882972193), (-73.9729473798727, 40.72085908387975), (-73.97304357865474, 40.72043966516316), (-73.97314831153228, 40.72002143152573), (-73.97326155317316, 40.71960448348709), (-73.97338327620163, 40.719188921256084), (-73.97351345120518, 40.71877484470659), (-73.97361977761689, 40.71845968395389), (-73.97381026810986, 40.71790580610874), (-73.97400917596548, 40.71735364414587), (-73.97421647429394, 40.71680327213116), (-73.97443213508203, 40.71625476388854), (-73.97465612919697, 40.71570819299017), (-73.97488842639045, 40.715163632746524), (-73.97512899530274, 40.714621156196664), (-73.9751497793714, 40.7145794233609), (-73.97516360806169, 40.71455190619375), (-73.97518850986306, 40.71450316072391), (-73.97521387023663, 40.714448498798426), (-73.97522549627958, 40.71442343994192), (-73.97524666388625, 40.714377806305464), (-73.97524670420714, 40.71437772506357), (-73.9758031128397, 40.71317812458917), (-73.97579532792415, 40.71317002369419), (-73.97596844519694, 40.71278957339083), (-73.97604981455508, 40.71260419377787), (-73.9761236883879, 40.71246032539832), (-73.9761653123832, 40.7124201979108), (-73.97631127867197, 40.712118647310135), (-73.97642872514528, 40.71190903250366), (-73.97650540115391, 40.711798789452466), (-73.9765500881422, 40.711734538728294), (-73.97671221539667, 40.71153576517838), (-73.97681883540065, 40.71141956702117), (-73.97699076574627, 40.71125666023055), (-73.97705659401734, 40.71119762696939), (-73.9772221356257, 40.7110687312283), (-73.97752668432639, 40.71084307273315), (-73.97772119493068, 40.7107100746607), (-73.97782091638246, 40.710645444906966), (-73.97789949619445, 40.71059986620237), (-73.97799674790384, 40.710561017391605), (-73.97807974906605, 40.71053225107981), (-73.97818190694284, 40.71050686551763), (-73.97825557749195, 40.71049790955784), (-73.97837148165257, 40.71048970749154), (-73.97861560123998, 40.71047378191086), (-73.97877613342084, 40.71046331504722), (-73.97918894377005, 40.71043492338827), (-73.97920726434594, 40.71043366689569), (-73.9792901523712, 40.710428144566926), (-73.98003642292834, 40.71037840126665), (-73.98028344332192, 40.710361815108435), (-73.98033652490459, 40.710359201217265), (-73.98033090124429, 40.71028693831353), (-73.98051046026364, 40.71027475194566), (-73.98128647552558, 40.710218347881636), (-73.98124579569945, 40.70982621460123), (-73.98306019477401, 40.70964791174809), (-73.98364234472635, 40.709591879244726), (-73.98449647076764, 40.70950966393941), (-73.98655035339972, 40.709311944641996), (-73.98816491726686, 40.70915678150646), (-73.98817340967875, 40.709147518301265), (-73.98839064023267, 40.70912694916265), (-73.98844653437385, 40.709133820546974), (-73.98847967268766, 40.70915584730847), (-73.98849727173871, 40.709176305795744), (-73.9886365807185, 40.70991206151628), (-73.98864533493676, 40.709916934401114), (-73.98866750580943, 40.709920034830716), (-73.98869610271332, 40.70992844984454), (-73.98871771111239, 40.70994709051883), (-73.98873681707525, 40.70997074184507), (-73.98879717785803, 40.709966607472225), (-73.98889845980884, 40.709954735765), (-73.98935765696677, 40.70990098670785), (-73.98946067019428, 40.70988928705126), (-73.98957449608717, 40.7098740816065), (-73.98974515155741, 40.70984876165562), (-73.99015825373382, 40.70979037266374), (-73.9905142037669, 40.70973388462137), (-73.99078913018568, 40.709689506086086), (-73.99106783463002, 40.70965723034519), (-73.9913510923706, 40.709620332703324), (-73.99170260292517, 40.70956526295603), (-73.99176779580127, 40.70955505602629), (-73.9919054436645, 40.70952539658225), (-73.99203926968352, 40.70951691916273), (-73.99209131635973, 40.70950822240118), (-73.9921486897015, 40.70949860910409), (-73.9923611613991, 40.70946436881143), (-73.99284846748647, 40.70938187763873), (-73.99374012862228, 40.70924612043532), (-73.99400820164045, 40.70923747991901), (-73.99414063200345, 40.70923326739993), (-73.99437823543936, 40.70919263919891), (-73.99457899963724, 40.70913097291005), (-73.99517577369834, 40.70903429381029), (-73.99580385653569, 40.708946013907486), (-73.99601898395763, 40.70891622384743), (-73.9966640099659, 40.7088269045177), (-73.99728287195578, 40.7087316198429), (-73.99808351186999, 40.708509615367134), (-73.99828602320592, 40.70842993146759), (-73.99852758585311, 40.70833152790828), (-73.99856114620616, 40.70831528323355), (-73.99872197955064, 40.708237452896164), (-73.99875396570859, 40.70822365152976), (-73.99880846276643, 40.708200134992666), (-73.99882158420985, 40.70817548117489), (-73.9988813086388, 40.708136633919786), (-73.99898340963244, 40.708092653316136), (-73.99905276738552, 40.70803254536376), (-73.9991343491895, 40.707982397448504), (-73.99919451108852, 40.70794737635147), (-73.99925945470771, 40.7079140213104), (-73.99932632675426, 40.707879676493924), (-73.9993822517736, 40.707841549321515), (-73.99942129138608, 40.70781893705531), (-73.99946033075192, 40.70779632645105), (-73.99952324941067, 40.70776262865813), (-73.99951211364754, 40.70774870660909), (-73.99949062474623, 40.70772184522498), (-73.9995383965945, 40.70769347002565), (-73.99955121325496, 40.7076943527765), (-73.9995714951379, 40.70771719818587), (-73.99960948039251, 40.70775997317629), (-73.9998829708522, 40.7076240860353), (-73.9999485594979, 40.707591496370966), (-73.99994505655111, 40.7075826269833), (-73.9999485595232, 40.70755869155376), (-73.99995671262306, 40.70753119885585), (-73.99997222648798, 40.70750639882204), (-73.99999645016025, 40.707491647898486), (-74.00013868859142, 40.7074050544075), (-74.00023380525761, 40.70734714248683), (-74.0004002783203, 40.70726027957068), (-74.00055247932056, 40.707184275922955), (-74.00077175219104, 40.70708014820075), (-74.00084973367689, 40.707043119139115), (-74.00088259097623, 40.707025253300515), (-74.0011868526283, 40.70685982577176), (-74.00113130577202, 40.706799050684516), (-74.00122367538822, 40.70674526164774), (-74.00123213691967, 40.70674033693098), (-74.00122701299958, 40.70673486990648), (-74.00116039022576, 40.70666372083431), (-74.00117521610984, 40.70664874526913), (-74.00116913341543, 40.70663949766775), (-74.00117643567688, 40.70663505879536), (-74.0011760207968, 40.70662757435898), (-74.00098276691733, 40.70641671299293), (-74.00140533024056, 40.70618013520787), (-74.00140666691954, 40.706179388020644), (-74.00140581495842, 40.706178612883114), (-74.0005829704798, 40.7054339336489), (-74.0005924020935, 40.7054100794135), (-74.00084523503796, 40.70525451884621), (-74.00143719471637, 40.70487222494061), (-74.00145437418847, 40.704873303432066), (-74.0014608576564, 40.7048737178121), (-74.00183509983015, 40.70521225882238), (-74.00205517727979, 40.70541134986922), (-74.00206142563809, 40.70541700564076), (-74.00206282084558, 40.705416077347955), (-74.00212278686422, 40.705379002672466), (-74.0021581834855, 40.705357119118524), (-74.00256965059467, 40.70552357952351), (-74.00268512768794, 40.70544924811866), (-74.00236285311746, 40.705158966692586), (-74.00241573476919, 40.705129311282505), (-74.00238385458344, 40.7051012702508), (-74.00197070397948, 40.7047378684872), (-74.00197014837805, 40.70473115920231), (-74.00203201379027, 40.70469295373008), (-74.002171849419, 40.70460659646368), (-74.00218562331565, 40.70460701887393), (-74.00233344621164, 40.70474813530699), (-74.00233393075767, 40.70474260740416), (-74.00242059318668, 40.70468033460376), (-74.00243071075865, 40.704677858004345), (-74.00248839829258, 40.7047267723512), (-74.00248790148639, 40.70473376109163), (-74.00239832748953, 40.70479492514084), (-74.00238670740679, 40.70479566367449), (-74.00332307270787, 40.70562859522006), (-74.00358262337757, 40.705461128831146), (-74.00363187169326, 40.705429806751745), (-74.00360802644224, 40.70540778137037), (-74.00355934714831, 40.705438338158146), (-74.00287843069457, 40.704831357989754), (-74.0029724647529, 40.70476649244255), (-74.00358383172679, 40.70530161130755), (-74.00364968772807, 40.705377950512094), (-74.00362197523806, 40.70539889998434), (-74.00364446183868, 40.7054216846388), (-74.00383327532258, 40.705303243026385), (-74.00394758957442, 40.70540287190027), (-74.00438344417225, 40.70511325985483), (-74.00426687037428, 40.70501166020204), (-74.00458622952465, 40.70479945067928), (-74.00459003883674, 40.704787752945), (-74.00349632042325, 40.70379676926769), (-74.0035101643443, 40.70378808825903), (-74.00371987043039, 40.703654481944646), (-74.00396975693849, 40.703881645118), (-74.00480628900745, 40.70464206905116), (-74.00484062824783, 40.70463977952648), (-74.00492037826479, 40.704591004973324), (-74.00518805067325, 40.70442053569061), (-74.00511107204136, 40.704350605261936), (-74.00508460380274, 40.70436635582887), (-74.00492580498366, 40.70421180838466), (-74.00500393507072, 40.704165312544525), (-74.00516296842162, 40.70432009323667), (-74.00513867768038, 40.70433455643978), (-74.00521160900404, 40.704405532235334), (-74.00526035829184, 40.704374488410124), (-74.00535027224755, 40.70431007996153), (-74.00418492090171, 40.70324806617636), (-74.0041813014302, 40.70325036143015), (-74.00415742154166, 40.70323163208722), (-74.00416265161378, 40.703227768889136), (-74.00420723493845, 40.7031993737578), (-74.00411763228837, 40.703111937027394), (-74.004272587521, 40.703015666411495), (-74.00429788566103, 40.70301726836967), (-74.00432634521921, 40.703044544245884), (-74.00434743166838, 40.70304694729882), (-74.00436534740597, 40.70307021681559), (-74.00438643514074, 40.70308866795957), (-74.00441805325266, 40.703116735258334), (-74.00444124738812, 40.70313759836757), (-74.00448447402032, 40.70317690392736), (-74.0046252093554, 40.70330003518531), (-74.00462626412609, 40.70331447916804), (-74.00465050979122, 40.70332972316347), (-74.00466632025643, 40.70334817446867), (-74.00467686257012, 40.70334817404079), (-74.00474855169048, 40.703419564148824), (-74.00480222883246, 40.70348400677521), (-74.00483652285261, 40.70351292639169), (-74.00498836312717, 40.703637436151816), (-74.00503377442325, 40.7036749205554), (-74.00510304451785, 40.703731143473874), (-74.00520771937106, 40.70382133725155), (-74.00527929789541, 40.7038752180963), (-74.0053489153774, 40.70392373409765), (-74.0053594587807, 40.703919725687484), (-74.00539635538084, 40.703942183324386), (-74.00538791847222, 40.70394940514524), (-74.00559242542967, 40.70408256373165), (-74.00560507496262, 40.7040849669635), (-74.00563775955965, 40.70410583053918), (-74.00566330640657, 40.7041042444782), (-74.0058912988893, 40.703959853441965), (-74.00602048621096, 40.70387490010186), (-74.00614106753552, 40.703980973435414), (-74.00634215560278, 40.70384982260742), (-74.00643259271952, 40.70379118995163), (-74.0065959191387, 40.70368590194925), (-74.006320807539, 40.70346676102887), (-74.00631484519418, 40.70346132409439), (-74.00630030777441, 40.703448234988265), (-74.0059114573594, 40.703098111430414), (-74.00589941745793, 40.70308727019193), (-74.00588747266437, 40.70307651522381), (-74.00555843304463, 40.70278125688987), (-74.0054838408244, 40.70271432213405), (-74.00552682615239, 40.70268528761711), (-74.00550531272071, 40.70266684658556), (-74.00547130861277, 40.70268982908348), (-74.00543599763355, 40.70265955541134), (-74.00542728826248, 40.70266543619403), (-74.00530412596079, 40.70255986563302), (-74.00549427805105, 40.70243138195556), (-74.00550166067457, 40.70243086779703), (-74.00561361797627, 40.70253024203234), (-74.00560163196413, 40.7025380597699), (-74.00560905264517, 40.7025528185537), (-74.00559479485835, 40.70256802032948), (-74.00559935100478, 40.70258016783928), (-74.00559022977765, 40.70258581428387), (-74.00559194611431, 40.702598835921144), (-74.00558509547804, 40.702604050202375), (-74.00558909594902, 40.70261273059684), (-74.00553546138177, 40.70264552110683), (-74.00555771998816, 40.702664394652025), (-74.00567522249858, 40.70258407270014), (-74.00598430339494, 40.70286001804111), (-74.00608976093835, 40.70295112049115), (-74.00623870508532, 40.70307978930158), (-74.00636372730409, 40.703187792252514), (-74.00646028831753, 40.70327120803406), (-74.00649425191108, 40.70330054817178), (-74.00654880812654, 40.703367615085874), (-74.00655720878507, 40.703363148333274), (-74.00675541584032, 40.703541489476805), (-74.00678502191052, 40.70356812790527), (-74.00699466002457, 40.7034411885666), (-74.00722046663674, 40.70330197730325), (-74.007519052838, 40.703121820237115), (-74.0075271497927, 40.70311498141614), (-74.00760498179525, 40.70299314165838), (-74.00764555161307, 40.702928174778926), (-74.00765095550906, 40.70291983910504), (-74.00765840854544, 40.70290916746311), (-74.00770527479773, 40.7028818254073), (-74.00770614970409, 40.702875161620085), (-74.00796578643664, 40.702718157070166), (-74.0083739580164, 40.70246975865777), (-74.0091277275891, 40.702008324421655), (-74.00915955533823, 40.70199730765), (-74.00930907655483, 40.70195460302256), (-74.00869964313567, 40.70113986754221), (-74.0077554915064, 40.70154800167179), (-74.0075913620422, 40.7013280810481), (-74.00853611510774, 40.70091969574505), (-74.008349275591, 40.7006693483882), (-74.00862036163876, 40.70055216421584), (-74.00960052263288, 40.701865481917835), (-74.01026747279734, 40.70169850845766), (-74.01083810085723, 40.701553046712256), (-74.01107989699028, 40.701497100259445), (-74.01116664151887, 40.70147720220832), (-74.0110958860268, 40.701274999348854), (-74.01111949092332, 40.70126874830571), (-74.01112667396993, 40.70127499637669), (-74.01128983905525, 40.70124998224425), (-74.0112097577877, 40.701044583273756), (-74.01112868539609, 40.70106489745045), (-74.01107837974551, 40.700957120315074), (-74.01106708568963, 40.70091494089484), (-74.01110886351555, 40.700901420606286), (-74.01109386310776, 40.700866410371034), (-74.01109337389371, 40.70085125657556), (-74.01107872437127, 40.70085194903638), (-74.01105584312833, 40.70081153127281), (-74.01105943295772, 40.70080262149502), (-74.01103748928746, 40.7007571312481), (-74.01101538388583, 40.70074112479906), (-74.01102945843253, 40.700731171496294), (-74.01101999687323, 40.700712395448335), (-74.01100668082337, 40.70071138770599), (-74.01099272755786, 40.70069059304705), (-74.0110085466105, 40.70068355723434), (-74.01100361903022, 40.70066806679778), (-74.01099134410617, 40.700673352282), (-74.01096997178928, 40.700645536089574), (-74.01098841773411, 40.70063424450253), (-74.01095827294415, 40.700574591600024), (-74.01093617683645, 40.70057584194702), (-74.01092482717033, 40.70056679303635), (-74.01092557334937, 40.70055583199386), (-74.01094712848688, 40.700537743035746), (-74.01091918086533, 40.70048646359446), (-74.01090496934044, 40.70049178376392), (-74.01088462665342, 40.70046142740956), (-74.01090366423298, 40.70045138201495), (-74.01078537980491, 40.70023251447074), (-74.01079959311006, 40.70020721300696), (-74.01081530667376, 40.700200444603745), (-74.01085157384671, 40.700238511084905), (-74.01093093205078, 40.70041515233439), (-74.01100364429975, 40.70058110994409), (-74.01104377249544, 40.70068284521962), (-74.01107427475976, 40.70074833789611), (-74.01110436404355, 40.70081064942935), (-74.01113362222922, 40.70086787440551), (-74.01115033556839, 40.70089840010094), (-74.01135836291354, 40.70085195863633), (-74.0113031892116, 40.70064784403631), (-74.0112981643226, 40.70059888503188), (-74.01130986410949, 40.70057980119107), (-74.0113340941042, 40.700568353682264), (-74.01136082267432, 40.700565810999244), (-74.0113817187564, 40.700570257117825), (-74.01139508123386, 40.700590607673746), (-74.01143269912247, 40.70067454111625), (-74.01146947437395, 40.70074892825803), (-74.01150291143712, 40.70081505897421), (-74.01172926817476, 40.70077011805966), (-74.01170009248338, 40.70072153863589), (-74.01168275397707, 40.70069334506205), (-74.01166539833068, 40.700637560590245), (-74.01163149614044, 40.70055539174732), (-74.01161019835878, 40.70049300642146), (-74.01161413587113, 40.70047261846256), (-74.01163147918649, 40.7004582182481), (-74.01167798034295, 40.70046181520745), (-74.01170321011992, 40.70048100238678), (-74.0117260583568, 40.70047860442187), (-74.01175129264934, 40.70053078758629), (-74.01177730827746, 40.700570974877515), (-74.0118261923343, 40.70066634278202), (-74.01183407601519, 40.70068613447613), (-74.01184827026117, 40.700729925805916), (-74.01185378549589, 40.70073892145015), (-74.01199159781133, 40.70070483146642), (-74.01208668214693, 40.70068130873918), (-74.01208509377953, 40.700664514803854), (-74.01206932171665, 40.70059973334407), (-74.01203856797002, 40.7005289563097), (-74.01197670642495, 40.7003784242992), (-74.01190488098494, 40.700226930001975), (-74.01185672556994, 40.70010710340839), (-74.01193096316568, 40.70005120965431), (-74.01196196116918, 40.70003754559545), (-74.01204027930206, 40.70004809164553), (-74.01208842091683, 40.70008658368945), (-74.0121275950614, 40.70014308650671), (-74.01215779158518, 40.700211378648135), (-74.01217247960996, 40.70023311559768), (-74.01223694549938, 40.700321277844274), (-74.012254902849, 40.70036473434146), (-74.01231855974251, 40.70048828759264), (-74.01236222440261, 40.70057582996201), (-74.01239160032284, 40.70062052809402), (-74.01259392327508, 40.70057083347242), (-74.01259064684221, 40.700511850508086), (-74.01255471870938, 40.700359730657745), (-74.01252899955233, 40.700252320356945), (-74.01251593564191, 40.70018464848013), (-74.01251511280124, 40.70015049211081), (-74.01254202780166, 40.7001349741483), (-74.01261382087365, 40.70010826581107), (-74.0126480885809, 40.70011508828298), (-74.01268072728449, 40.70014675538145), (-74.0127349915857, 40.70021877320353), (-74.01279619139252, 40.70030009988461), (-74.01283454933409, 40.70035287473447), (-74.01286637756563, 40.70040751337172), (-74.01288188403385, 40.70044165988612), (-74.01290474249372, 40.70049691216278), (-74.01290881793956, 40.7005236116935), (-74.01300205335569, 40.700516028968025), (-74.01310747847371, 40.700507452180645), (-74.01311155389506, 40.700472053044614), (-74.01311153191459, 40.70036029060313), (-74.01309395831629, 40.700223693239856), (-74.01307843485952, 40.70010324258423), (-74.0130249570557, 40.69988283020606), (-74.0130118926586, 40.69981825663123), (-74.0130208570277, 40.699793419367936), (-74.01304370092437, 40.699774784735865), (-74.01311303826314, 40.69977416588525), (-74.01314078965092, 40.69980333792549), (-74.01315384897731, 40.69984494048537), (-74.01316691626805, 40.69993124433758), (-74.01317753563323, 40.70001754746247), (-74.01318571684631, 40.70010323034386), (-74.01320084197317, 40.700239827976105), (-74.01320736787197, 40.700275216518826), (-74.013222880169, 40.700333586085414), (-74.01327349483086, 40.70049687022777), (-74.01348560832739, 40.700478222908394), (-74.01348068493701, 40.7003577710684), (-74.01348311536113, 40.700263388116284), (-74.01350349660866, 40.700176459528265), (-74.01353285018102, 40.700108161423245), (-74.01358669315087, 40.70007959034501), (-74.01361029830733, 40.700084298589694), (-74.01367479314794, 40.700125821450825), (-74.01366274969912, 40.70013665703527), (-74.01364265186702, 40.70016178280938), (-74.01361182269157, 40.70024517465057), (-74.01357049009951, 40.70023220337395), (-74.01356130931909, 40.70029512215821), (-74.01353310205637, 40.700297124245715), (-74.01353047796475, 40.70031110034647), (-74.01356131236537, 40.70031009758511), (-74.01356034144283, 40.70036653343726), (-74.01352950889165, 40.7003735241241), (-74.0135314747603, 40.70038201618361), (-74.01356297111606, 40.70038001320642), (-74.01355970548933, 40.70043893442742), (-74.01352361756736, 40.700441937578304), (-74.013522959189, 40.70046041540698), (-74.01358070018833, 40.70045691449295), (-74.01358541798506, 40.700501912756216), (-74.01355283229525, 40.70050335816964), (-74.01357712822566, 40.70064368147604), (-74.01351039592653, 40.700650371152065), (-74.01355826959487, 40.700939870830524), (-74.01395152756511, 40.700990982459956), (-74.01409198385485, 40.70055161832716), (-74.01410490300086, 40.70051082838683), (-74.01409144949487, 40.70050833672693), (-74.01412821190823, 40.700393282054584), (-74.01413726388596, 40.7003949552103), (-74.01414860637789, 40.70032057172371), (-74.01417467279454, 40.70026089129383), (-74.01422063195506, 40.700111491868306), (-74.01430981311296, 40.7001212960687), (-74.01430981586157, 40.70013410151561), (-74.0141778793178, 40.70054147355369), (-74.01416495763293, 40.70053905203079), (-74.014152387873, 40.70057786578352), (-74.01428920741134, 40.70064414476506), (-74.01430157023242, 40.70063221177271), (-74.0142965168929, 40.70062918652366), (-74.01431530264759, 40.70061103797418), (-74.01431796468086, 40.70061249730781), (-74.01436783583223, 40.70054612266752), (-74.01444813150721, 40.700447372399935), (-74.01455999973693, 40.700309786779634), (-74.01457513332033, 40.700316916331175), (-74.01458425440427, 40.70030846895508), (-74.01458234409444, 40.70028387552854), (-74.01463294333469, 40.700197430412395), (-74.01467119992019, 40.70021040169968), (-74.01466717213708, 40.70023938090731), (-74.01465386124694, 40.700242641175116), (-74.01460863003739, 40.70030970824581), (-74.01460825448508, 40.70032365711382), (-74.01455219325999, 40.70038298075156), (-74.01449342549972, 40.70044516925058), (-74.01449246893424, 40.700454669002845), (-74.01448492126376, 40.70046115359196), (-74.01447857931358, 40.70046208215573), (-74.01440947394667, 40.70055133141232), (-74.01439689988952, 40.70056348189313), (-74.01439480693739, 40.70057047909727), (-74.01432384363015, 40.70066130412711), (-74.01464323234912, 40.70081730432509), (-74.01472424834412, 40.700714293894286), (-74.0147714243914, 40.70066365190685), (-74.01481236514054, 40.70061084993614), (-74.01485926659423, 40.70055544464556), (-74.0149303261123, 40.70047926986344), (-74.01499883053579, 40.7004061205765), (-74.01506818269304, 40.70031825755493), (-74.01509832270126, 40.70033426552343), (-74.01503579735079, 40.70042083101057), (-74.01502271060053, 40.70041953605862), (-74.01500850517257, 40.70043770992608), (-74.0149931457591, 40.700436847319814), (-74.01496757071698, 40.700465414879595), (-74.0149749555559, 40.700470177723446), (-74.01494881182721, 40.70049441360121), (-74.01494255505817, 40.700506103291325), (-74.01492322289359, 40.700515191471446), (-74.0149175465081, 40.70052557571269), (-74.01492379463954, 40.70053033870711), (-74.01493687947062, 40.70052297938124), (-74.0149419915596, 40.700523843325755), (-74.01488598965476, 40.70058011443566), (-74.0148200428468, 40.700660619780194), (-74.01472681782197, 40.700774015849625), (-74.01470265033885, 40.70079911602567), (-74.014673656285, 40.70083460953097), (-74.01481072560155, 40.70090383198211), (-74.01482834225281, 40.70089474286969), (-74.0150211366168, 40.70099250401337), (-74.01514231812101, 40.700842892354245), (-74.01567778184742, 40.70125602102743), (-74.01579351711152, 40.70134690580749), (-74.01591034233417, 40.701460948443824), (-74.01611609060481, 40.701630801625306), (-74.01613890636003, 40.70164601710269), (-74.01624449060664, 40.70175272143678), (-74.01639205370195, 40.7018977010082), (-74.01651515260784, 40.70201729867141), (-74.01653258703746, 40.70203653968305), (-74.01681859599923, 40.702338575080425), (-74.01689657041253, 40.702421879959516), (-74.01700396789508, 40.70255453562752), (-74.01713705889378, 40.702711340267676), (-74.01714508062659, 40.70270534997616), (-74.01725182133951, 40.70283555726377), (-74.01724571591129, 40.70283845773918), (-74.01725328400015, 40.70284622266265), (-74.01729346221033, 40.70288743870684), (-74.01731837763408, 40.702918871771544), (-74.01739839332281, 40.703019140804905), (-74.01744003546041, 40.70307751454187), (-74.0174938116277, 40.703154843460084), (-74.01754038297949, 40.70323616042984), (-74.01757548561503, 40.703307503056024), (-74.0175964796706, 40.70336138730904), (-74.01761681217123, 40.70342324846539), (-74.01762601904949, 40.703422761227074), (-74.01764797506856, 40.703494599879505), (-74.0176604507462, 40.70354997909756), (-74.01766881307273, 40.70359131346763), (-74.01767017368236, 40.70359951404867), (-74.01767132020267, 40.70360642738378), (-74.01768310568113, 40.70371113122529), (-74.01767264581432, 40.70371179104597), (-74.0176768962942, 40.70377050363855), (-74.0176742874819, 40.70383436757153), (-74.01766578442248, 40.703899233718545), (-74.01765792483431, 40.70393266178639), (-74.01764306532702, 40.70398897346139), (-74.01765378898196, 40.70399838081251), (-74.01765461989739, 40.70400968256976), (-74.01764390293602, 40.70402224590195), (-74.01763399890552, 40.70402475178315), (-74.01762657963027, 40.70402350082157), (-74.01757035640019, 40.70418388098656), (-74.01779454520306, 40.70423489810137), (-74.01785585682941, 40.70407884761561), (-74.01775054986868, 40.70405488289349), (-74.01779139303439, 40.703950912583586), (-74.01781758697946, 40.70393792249655), (-74.01783782825967, 40.7039626661385), (-74.01780821746956, 40.70403196447961), (-74.01791229326221, 40.704054497150985), (-74.0179426936393, 40.70397317657622), (-74.01795473982622, 40.703975785608584), (-74.01784441106724, 40.7042420399379), (-74.01844742686767, 40.70416230497785), (-74.01866784676697, 40.704435278054675), (-74.01865560578017, 40.70444100176154), (-74.0175164637148, 40.70458062465244), (-74.01748090483301, 40.70466726085783), (-74.01753170409474, 40.70467087238822), (-74.01754796252615, 40.70466365937495), (-74.0175581267377, 40.704665721926894), (-74.0175703146188, 40.704662623997955), (-74.01757369902538, 40.70466778365239), (-74.01756693013911, 40.70467138635169), (-74.01759808539704, 40.70468427263889), (-74.01763433061089, 40.70467870787103), (-74.01767570940247, 40.704680679349764), (-74.0176867022587, 40.704673791625446), (-74.017718379389, 40.70467969845154), (-74.01773325394241, 40.704671333373426), (-74.017749416039, 40.704675267937745), (-74.0177655688175, 40.70467231546035), (-74.01776687049336, 40.704664930160334), (-74.01778367349166, 40.70467083758812), (-74.01779789585477, 40.70466690269019), (-74.01780630901126, 40.704661985472484), (-74.01782893315101, 40.70466493044815), (-74.01783992611874, 40.704660996045185), (-74.01790198846368, 40.70465164811147), (-74.01791039104738, 40.704659033578714), (-74.01794142815919, 40.70465558405201), (-74.01794401937286, 40.70464820843307), (-74.01796922420502, 40.70464721810125), (-74.01797892738357, 40.704640824085274), (-74.01798926941159, 40.70464673182195), (-74.01799832152902, 40.7046496854182), (-74.01800802337449, 40.70463836559934), (-74.01802418707257, 40.704645750346394), (-74.0180429299157, 40.704628037110304), (-74.01805392410763, 40.70462950493453), (-74.01806509374255, 40.70463582599159), (-74.01811302905885, 40.704553602333725), (-74.01886289045426, 40.70471960717073), (-74.01888747947997, 40.70472914280423), (-74.01892572382414, 40.70477376257028), (-74.01934155704542, 40.706070538204024), (-74.01934254624489, 40.70609367302966), (-74.0192224228399, 40.70657308872605), (-74.01912275963412, 40.70697581433742), (-74.01910255488421, 40.707000437641476), (-74.01909155084711, 40.707004473184455), (-74.01906617140145, 40.70701377062146), (-74.01903338019704, 40.70701319087602), (-74.01895359463371, 40.70699676946549), (-74.01894579167337, 40.707017770941356), (-74.01893740557156, 40.70703420689668), (-74.01892660443805, 40.70704425778582), (-74.01890921570671, 40.70706434245125), (-74.01888462028894, 40.70708580553678), (-74.01885943006918, 40.70710041568369), (-74.01882943775034, 40.70711548664006), (-74.0187964493679, 40.707127819847564), (-74.0187610576787, 40.70713786652502), (-74.01872626987432, 40.70714335568634), (-74.01868966870477, 40.70714244375395), (-74.01865548075625, 40.707141539125075), (-74.01863058372699, 40.707139715269285), (-74.01858078403724, 40.70712374810277), (-74.01854718475342, 40.70710777026421), (-74.01857117399437, 40.70707992238862), (-74.01860717601127, 40.70709544097515), (-74.018634170231, 40.7071031988087), (-74.01864437101173, 40.70710547586043), (-74.01864796262211, 40.70708173802998), (-74.01868695379925, 40.70708400923754), (-74.01872115249107, 40.707081726149816), (-74.0187505462297, 40.7070798933099), (-74.01876194037433, 40.70707578586688), (-74.01874993323992, 40.707049762489504), (-74.01877393087639, 40.70704428278754), (-74.01879432757903, 40.70703241167231), (-74.01882011914353, 40.70701597288297), (-74.0188387043294, 40.70699496965154), (-74.01884829724433, 40.7069830904102), (-74.01884889814508, 40.70697031235022), (-74.01881110035019, 40.70696621177411), (-74.0187985148563, 40.706982188376216), (-74.0187757159848, 40.70699725864645), (-74.01874212416375, 40.70700776337878), (-74.01872292981705, 40.707006857500396), (-74.01869473190766, 40.707010967669895), (-74.01867853372204, 40.70701873300241), (-74.01864794474125, 40.70701781957841), (-74.01862814488062, 40.70701097846493), (-74.01861254498972, 40.70699728514591), (-74.01860474411275, 40.706989064177236), (-74.01860294181317, 40.7069749179781), (-74.01859153053346, 40.70695939491835), (-74.01857952850986, 40.70694981480898), (-74.01857172609171, 40.70693839792387), (-74.01856933191749, 40.706920595205716), (-74.01856452356978, 40.706906440109236), (-74.01854892759579, 40.70690827067913), (-74.0185351326967, 40.70691832201406), (-74.01853033752082, 40.70695073241038), (-74.01840649088626, 40.70725787215848), (-74.01821726389768, 40.70774220647168), (-74.01821699384479, 40.707751309768256), (-74.01819029259647, 40.707821626109904), (-74.01865557049648, 40.70792394888326), (-74.01864689079085, 40.70794681354695), (-74.01880063068425, 40.70798062163742), (-74.01883195883924, 40.70799916729172), (-74.01883395951488, 40.70800221914011), (-74.01885347760376, 40.70802201228401), (-74.01885500911968, 40.708047534447395), (-74.01874689830457, 40.708480580253614), (-74.01863142468964, 40.70894110005416), (-74.01846882134527, 40.7095895710087), (-74.01834136609801, 40.71010647694358), (-74.01826409180683, 40.710408996626796), (-74.01814480361773, 40.71088865018895), (-74.01811057789178, 40.71102962821442), (-74.01804609687574, 40.71134450148706), (-74.01797853231493, 40.711756319208064), (-74.01792224257028, 40.71203924270072), (-74.01787333422654, 40.71231514445642), (-74.01777014254505, 40.71283457478911), (-74.01775292705901, 40.712848327555946), (-74.01773183836701, 40.71284931234666), (-74.01772021563546, 40.71284473093362), (-74.01772148946128, 40.71278414511305), (-74.01780037888393, 40.712345124158524), (-74.01662424425291, 40.71215731899531), (-74.01654463812528, 40.712456037930956), (-74.01659227582778, 40.71254817107682), (-74.0166181765532, 40.71264976356907), (-74.01661840078305, 40.71275615002967), (-74.0165914952051, 40.712861563719834), (-74.01655548893456, 40.712929095504386), (-74.01654112171731, 40.71295556481935), (-74.01647724204145, 40.713029493073954), (-74.01639169485816, 40.713099997950714), (-74.01632006627581, 40.71340798247826), (-74.0165411468663, 40.71344105274237), (-74.0169106869548, 40.71349632851284), (-74.01754443334657, 40.713611222664234), (-74.01756811041483, 40.71352370347799), (-74.01757889322138, 40.71344274342793), (-74.01764810719088, 40.71320618595165), (-74.01765509447189, 40.713161062667005), (-74.01767041664053, 40.71306920796509), (-74.01767270851055, 40.71306599627471), (-74.01767565436703, 40.713063109815586), (-74.01767917626111, 40.713060624964825), (-74.01768318100177, 40.71305860747276), (-74.01768756262163, 40.713057110723156), (-74.01769220518094, 40.71305617432074), (-74.01769698583541, 40.71305582304316), (-74.01770177808669, 40.71305606618535), (-74.01770610821879, 40.71305681419654), (-74.01771024196849, 40.71305804785401), (-74.01771408584607, 40.71305973925717), (-74.01771755291763, 40.71306185015287), (-74.01772056477115, 40.713064332800705), (-74.01772305328991, 40.7130671310526), (-74.01772496219296, 40.71307018162271), (-74.01770687258349, 40.71316928296863), (-74.01761833310027, 40.7136543239355), (-74.01753721790733, 40.71409754224777), (-74.017408713605, 40.71480680040797), (-74.01738281387838, 40.71494143431504), (-74.01738223187856, 40.714944461279266), (-74.01732570958444, 40.715254913254874), (-74.01726421509521, 40.71559268236992), (-74.01712122293634, 40.71637179357976), (-74.01698274294627, 40.71713064366816), (-74.01686297377272, 40.71778695428776), (-74.01671018605823, 40.71862417605798), (-74.01669419095941, 40.718648843354394), (-74.01665946969614, 40.71866602122465), (-74.01662996338192, 40.71866536845022), (-74.01594695204274, 40.718575548906266), (-74.0159438298421, 40.7185892550442), (-74.01566883666868, 40.718554489265706), (-74.01567062060758, 40.718537748736196), (-74.01555087754507, 40.71852193318379), (-74.01500060682412, 40.718449236054994), (-74.01499619731617, 40.71847300131666), (-74.01498981339564, 40.718507347327645), (-74.01498333230722, 40.71852379143297), (-74.01497036257996, 40.718535850864264), (-74.0149451554934, 40.71854353507714), (-74.01470270021812, 40.71851615488417), (-74.01321322719193, 40.71831571989578), (-74.01306805492318, 40.7189221938255), (-74.01307237769205, 40.718938618670066), (-74.01303068126435, 40.71913145581911), (-74.01301259080442, 40.7192151175771), (-74.01295868239197, 40.71947369644304), (-74.01296083955074, 40.71948393527164), (-74.0129144874633, 40.71970829322531), (-74.01294460912565, 40.719713197540464), (-74.01294583743953, 40.71969680842205), (-74.01302616790723, 40.719709208407245), (-74.01302432551549, 40.71972559759596), (-74.01344694115663, 40.71978202079132), (-74.01338906903446, 40.72004260727321), (-74.01396546195681, 40.720116133491565), (-74.01452415856502, 40.72018739744569), (-74.01450706139613, 40.72026590617724), (-74.01457231438077, 40.72027413774222), (-74.01451968588731, 40.72051578688329), (-74.01452586453664, 40.720516569459186), (-74.01452278990018, 40.72053205032783), (-74.0141858146679, 40.72048801202075), (-74.01414732641814, 40.720481589088564), (-74.01415861254233, 40.720431590837414), (-74.01409095949836, 40.72042274785909), (-74.01407954419402, 40.72047331152238), (-74.01400416755604, 40.7204685207378), (-74.01396301313089, 40.72046444645885), (-74.0139660972248, 40.72041363453808), (-74.01386714357221, 40.720407572312546), (-74.01385921064887, 40.72044993375784), (-74.013681739107, 40.720425901487275), (-74.01368744836836, 40.72039057527115), (-74.01364192748744, 40.720383366299956), (-74.01363580332405, 40.720419550132654), (-74.01354841723072, 40.72040685437938), (-74.01355378315913, 40.72036872632457), (-74.01350724376613, 40.7203628328404), (-74.01350069470513, 40.72040186182339), (-74.01296558526825, 40.720328675587126), (-74.01286909071982, 40.72083375221177), (-74.01323937337021, 40.72088798672807), (-74.01315895020875, 40.72125326078348), (-74.01313846153454, 40.72125131813748), (-74.01308347695162, 40.72152877453265), (-74.01308010145638, 40.721545807195234), (-74.01307805009777, 40.72154553033899), (-74.0130435351385, 40.72154472392736), (-74.01300955803939, 40.72156048651211), (-74.01253875807262, 40.721503176576356), (-74.01249171031532, 40.72177975782742), (-74.01237071715393, 40.72238758057892), (-74.01223080840147, 40.72305625707263), (-74.01209463829593, 40.723707052481096), (-74.01196432049122, 40.72432986423973), (-74.01178072408688, 40.72523995904116), (-74.0116541510404, 40.72586737457331), (-74.01165326569942, 40.72587176185136), (-74.01195833074844, 40.72597759972089), (-74.01231588417473, 40.72603384328536), (-74.01411595444276, 40.72621586380551), (-74.01477821548464, 40.72628170647334), (-74.01516324118423, 40.72631971193679), (-74.01520426531143, 40.72636194937957), (-74.01518864981985, 40.726451182505), (-74.01517084019788, 40.72657939015507), (-74.01514325523303, 40.726710526279355), (-74.01512356549462, 40.72679394256454), (-74.01430671596631, 40.72670812119669), (-74.01341677520723, 40.726621031213405), (-74.01234454766033, 40.72651943048246), (-74.01154201897604, 40.726447346927074), (-74.01138323604756, 40.72822927236716), (-74.01439069932388, 40.72846304752011), (-74.01434461474166, 40.72862218378146), (-74.0142192854302, 40.7295234277555), (-74.0140774139114, 40.73064040918789), (-74.01408693559918, 40.730663173040305), (-74.01403796924798, 40.73069421884388), (-74.01401552295431, 40.73068283965607), (-74.01116195696476, 40.73045067634904), (-74.01108642940422, 40.73128902958223), (-74.01099350879153, 40.732320417940585), (-74.01094127374132, 40.73302031334128), (-74.01146083559178, 40.73302841363836), (-74.01400220214607, 40.73306800179544), (-74.01399957240966, 40.73333227751771), (-74.01090389883285, 40.733297617139556), (-74.0108984071244, 40.73335120737597), (-74.01087119573022, 40.73335261109422), (-74.01084459816052, 40.733357202680594), (-74.01081925585297, 40.73336487140261), (-74.01079577997334, 40.73337543231827), (-74.0107747366766, 40.73338863073618), (-74.01075663345338, 40.73340414835768), (-74.01074330018108, 40.73342264731271), (-74.01073424450209, 40.73344258793797), (-74.0107297241316, 40.73346340275275), (-74.01072986771706, 40.73348449939762), (-74.01073467117659, 40.73350527749216), (-74.01074399781473, 40.73352514572088), (-74.01075758221207, 40.73354353866127), (-74.01077503777829, 40.733559932875075), (-74.01079086196783, 40.733570755316805), (-74.01080865013027, 40.73357963940616), (-74.01082799567189, 40.733586382074336), (-74.0108484564005, 40.73359082920015), (-74.01086956463318, 40.733592879133), (-74.01083284563221, 40.73400709451357), (-74.01201792010474, 40.734063744456314), (-74.01200124222402, 40.73433840166875), (-74.01081359479109, 40.73428344364758), (-74.01078798331723, 40.73454829384434), (-74.0107092291038, 40.73536287214015), (-74.0106429201788, 40.73604869770487), (-74.01067724659342, 40.736056279956806), (-74.0106698675122, 40.73610193192913), (-74.01068752603769, 40.73611386772276), (-74.01070404345342, 40.73612918443088), (-74.0107170297583, 40.736146356508826), (-74.01072613231965, 40.736164917666336), (-74.01073110396318, 40.736184363893734), (-74.01073180968514, 40.736204167147676), (-74.01072823031856, 40.73622378968972), (-74.0107204630541, 40.73624269868794), (-74.0107087188013, 40.73626038068568), (-74.01069377906515, 40.73627594935929), (-74.01067576035119, 40.73628950181187), (-74.01065512584188, 40.7363006896678), (-74.01065421033896, 40.73634774524588), (-74.01061910077432, 40.73634539072178), (-74.01056810573441, 40.736972220142476), (-74.01051581576759, 40.737596064953614), (-74.0104765981442, 40.73806394059505), (-74.0110870663595, 40.73809275008128), (-74.01106791934328, 40.73830409617404), (-74.01108874586798, 40.738317524693635), (-74.01110665714008, 40.73833319830235), (-74.01112123961255, 40.73835075511965), (-74.01113215659461, 40.73836978978422), (-74.01113915602562, 40.73838986281303), (-74.01111553678652, 40.738392085638054), (-74.01109173777967, 40.7383921815097), (-74.01106808891201, 40.73839014909901), (-74.01105426715455, 40.73838794795722), (-74.01105126196637, 40.7383964257506), (-74.01045432864609, 40.738364506228145), (-74.01042867884634, 40.73870336465874), (-74.01039303134554, 40.73917429605917), (-74.01049858988299, 40.739173432770414), (-74.01055473996811, 40.739186239049005), (-74.01074676135302, 40.739175936679615), (-74.01138798406559, 40.739216056088615), (-74.01148456734629, 40.73926046259409), (-74.01158045502316, 40.73926453611201), (-74.01158818724917, 40.7392715959002), (-74.01158715816634, 40.739478870334786), (-74.01163351895192, 40.739506486066105), (-74.01162792311777, 40.73956247410615), (-74.01155518156285, 40.7395567262273), (-74.01152745020416, 40.73987377144987), (-74.01159286133141, 40.739873764884074), (-74.01161258017342, 40.73970760054936), (-74.01234819241692, 40.739737565353636), (-74.01236917400034, 40.73975164637212), (-74.01237411577738, 40.73977886786772), (-74.01234943428379, 40.73979389076181), (-74.01228649627012, 40.73979296102123), (-74.01228897847172, 40.73989904212457), (-74.01231366348769, 40.73990279375329), (-74.01234328917012, 40.73992062979225), (-74.01235687134124, 40.7399365847175), (-74.01234947552231, 40.74001637981593), (-74.01232356118135, 40.740031403003684), (-74.01227049910146, 40.74003422696505), (-74.01226310747168, 40.74014218976764), (-74.01230877290092, 40.74014781277593), (-74.0123285235642, 40.74016283157749), (-74.01232975860142, 40.74018348844802), (-74.0123100121277, 40.740194756204055), (-74.01157686924232, 40.74016009950151), (-74.01158637887602, 40.73997384795245), (-74.01151491736535, 40.739972863698775), (-74.0114607395534, 40.7405842147525), (-74.01215741913089, 40.74060599813125), (-74.01215372624051, 40.7406742566207), (-74.01265742489994, 40.74069665223178), (-74.0126592820849, 40.74074763849743), (-74.01257372996915, 40.740741731844885), (-74.01257372874744, 40.74073525812521), (-74.01147486918863, 40.74068706027103), (-74.01137438820489, 40.740723947641285), (-74.01071840609633, 40.74068559392552), (-74.00963145571754, 40.74064536737425), (-74.00949685520361, 40.74072701178546), (-74.00949154621281, 40.74074270943978), (-74.00951627358202, 40.7407735836735), (-74.00951844195933, 40.74080572291691), (-74.00950137905859, 40.74082922374576), (-74.00946293860208, 40.7409023372403), (-74.00941140266131, 40.74115409331285), (-74.0095813182218, 40.74117496028479), (-74.00957692791619, 40.74121065665437), (-74.01216232909218, 40.74149188968263), (-74.01211745872139, 40.74175851621158), (-74.00951947145009, 40.741490302198585), (-74.00944784072519, 40.74189159122016), (-74.00927792756075, 40.74187861085614), (-74.0091660821697, 40.7424165914634), (-74.009091568462, 40.74288614957493), (-74.00924013575025, 40.74289951840991), (-74.00924074160112, 40.74291316086339), (-74.00962015348921, 40.74295124889232), (-74.00956843411765, 40.74325778472638), (-74.00958464345703, 40.743263520483055), (-74.0121194002866, 40.743516612182546), (-74.01213726936176, 40.74353192705923), (-74.01214813183593, 40.74355930154751), (-74.0120900828903, 40.74389763764885), (-74.01206903486668, 40.74392249354833), (-74.01202085006399, 40.74393977020883), (-74.01197763342873, 40.74393556042097), (-74.00951201767367, 40.74367609376027), (-74.00948868364225, 40.74369568117951), (-74.00943800870873, 40.74397125597563), (-74.0093942693211, 40.743968716838175), (-74.0090420750423, 40.74393387125507), (-74.00890032962842, 40.743917927096), (-74.00880283523887, 40.744439347624194), (-74.00872780058874, 40.74485823291001), (-74.00872986359421, 40.74488153782964), (-74.00893975844275, 40.74490921733242), (-74.00957440612908, 40.74499290866279), (-74.00961227924414, 40.74499790315053), (-74.00955832929749, 40.745288825298694), (-74.00991660813456, 40.74532725500707), (-74.00993436677696, 40.74531707810183), (-74.0099379618494, 40.74529670191299), (-74.00994341816717, 40.745265769736356), (-74.00995048769146, 40.7452256903209), (-74.00995852601345, 40.74518011964658), (-74.00996759959419, 40.74512868110842), (-74.0099735068339, 40.7450951941157), (-74.00998135739343, 40.74505068238846), (-74.0099891727315, 40.745006384761986), (-74.00999822601715, 40.74495505930209), (-74.00998685784818, 40.74494416421518), (-74.00986948474728, 40.74493391770714), (-74.0098721108548, 40.74491650212574), (-74.01016790535392, 40.744942329709566), (-74.0101646519737, 40.74496392462975), (-74.01005375656217, 40.744954234929885), (-74.01003848384612, 40.74496345807816), (-74.0100236125255, 40.745046345318), (-74.01001404323709, 40.745099676615546), (-74.01000814033458, 40.745132576765585), (-74.00999930170606, 40.74518183979105), (-74.0099925052406, 40.745219719064224), (-74.00998320132659, 40.745271573088665), (-74.00997743638767, 40.74530370360894), (-74.0099739502192, 40.7453231351092), (-74.00999095380003, 40.74533668667391), (-74.01046920011868, 40.74538676602898), (-74.01048835594965, 40.74537571509467), (-74.01049187417472, 40.74535516701379), (-74.01049693441198, 40.745325615430794), (-74.01050332781192, 40.74528827090883), (-74.01051171655331, 40.745239275258314), (-74.01052083436335, 40.745186021358805), (-74.01052681665284, 40.74515108070608), (-74.01052968455846, 40.7451343325126), (-74.01055044755898, 40.74501305771002), (-74.01053188168753, 40.745002981869206), (-74.01041700660257, 40.74499358270333), (-74.01041937209395, 40.74497682467362), (-74.01076419780692, 40.74500503202078), (-74.01076156046138, 40.7450237261835), (-74.0106062154019, 40.74501101647428), (-74.01058579200931, 40.74502044656155), (-74.01056801091906, 40.74513793282639), (-74.01056370849734, 40.745166362253165), (-74.01055056928827, 40.745253182077825), (-74.01053978205329, 40.74532445541935), (-74.01053373534738, 40.74536440745699), (-74.01053106537704, 40.74538205038946), (-74.01054520392155, 40.7453921350116), (-74.01110359804885, 40.74544767024394), (-74.01111624163289, 40.74543612462544), (-74.0111246622997, 40.74537776220244), (-74.01113010029034, 40.745343228325524), (-74.01113887006922, 40.74528754863185), (-74.01114545795528, 40.74524572071854), (-74.01115627315944, 40.74517704715612), (-74.01116113418436, 40.745146176460985), (-74.01117183119825, 40.74507825828334), (-74.0111532870985, 40.74506864357284), (-74.01104281748226, 40.74506096342358), (-74.01104459150831, 40.74504621240201), (-74.01138769974182, 40.745073112682604), (-74.01138567845334, 40.74508800864403), (-74.01123038057239, 40.74507583116526), (-74.01121085294047, 40.74517080368259), (-74.0112059244744, 40.74519477063073), (-74.01118816871943, 40.74528112609168), (-74.01118102964986, 40.74531584944141), (-74.01116675082788, 40.74538529798187), (-74.0111541917691, 40.745446378083905), (-74.01116709976122, 40.745460352539965), (-74.01173958552815, 40.74551991819018), (-74.01179527645735, 40.74515466698498), (-74.01178273500803, 40.74513495663094), (-74.01166900853472, 40.745127331191384), (-74.01167067583806, 40.74511397784239), (-74.01183642872417, 40.74512596367872), (-74.01177458786383, 40.745524845918766), (-74.01177025765062, 40.745552784540145), (-74.01176635449525, 40.74557798004347), (-74.0117827582809, 40.7456015722554), (-74.01171897530912, 40.745939844997764), (-74.01171123496545, 40.745961259151706), (-74.01167885505596, 40.745979461815956), (-74.01163451251723, 40.74597839430354), (-74.01055524902252, 40.745871104925456), (-74.01055133475727, 40.745902883999676), (-74.01012821388646, 40.74585723892899), (-74.01012821162075, 40.745842335463045), (-74.00994668462282, 40.745819514445614), (-74.0099480791384, 40.74580017091194), (-74.00946389855972, 40.74575014365943), (-74.00945236676588, 40.74581747389088), (-74.00944165126164, 40.745880035252725), (-74.00943562211822, 40.74591524271849), (-74.00942443646915, 40.74598054836305), (-74.00941900727406, 40.746012247277136), (-74.00940745668308, 40.74607969611165), (-74.009401558017, 40.74611413662903), (-74.00939067734767, 40.74617765591175), (-74.00938523645611, 40.746209426860574), (-74.00938042260216, 40.74623753731057), (-74.00937637598555, 40.74626116385924), (-74.0093636273423, 40.74633560197722), (-74.01153382764763, 40.746567754712274), (-74.011567829226, 40.74657945216891), (-74.01159123434022, 40.74660150547595), (-74.01158846879171, 40.74662807440217), (-74.01153307246702, 40.74696682694798), (-74.01151183018266, 40.746984604103034), (-74.01148373087554, 40.74699058876526), (-74.01144491250467, 40.746986285028434), (-74.00924314658675, 40.74676279075371), (-74.00913736259926, 40.74735976280298), (-74.00956047962374, 40.74740279960452), (-74.00956103476231, 40.74738773359521), (-74.00956765300357, 40.74738787745319), (-74.00956826626557, 40.74737108340657), (-74.00955039867242, 40.747370706112825), (-74.00955155415365, 40.74733934176788), (-74.00996384996873, 40.74737780301252), (-74.00995838445456, 40.74741167208282), (-74.00990669970037, 40.7474068496084), (-74.00990158912964, 40.7474384843489), (-74.01135675337726, 40.74759241834679), (-74.01139477623487, 40.74761090210864), (-74.01140673935527, 40.747630550570626), (-74.01134693158467, 40.74797620549259), (-74.01133174441692, 40.74800057534196), (-74.0113035299375, 40.74801457190888), (-74.01126611253964, 40.74801371918114), (-74.00905847901343, 40.74778564533281), (-74.00894606502322, 40.74841189316871), (-74.00897918405973, 40.748412709626926), (-74.00897918237624, 40.74840021938044), (-74.00907100927556, 40.74840976720638), (-74.00907390770351, 40.74839506170082), (-74.00941511636567, 40.748429586917254), (-74.00941607672534, 40.74843693503791), (-74.00952336741516, 40.748447956808235), (-74.0095188236012, 40.74847354043593), (-74.01116687561544, 40.74864504676615), (-74.01119472751151, 40.748656814113886), (-74.01121561813416, 40.74867799224354), (-74.01121562130412, 40.748696821175805), (-74.01114914281891, 40.74902574726487), (-74.01113289942985, 40.749041633831), (-74.01110891182995, 40.74904987642216), (-74.01107797059215, 40.74905164311724), (-74.0099481793803, 40.74893198800567), (-74.00956004978678, 40.74993504179153), (-74.00972257401416, 40.749972029008546), (-74.00972771074943, 40.74996378830078), (-74.01006544547259, 40.75006803825169), (-74.01050182205226, 40.75020981164461), (-74.01075118603512, 40.750293977204855), (-74.01080815800904, 40.75031931136798), (-74.01075658033929, 40.7504108529575), (-74.01069531261541, 40.750394514816875), (-74.01048679093358, 40.750326688769135), (-74.00968282368932, 40.75006275779384), (-74.0096935026082, 40.750043936175594), (-74.00954248045576, 40.750000949023345), (-74.00951808686516, 40.75010700478141), (-74.0094700192251, 40.75008116415654), (-74.00947559600833, 40.75007515771959), (-74.00925340917924, 40.74998520622449), (-74.0091189664493, 40.75033244243163), (-74.00900098259454, 40.75064818378257), (-74.00870618650585, 40.75142680500331), (-74.00873137829981, 40.75146589496972), (-74.0086672907182, 40.751628197220754), (-74.00862089839437, 40.75165257792247), (-74.00853256925024, 40.75188360930431), (-74.00876004993515, 40.75194801470967), (-74.00914082120002, 40.752097594099034), (-74.00912661123245, 40.7521168957349), (-74.00874567715042, 40.751964395327015), (-74.00865115936804, 40.75193951211305), (-74.0086431823763, 40.75195650203193), (-74.00896912527918, 40.75207679147874), (-74.00895742294804, 40.75209022513094), (-74.00903895969977, 40.75212515615244), (-74.00904909796247, 40.75211834944301), (-74.00910757975159, 40.75213971211182), (-74.00910596820009, 40.752142124949444), (-74.00905774009662, 40.752214351243175), (-74.00899734911651, 40.75218910594712), (-74.00900762808337, 40.75217684273936), (-74.00892887650475, 40.75214400187017), (-74.00891472422606, 40.752163628475834), (-74.00867223768388, 40.75206225000071), (-74.00859053101699, 40.75202810543436), (-74.00858095760466, 40.7520438824116), (-74.00866456561988, 40.75207286737424), (-74.0093408924528, 40.75235560954554), (-74.00932795206229, 40.752373503046144), (-74.008478955728, 40.75201857191988), (-74.00842636447226, 40.75215785023924), (-74.00881779819426, 40.752324345854184), (-74.00880273703076, 40.75234485403722), (-74.0088394166214, 40.752358816534674), (-74.00885173565307, 40.75234228177294), (-74.00986566961524, 40.75276341313924), (-74.00984627922618, 40.752785441959404), (-74.0098892261995, 40.75280368052555), (-74.00990631519599, 40.75278041119834), (-74.0099905581975, 40.75281618714907), (-74.00992010631799, 40.75291212601697), (-74.00997058797022, 40.752933564153146), (-74.00991916275493, 40.75300359145921), (-74.00978913116427, 40.75294837008768), (-74.00988774868318, 40.752814077653284), (-74.00983854674402, 40.75279496798307), (-74.00983056913984, 40.752803464244565), (-74.00882994505393, 40.75238001600714), (-74.00883632714998, 40.752371521109524), (-74.00879210090847, 40.7523521383795), (-74.00868792219572, 40.75249399862839), (-74.00835352838843, 40.75235073934231), (-74.00801152240538, 40.75325645261208), (-74.00790245613038, 40.75354261201443), (-74.00773872468986, 40.753972157818566), (-74.00761949611858, 40.75428184227666), (-74.0077440483022, 40.754336802434274), (-74.00759618989146, 40.75453055073416), (-74.00747157990926, 40.75447702042384), (-74.00729394650313, 40.75472318445086), (-74.00728499944323, 40.75473556820313), (-74.00741362036906, 40.75478930266942), (-74.00727181174769, 40.75498559453522), (-74.00714468360972, 40.75493248117341), (-74.00695917416678, 40.75518079484938), (-74.00680635763683, 40.755391775640305), (-74.00670291840636, 40.75553236749094), (-74.00657767658517, 40.755706871433944), (-74.00620548925971, 40.75622084397098), (-74.00610422181599, 40.75636052012318), (-74.00596691029229, 40.75655814293544), (-74.00592383847429, 40.75662023563421), (-74.00580938168251, 40.75678934198094), (-74.00541885841011, 40.757323140851746), (-74.00521187705773, 40.7572319985399), (-74.00480392560185, 40.757809843164694), (-74.00496777078658, 40.757884164447944), (-74.00527894797891, 40.75802855492825), (-74.0050310513664, 40.75835701647313), (-74.0069642874931, 40.7591600575616), (-74.00699375268466, 40.75917614764263), (-74.00701038304962, 40.759203720386644), (-74.00700358904015, 40.75923187034106), (-74.00652959987842, 40.7598747512412), (-74.00650687640183, 40.75989203231718), (-74.00647588371956, 40.75989360126801), (-74.00644352901314, 40.75989046096714), (-74.00631515935251, 40.75984282204463), (-74.00450483093914, 40.759084996552694), (-74.00420629125391, 40.75950170768838), (-74.00390742032769, 40.75937569218349), (-74.00380657835007, 40.75951073146599), (-74.0040798895684, 40.759626044742724), (-74.00424697128062, 40.75969921417139), (-74.0042024743225, 40.759761071881755), (-74.00414863814689, 40.759835914170765), (-74.00424487588262, 40.75988657316657), (-74.00425967856717, 40.759875307678534), (-74.00431889425076, 40.75991068576342), (-74.00426869650668, 40.759959279013316), (-74.00421059345653, 40.75992456661), (-74.00422266067, 40.75991310304364), (-74.00413171622799, 40.75986164239601), (-74.00411162007795, 40.7598930073072), (-74.00366891453541, 40.75970596957658), (-74.00357251040076, 40.75984655897313), (-74.00392854933564, 40.760003019720415), (-74.003825595952, 40.76013313666682), (-74.003588009112, 40.760451706951265), (-74.0033848822989, 40.76072887070633), (-74.00313338991401, 40.761078345096294), (-74.00278691552613, 40.76092896970333), (-74.00233528130057, 40.761543727001616), (-74.00454520983433, 40.762492801944816), (-74.00455814361389, 40.76250787607533), (-74.00455641560922, 40.76252426502506), (-74.00444951527277, 40.762664567199984), (-74.00442709659245, 40.76267570735635), (-74.00439976203518, 40.76267135909881), (-74.0022008207327, 40.76172843222647), (-74.00178824022315, 40.76229452064422), (-74.00153309066981, 40.76264459812759), (-74.00375735037694, 40.76358224164056), (-74.00361214794175, 40.76377704390972), (-74.001386036986, 40.76285009500188), (-74.00097308022016, 40.76342027172565), (-74.00314976988992, 40.76433288818462), (-74.00294809515725, 40.76461683643389), (-74.00306161234066, 40.76466578265342), (-74.00313458336224, 40.764649598206695), (-74.00316194577044, 40.76461261045461), (-74.00322275585363, 40.76463803767021), (-74.00315587058185, 40.76473050987994), (-74.00314652967366, 40.7647362813918), (-74.00313606019988, 40.76474079644628), (-74.00312475155107, 40.76474393024101), (-74.00311291631387, 40.76474559615357), (-74.00310088163069, 40.76474574813583), (-74.0030889801569, 40.764744381986766), (-74.00106364220511, 40.76388820826286), (-74.00073105253733, 40.7637552863614), (-73.99992712367728, 40.76340652847935), (-73.99963853555371, 40.76356907099079), (-73.99962263458187, 40.76355908121045), (-73.99951767096823, 40.763706279180276), (-73.99944642217315, 40.76380619457846), (-73.99943330724619, 40.763823910196976), (-73.99915098087908, 40.764205259582695), (-74.00227436642373, 40.765525181099555), (-74.00228802371483, 40.765561544297775), (-74.00205713831564, 40.76587739041861), (-74.00202454330335, 40.76589326657038), (-73.99919997246741, 40.764701914982496), (-73.99910832564545, 40.76466249985752), (-73.99888473174988, 40.764569377048495), (-73.99857638530538, 40.76499860727076), (-73.99859978707626, 40.76507334028592), (-73.99863487876344, 40.765085794737736), (-73.9986653047344, 40.76510448074717), (-73.99868637477219, 40.765137394267754), (-73.998695730373, 40.76517476567955), (-73.99868870694561, 40.76520857044983), (-73.99866764711378, 40.765237035342906), (-73.99863371556073, 40.76526016874122), (-73.99858924105146, 40.7652761788068), (-73.99848276468684, 40.76529753698438), (-73.99843830371466, 40.76531621383388), (-73.99840202518251, 40.76535090908753), (-73.99835829733873, 40.765418049266316), (-73.99829119846427, 40.76552107326132), (-73.9982709030835, 40.76555223341325), (-73.99828160709528, 40.765567775437326), (-74.00154217871203, 40.76694470253266), (-74.00157335385268, 40.766977192210696), (-74.0015618057548, 40.766996499368275), (-74.00139437159497, 40.76723004773301), (-74.0013643461298, 40.76724936447365), (-74.00131469636004, 40.76725112004994), (-74.00129391014994, 40.767241458241585), (-73.9981567843898, 40.76589403537408), (-73.99814818647367, 40.76590560707495), (-73.99806675905354, 40.76587188113568), (-73.99772134825697, 40.766349120555766), (-73.99737808447964, 40.766823386379535), (-74.00062837395305, 40.768203111058696), (-74.000650167862, 40.768220374289214), (-74.00064950530418, 40.768245236105564), (-74.00045489336716, 40.76850419517743), (-74.00041765393195, 40.768512479964414), (-74.00038586489076, 40.768504195429294), (-73.99715588949212, 40.76712869617279), (-73.99681598463503, 40.767600621859145), (-73.9964571540504, 40.768098815795625), (-73.999728191901, 40.76947350663368), (-73.99973590247853, 40.76950617733153), (-73.99955518930786, 40.769750807740046), (-73.99951552161613, 40.76976756583779), (-73.99947253734024, 40.76976421496914), (-73.99707176039311, 40.76873264357685), (-73.99702628821073, 40.76879551562383), (-73.99715035477146, 40.7688473877134), (-73.99701071413826, 40.76902879065363), (-73.9968931131237, 40.76897962881943), (-73.99657126439577, 40.769424568273834), (-73.99902682832902, 40.77046327298206), (-73.99876206914315, 40.770825056709214), (-73.99631327022085, 40.76979883633641), (-73.99588004351688, 40.77040057901225), (-73.99601693196199, 40.77045484888618), (-73.99590077425034, 40.77061312350094), (-73.99576733283615, 40.770554596456435), (-73.99542474436302, 40.77103161516796), (-73.99575648212901, 40.77116066846579), (-73.9957085906995, 40.771225812532926), (-73.99579774020454, 40.77128256276406), (-73.99581687579044, 40.77125651641555), (-73.99591283603844, 40.77129785562376), (-73.99592803670673, 40.77127510283763), (-73.99600175749052, 40.77130746533056), (-73.99589990100937, 40.771450298582096), (-73.99589260894884, 40.77144708752719), (-73.99585437252811, 40.77149918074846), (-73.99579117748779, 40.7714755188204), (-73.99582805886243, 40.77142166722239), (-73.99572993314408, 40.77137881879372), (-73.99575123412824, 40.77135428277978), (-73.99562982240307, 40.771325292628056), (-73.99562306904366, 40.771336957512865), (-73.99530566365357, 40.77119600490949), (-73.99512395556886, 40.77145073826707), (-73.99499014482076, 40.77144070980649), (-73.99495733353699, 40.771449190697695), (-73.99493501659005, 40.77146814657798), (-73.99492385794417, 40.77148560593747), (-73.99492582120637, 40.77151604240548), (-73.99500915438725, 40.77160733994413), (-73.99497830771196, 40.77164524947328), (-73.9949768849473, 40.77165877492332), (-73.99711218538609, 40.77255323669952), (-73.99690946902788, 40.77283294565996), (-73.99477407930823, 40.77192954753019), (-73.99444501293384, 40.772377126588324), (-73.9954551499559, 40.772802675029084), (-73.99554492520852, 40.77267481382618), (-73.99644894667634, 40.77305684199672), (-73.99635558854986, 40.77317889215508), (-73.99622972001936, 40.77312897504531), (-73.99614329133081, 40.77324754156346), (-73.99656159477647, 40.773410941951006), (-73.99668544431167, 40.77350368804627), (-73.9966770578474, 40.773510053942175), (-73.99434191991621, 40.772524781943424), (-73.99424979228651, 40.7725264851381), (-73.994163284563, 40.772487191523865), (-73.99383108203092, 40.772931787850645), (-73.9938875450246, 40.77295574416387), (-73.99389125243704, 40.772955194876715), (-73.99396258551457, 40.77294465390892), (-73.99401262480508, 40.7728828466319), (-73.9941220580824, 40.77292405902602), (-73.99413665258861, 40.77290187017425), (-73.99430134239114, 40.77297002866392), (-73.99428153513443, 40.772993802069315), (-73.99437655275096, 40.77303955110136), (-73.99431863468713, 40.77312144027021), (-73.99429402982382, 40.77315624399181), (-73.99502327586075, 40.77348119657617), (-73.99507108796963, 40.773414138665814), (-73.99508939189286, 40.77338847503913), (-73.99501396371674, 40.77335803542693), (-73.99505028469918, 40.77329715318985), (-73.9962406518988, 40.77378979139767), (-73.99619583747098, 40.77385235618407), (-73.99610846880843, 40.77381631601507), (-73.99610778142996, 40.77381737760107), (-73.99606316808179, 40.773886886610065), (-73.99612697773726, 40.773913354620824), (-73.99612850482784, 40.77391398490313), (-73.99612636140223, 40.773916713654195), (-73.99609880736975, 40.77395180529909), (-73.99611835102779, 40.773960323961354), (-73.99617945997379, 40.77398695435152), (-73.99609524522621, 40.77408618643762), (-73.99605125275335, 40.774068895803204), (-73.99557226516114, 40.773870731394275), (-73.9939369418221, 40.77317951096689), (-73.99386295329136, 40.77326952957484), (-73.99382334505351, 40.773381766882665), (-73.99376791399207, 40.77348399450776), (-73.99369930927799, 40.773562152658094), (-73.99362279521324, 40.77363229021237), (-73.99352782764133, 40.77371444646857), (-73.99344341917192, 40.77377055018086), (-73.99341175671518, 40.77380261242391), (-73.99335894150748, 40.77392688015463), (-73.99262266386542, 40.774974056036925), (-73.9925778427661, 40.77495601635938), (-73.99252774395154, 40.775002110439836), (-73.99246974581534, 40.77502415955178), (-73.99240383719187, 40.775018140390664), (-73.99226708903541, 40.77511603385854), (-73.99205908493715, 40.77549759819226), (-73.99212537239492, 40.77550907505336), (-73.99222686779699, 40.77548221102612), (-73.9923293466088, 40.77546890095852), (-73.99236175680113, 40.77550189976663), (-73.99238604296028, 40.775557180424634), (-73.99208768471269, 40.775983970821365), (-73.99201877991071, 40.776073340735394), (-73.99142953190217, 40.77687956054528), (-73.99092717414969, 40.77756687876296), (-73.99073041339479, 40.77756055024255), (-73.99039616003651, 40.777585065679055), (-73.99010126597662, 40.777996457516615), (-73.9896488729282, 40.77862756000899), (-73.9892009588643, 40.779252398651565), (-73.98920068089922, 40.77925278678181), (-73.98917577843804, 40.77928752401577), (-73.9890851947859, 40.779407597662015), (-73.98886861740003, 40.779692922911416), (-73.98887187449976, 40.77971373825301), (-73.98921902288056, 40.77969789520939), (-73.98927785904425, 40.77972343927106), (-73.98940905418013, 40.77973770647197), (-73.98949861492703, 40.779725044389764), (-73.98959649338822, 40.77969814668337), (-73.9896798129025, 40.77967756865803), (-73.98975270293793, 40.77967124421157), (-73.9898422478065, 40.779680752670664), (-73.9899443022714, 40.779696593271176), (-73.99004010212047, 40.77970767769822), (-73.99013797752482, 40.779699769704784), (-73.99022336845648, 40.779682361211215), (-73.99033584033221, 40.779661794395), (-73.99043059869703, 40.779664973055496), (-73.99050764615505, 40.779668139123864), (-73.99062219939671, 40.77967606491433), (-73.99074506950548, 40.77967132818406), (-73.99087211428218, 40.7796460076439), (-73.99096167222436, 40.77963968375177), (-73.99105747282952, 40.77965235262575), (-73.99115742949704, 40.77966977560645), (-73.99124281740445, 40.77967136708451), (-73.99125531828973, 40.77965078251649), (-73.99129488712012, 40.77963020920888), (-73.99132196764988, 40.779631796041386), (-73.99135945556941, 40.7795858833374), (-73.99155105922739, 40.77957482143735), (-73.99141982585964, 40.779755280287034), (-73.98888614411696, 40.77987889853273), (-73.98893965670626, 40.77995617844041), (-73.98892610353083, 40.78005929201363), (-73.98891168026469, 40.780096037146635), (-73.9889116606736, 40.7801223667702), (-73.98891926146842, 40.780226094343675), (-73.98838105020263, 40.78098107404582), (-73.98823241384697, 40.781233144215555), (-73.98821042083165, 40.78122548254207), (-73.98814418135409, 40.781365671327194), (-73.98813788174478, 40.78137928127401), (-73.98812746168677, 40.78140179744746), (-73.98804128806715, 40.781585961353784), (-73.98810029382462, 40.781602878305286), (-73.98807644914505, 40.781650935001615), (-73.98801805997222, 40.78163418881045), (-73.98796079284213, 40.781770987031535), (-73.98791968459248, 40.78183347771323), (-73.9878772872501, 40.78189205133476), (-73.98647480368594, 40.78391657371871), (-73.98625187003545, 40.78423876424542), (-73.98611372725286, 40.78443891237993), (-73.98561580396368, 40.78514186259504), (-73.98546581197026, 40.78536070057545), (-73.98617270496545, 40.78606845225869), (-73.98645586240198, 40.7859192190814), (-73.98707234561559, 40.78518963882012), (-73.98711901394256, 40.7852103190041), (-73.98649778102359, 40.78595120288726), (-73.98616462880626, 40.786121882448334), (-73.98612842248589, 40.78623900133113), (-73.98607113521973, 40.7862407060266), (-73.98602727478912, 40.78622896423673), (-73.98609763784941, 40.78605822569795), (-73.98542932126942, 40.78541394218464), (-73.98508113773205, 40.78592193511045), (-73.98519883325449, 40.78596655219777), (-73.98517050238989, 40.78601333415815), (-73.98521621867364, 40.786030501816406), (-73.98525509797992, 40.78597620551158), (-73.98524273937646, 40.785972572653336), (-73.98524962933016, 40.78596313985584), (-73.98528177918674, 40.78597862095007), (-73.98524003288452, 40.78603585813679), (-73.98568388524217, 40.786222123919686), (-73.98571752900456, 40.786175994668795), (-73.98576566029752, 40.78619627485863), (-73.98568287192252, 40.78630978621315), (-73.98563627093043, 40.78629015064927), (-73.98567072256466, 40.78624291199381), (-73.98561523764435, 40.78621964571528), (-73.98520511880037, 40.78604766921279), (-73.98521103560748, 40.78603955488367), (-73.98516263994699, 40.786020999769754), (-73.98513163631205, 40.786060297019986), (-73.98501696406495, 40.78601423719566), (-73.98493597820354, 40.78613072065099), (-73.98465507883023, 40.786534741807955), (-73.98574378790103, 40.78657008285474), (-73.98589227228327, 40.78642652901957), (-73.98594285499497, 40.786452847880334), (-73.98594956155658, 40.786487113966515), (-73.98581237352651, 40.7866168653571), (-73.98513520970316, 40.78658761889549), (-73.9846194285841, 40.78658601634983), (-73.98369521623653, 40.78791528181529), (-73.98234664147552, 40.78985478127522), (-73.98188645946534, 40.790516580935105), (-73.98139174468552, 40.79122824600514), (-73.98128937370952, 40.79137550943303), (-73.98094708354064, 40.7918678937825), (-73.980537679464, 40.79245681262499), (-73.98043434256005, 40.79259428309674), (-73.98013222578663, 40.79299376538316), (-73.98004684398002, 40.793113525163925), (-73.9792882208298, 40.79417763216333), (-73.97828949152739, 40.795586760963445), (-73.97779475503206, 40.79628462977193), (-73.97685207845194, 40.79763134839319), (-73.97639951930557, 40.79827321069251), (-73.97628527884254, 40.79843523541007), (-73.97583055785236, 40.79909228091325), (-73.97578169321191, 40.7991562567803), (-73.97579140130196, 40.79920962788621), (-73.97576219486481, 40.79926017354929), (-73.97554385822019, 40.799528250637344), (-73.97526783234454, 40.799932849531714), (-73.97508668067891, 40.800189533633), (-73.97496436808184, 40.8003696341939), (-73.97483924436003, 40.80055824326267), (-73.97466556722725, 40.80081351473416), (-73.97448722520987, 40.80105742889681), (-73.97414361823468, 40.80151689534116), (-73.9739409836669, 40.80180902586399), (-73.97389989052462, 40.801889863531194), (-73.9737747724601, 40.80204584594857), (-73.97372060455763, 40.802167815280235), (-73.97361322463884, 40.80229686038974), (-73.9735422772157, 40.8023564112503), (-73.97336671067802, 40.80263011334648), (-73.97320518045738, 40.80283005827629), (-73.97312859120993, 40.80297471550865), (-73.97307070537943, 40.8030555484474), (-73.97303522902074, 40.80307397374192), (-73.97292317001968, 40.80324982284385), (-73.97286807262154, 40.803320734176026), (-73.97287179081499, 40.80335618814787), (-73.97255429829629, 40.80379863465013), (-73.97217237241797, 40.80431907695906), (-73.97205095521868, 40.804530376010035), (-73.97195292438525, 40.804619709051586), (-73.97181849483543, 40.80471754320449), (-73.97179980150743, 40.80478561548601), (-73.97171200727094, 40.80493169127652), (-73.97162049569336, 40.80504229439937), (-73.9716111339144, 40.80509618747434), (-73.97144210961521, 40.80533442683979), (-73.9712908330033, 40.80552870753323), (-73.97110765852283, 40.80579014017928), (-73.9705024625186, 40.806608946391925), (-73.96815049159666, 40.80570445064486), (-73.96802983890039, 40.80566329162532), (-73.96797426555128, 40.80563549009033), (-73.96793566161884, 40.805585769333426), (-73.9679390929974, 40.805515065744004), (-73.96798490561439, 40.80543716518537), (-73.96812332647931, 40.8052058218404), (-73.96821034195167, 40.80504504389083), (-73.96821875634738, 40.8049181393645), (-73.96821742633949, 40.80485471504385), (-73.96818773181758, 40.804785306302065), (-73.96805938605621, 40.804716848163615), (-73.96109562266466, 40.80177529451055)])

    base_info = None

    driver_information = None


class EDI270():

    def __init__(self, file):

        if isinstance(file, pd.DataFrame):     #if input is pandas dataframe type, use it directly or read from csv or excel
            self.df = file
        else:
            self.df = pd.read_csv(file, dtype=object) if file[-1] == 'v' else pd.read_excel(file, dtype=object)

        try:
            self.df['SVC DATE'] = self.df['SVC DATE'].apply(lambda x: datetime.strptime(str(x), "%Y-%m-%d %H:%M:%S").strftime("%Y%m%d"))
        except:
            self.df['SVC DATE'] = self.df['SVC DATE'].apply(
                lambda x: datetime.strptime(str(x), "%m/%d/%Y").strftime("%Y%m%d"))

        try:
            self.df['DOB'] = self.df['DOB'].apply(lambda x: datetime.strptime(str(x), "%Y-%m-%d %H:%M:%S").strftime("%Y%m%d"))
        except:
            self.df['DOB'] = self.df['DOB'].apply(
                lambda x: datetime.strptime(str(x), "%m/%d/%Y").strftime("%Y%m%d"))

        self.transaction_num = self.df.__len__()   # the number of trips in data
        self.st_se_fixed_lines = 13   # fixed number of lines between ST and SE(each section)

        self.date_format1 = datetime.today().date().strftime("%y%m%d")  # used in ISA
        self.date_format2 = datetime.today().date().strftime("%Y%m%d")
        self.time_format = datetime.now().time().strftime("%H%M%S")
        self.interchange_ctrl_number = "0" + str(self.date_format1) + str(self.time_format[2:4])

        self.version_code = info_locker.version_code['270']
        self.submitter_info = info_locker.base_info
        self.receiver_info = info_locker.NYSDOH

        self.file_name = '270-' + self.date_format2 + self.time_format + ".txt"

    def ISA(self, prod=True):
        if prod==False:    # PTE mode

            ISA = ["ISA", "00", " "*10, "00", " "*10, "ZZ", '{:<15s}'.format(self.submitter_info['ETIN']),
                    "ZZ", '{:<15s}'.format(self.receiver_info['ETIN']), str(self.date_format1),
                    str(self.time_format[:-2]), '^', '00501', self.interchange_ctrl_number, '0', 'T', ':~']

        else:     # production mode

            ISA = ["ISA", "00", " "*10, "00", " "*10, "ZZ", '{:<15s}'.format(self.submitter_info['ETIN']),
                    "ZZ", '{:<15s}'.format(self.receiver_info['ETIN']), str(self.date_format1),
                    str(self.time_format[:-2]), '^', '00501', self.interchange_ctrl_number, '1', 'P', ':~']

        return '*'.join(ISA)

    def GS(self):
        GS = ["GS", "HS", self.submitter_info['ETIN'], self.receiver_info['ETIN'], self.date_format2,
              self.time_format[:-2], "1", "X", self.version_code]

        return '*'.join(GS) + "~"

    def transaction_header(self, iterations, invoice_number):
        ST = ["ST", "270", str('{:>04d}'.format(iterations)), self.version_code]
        BHT = ["BHT", "0022", "13", str(invoice_number).strip(), self.date_format2, self.time_format[:-2]]

        return '*'.join(ST) + "~" + '*'.join(BHT) + "~"

    def first_HL(self):
        HL = ["HL", "1", "", "20", "1"]
        NM1 = ["NM1", "PR", "2", self.receiver_info['name'], "", "", "", "", "FI", self.receiver_info['id']]

        return "*".join(HL) + "~" + "*".join(NM1) + "~"

    def second_HL(self, service_name, service_npi):
        HL = ["HL", "2", "1", "21", "1"]
        NM1 = ["NM1", "1P", "2", service_name.strip().replace(",", ""), "", "", "", "", "XX", str(service_npi).strip()]
        REF = ["REF", "EO", self.submitter_info['MedicaidProviderNum']]

        return "*".join(HL) + "~" + "*".join(NM1) + "~" + "*".join(REF) + "~"

    def third_HL(self, patient_lastname, patient_firstname, medicaid_number, dob, gender, service_date):
        HL = ["HL", "3", "2", "22", "0"]
        NM1 = ["NM1", "IL", "1", patient_lastname.strip().upper(), patient_firstname.strip().upper(), "", "", "", "MI", medicaid_number.strip().upper()]
        DMG = ["DMG", "D8", str(dob), gender.upper()]
        DTP = ["DTP", "291", "D8", str(service_date)]
        EQ = ["EQ", "30"]

        return "*".join(HL) + "~" + "*".join(NM1) + "~" + "*".join(DMG) + "~" + "*".join(DTP) + "~" + "*".join(EQ) + "~"

    def transaction_trailer(self, iterations):
        SE = ["SE", "13", str('{:>04d}'.format(iterations))]
        return '*'.join(SE) + "~"

    def GE(self, count_ST):
        GE = ["GE", str(count_ST), "1"]

        return '*'.join(GE) + "~"

    def IEA(self):
        IEA = ["IEA", "1", self.interchange_ctrl_number]

        return "*".join(IEA) + "~"

    def ST_SE_loop(self):

        result = []
        for row in range(self.transaction_num):
            df_row = self.df.ix[[row]]
            ST = self.transaction_header(iterations=row+1, invoice_number=df_row['INVOICE NUMBER'].values[0])
            first_HL = self.first_HL()
            second_HL = self.second_HL(service_name=df_row['SVC NAME'].values[0], service_npi=df_row['SVC NPI'].values[0])
            third_HL = self.third_HL(patient_lastname=df_row['CLIENT LAST NAME'].values[0], patient_firstname=df_row['CLIENT FIRST NAME'].values[0],
                                     medicaid_number=df_row['MEDICAID ID NUMBER'].values[0], dob=df_row['DOB'].values[0],
                                     gender=df_row['GENDER'].values[0], service_date=df_row['SVC DATE'].values[0])
            SE = self.transaction_trailer(iterations=row+1)

            merged_loop = ST + first_HL + second_HL + third_HL + SE
            result.append(merged_loop)

        return "".join(result)

    def ISA_IEA(self):
        ISA = self.ISA()
        GS = self.GS()
        ST_SE = self.ST_SE_loop()
        GE = self.GE(self.transaction_num)
        IEA = self.IEA()

        return ISA + GS + ST_SE + GE + IEA


class EDI276():

    def __init__(self, file):
        if isinstance(file, pd.DataFrame):
            self.df = file
        else:
            self.df = pd.read_csv(file) if file[-1] == 'v' else pd.read_excel(file)

        # print(self.df)
        # try:
        #     self.df['SVC DATE'] = self.df['SVC DATE'].apply(lambda x: datetime.strptime(str(x), "%Y%m%d").strftime("%Y%m%d"))
        # except:
        #     self.df['SVC DATE'] = self.df['SVC DATE'].apply(
        #         lambda x: datetime.strptime(str(x), "%m/%d/%Y").strftime("%Y%m%d"))
        #
        # try:
        #     self.df['DOB'] = self.df['DOB'].apply(lambda x: datetime.strptime(str(x), "%Y%m%d").strftime("%Y%m%d"))
        # except:
        #     self.df['DOB'] = self.df['DOB'].apply(
        #         lambda x: datetime.strptime(str(x), "%m/%d/%Y").strftime("%Y%m%d"))

        self.transaction_num = self.df.__len__()
        self.st_se_fixed_lines = 15

        self.date_format1 = datetime.today().date().strftime("%y%m%d")  # used in ISA
        self.date_format2 = datetime.today().date().strftime("%Y%m%d")
        self.time_format = datetime.now().time().strftime("%H%M")
        self.interchange_ctrl_number = "0" + str(self.date_format1) + str(self.time_format[2:])

        self.version_code = info_locker.version_code['276']
        self.submitter_info = info_locker.base_info
        self.bill_provider = info_locker.base_info
        self.receiver_info = info_locker.NYSDOH

        self.file_name = '276-' + self.date_format2 + self.time_format + ".txt"

    def ISA(self, prod=True):
        if prod==False:

            ISA = ["ISA", "00", " "*10, "00", " "*10, "ZZ", '{:<15s}'.format(self.submitter_info['ETIN']),
                    "ZZ", '{:<15s}'.format(self.receiver_info['ETIN']), str(self.date_format1),
                    str(self.time_format), '^', '00501', self.interchange_ctrl_number, '0', 'T', ':~']

        else:

            ISA = ["ISA", "00", " "*10, "00", " "*10, "ZZ", '{:<15s}'.format(self.submitter_info['ETIN']),
                    "ZZ", '{:<15s}'.format(self.receiver_info['ETIN']), str(self.date_format1),
                    str(self.time_format), '^', '00501', self.interchange_ctrl_number, '1', 'P', ':~']

        return '*'.join(ISA)

    def GS(self):
        GS = ["GS", "HR", self.submitter_info['ETIN'], self.receiver_info['ETIN'], self.date_format2,
              self.time_format, "1", "X", self.version_code]

        return '*'.join(GS) + "~"

    def transaction_header(self, iterations, invoice_number):
        ST = ["ST", "276", str('{:>04d}'.format(iterations)), self.version_code]
        BHT = ["BHT", "0010", "13", str(invoice_number).strip(), self.date_format2, self.time_format]

        return '*'.join(ST) + "~" + '*'.join(BHT) + "~"

    def first_HL(self): # payer info
        HL = ["HL", "1", "", "20", "1"]
        NM1 = ["NM1", "PR", "2", self.receiver_info['name'], "", "", "", "", "PI", self.receiver_info['id']]

        return "*".join(HL) + "~" + "*".join(NM1) + "~"

    def second_HL(self): # submitter info
        HL = ["HL", "2", "1", "21", "1"]
        NM1 = ['NM1', '41', '2', self.submitter_info['BaseName'], '', '', '', '', '46', self.submitter_info['ETIN']]

        return "*".join(HL) + "~" + "*".join(NM1) + "~"

    def third_HL(self): # PROVIDER INFO  SV: medicaid #, XX: NPI
        HL = ['HL', '3', '2', '19', '1']
        # print(self.bill_provider['MedicaidProviderNum'])
        NM1 = ['NM1', '1P', '2', self.bill_provider['BaseName'], '', '', '', '', 'SV', self.bill_provider['MedicaidProviderNum']]

        return "*".join(HL) + "~" + "*".join(NM1) + "~"

    def fourth_HL(self, dob, gender, patient_lastname, patient_firstname, medicaid_number, claim_ctl_number, service_date, invoice_number):
        HL = ['HL', '4', '3', '22', '0']
        DMG = ['DMG', 'D8', str(dob), gender.upper()]
        NM1 = ['NM1', 'IL', '1', patient_lastname.strip().upper(), patient_firstname.strip().upper(), '', '', '', 'MI', medicaid_number]
        TRN = ['TRN', '1', str(invoice_number).strip()]
        REF = ['REF', '1K', str(claim_ctl_number)]
        DTP = ['DTP', '472', 'D8', service_date.__str__()]

        return "*".join(HL) + '~' + "*".join(DMG) + "~" + "*".join(NM1) + "~" + "*".join(TRN) + "~" + "*".join(REF) + "~" + "*".join(DTP) + "~"

    def transaction_trailer(self, iterations):
        SE = ['SE', '15', str('{:>04d}'.format(iterations))]
        return '*'.join(SE) + "~"

    def GE(self, count_ST):
        GE = ['GE', count_ST.__str__(), '1']
        return '*'.join(GE) + '~'

    def IEA(self):
        IEA = ["IEA", "1", self.interchange_ctrl_number]

        return "*".join(IEA) + "~"

    def ST_SE_loop(self):

        result = []
        for row in range(self.transaction_num):
            df_row = self.df.ix[[row]]
            ST = self.transaction_header(iterations=row+1, invoice_number=df_row['INVOICE NUMBER'].values[0])
            first_HL = self.first_HL()
            second_HL = self.second_HL()
            third_HL = self.third_HL()
            fourth_HL = self.fourth_HL(dob=df_row['DOB'].values[0], gender=df_row['GENDER'].values[0],
                                       patient_lastname=df_row['CLIENT LAST NAME'].values[0], patient_firstname=df_row['CLIENT FIRST NAME'].values[0],
                                       medicaid_number=df_row['MEDICAID ID NUMBER'].values[0], claim_ctl_number=df_row['CLAIM CONTROL NUMBER'].values[0],
                                       service_date=df_row['SVC DATE'].values[0], invoice_number=df_row['INVOICE NUMBER'].values[0])
            SE = self.transaction_trailer(iterations=row+1)

            merged_loop = ST + first_HL + second_HL + third_HL + fourth_HL + SE
            result.append(merged_loop)

        return ''.join(result)

    def ISA_IEA(self):
        ISA = self.ISA()
        GS = self.GS()
        ST_SE = self.ST_SE_loop()
        GE = self.GE(self.transaction_num)
        IEA = self.IEA()

        return ISA + GS + ST_SE + GE + IEA


class EDI837P():

    def __init__(self, file, replace=False):
        self.replace = replace
        self.df = pd.read_csv(file, dtype=object) if file[-1] == 'v' else pd.read_excel(file, dtype=object)
        # self.df = self.df.fillna("")

        self.df['service date'] = self.df['service date'].apply(lambda x: datetime.strptime(str(x), "%m/%d/%Y").strftime("%Y%m%d"))
        self.df['patient dob'] = self.df['patient dob'].apply(lambda x: datetime.strptime(str(x), "%m/%d/%Y").strftime("%Y%m%d"))
        self.df['patient pregnant'] = self.df['patient pregnant'].apply(lambda x: x == "Y")

        self.transaction_num = self.df.__len__()
        self.basic_line = 33
        self.lx_lines = 0

        self.submitter_info = info_locker.base_info
        self.bill_provider = info_locker.base_info
        self.driver_info = info_locker.driver_information
        self.receiver_info = info_locker.NYSDOH
        self.version_code = info_locker.version_code['837']

        self.date_format1 = datetime.today().date().strftime("%y%m%d")  #used in ISA
        self.date_format2 = datetime.today().date().strftime("%Y%m%d")
        self.time_format = datetime.now().time().strftime("%H%M")
        self.interchange_ctrl_number = "0" + str(self.date_format1) + str(self.time_format[2:])
        # self.file_name = self.interchange_ctrl_number + '.txt'
        self.all_invoice_number = []
        self.invoice_ST_SE_dict = {}
        if self.replace:
            self.file_name = '837-Replace-' + re.findall(r'\d{4}-\d{2}-\d{2}-to-\d{4}-\d{2}-\d{2}', file)[0] if re.findall(
                r'\d{4}-\d{2}-\d{2}-to-\d{4}-\d{2}-\d{2}', file).__len__() != 0 else '837-' + str(
                datetime.today().date())
        else:
            self.file_name = '837-' + re.findall(r'\d{4}-\d{2}-\d{2}-to-\d{4}-\d{2}-\d{2}', file)[0]  if re.findall(r'\d{4}-\d{2}-\d{2}-to-\d{4}-\d{2}-\d{2}', file).__len__() != 0 else '837-' + str(datetime.today().date())


        self.today_datetime = arrow.now().datetime
        self.delayDate_line = arrow.now().shift(days=-90).datetime

    def ISA(self, prod=True):
        if prod==False:

            ISA = ["ISA", "00", " "*10, "00", " "*10, "ZZ", '{:<15s}'.format(self.submitter_info['ETIN']),
                    "ZZ", '{:<15s}'.format(self.receiver_info['ETIN']), str(self.date_format1),
                    str(self.time_format), '^', '00501', self.interchange_ctrl_number, '0', 'T', ':~']

        else:

            ISA = ["ISA", "00", " "*10, "00", " "*10, "ZZ", '{:<15s}'.format(self.submitter_info['ETIN']),
                    "ZZ", '{:<15s}'.format(self.receiver_info['ETIN']), str(self.date_format1),
                    str(self.time_format), '^', '00501', self.interchange_ctrl_number, '1', 'P', ':~']

        return '*'.join(ISA)

    def GS(self):
        GS = ["GS", "HC", self.submitter_info['ETIN'], self.receiver_info['ETIN'], self.date_format2,
              self.time_format, "1", "X", self.version_code]

        return '*'.join(GS) + "~"

    def transaction_header(self, iterations, invoice_number):
        ST = ["ST", "837", str('{:>04d}'.format(iterations)), self.version_code]
        BHT = ["BHT", "0019", "00", str(invoice_number), self.date_format2, self.time_format, "CH"]
        self.all_invoice_number.append(invoice_number)

        return '*'.join(ST) + "~" + '*'.join(BHT) + "~"

    def loop1000a(self):
        NM1 = ["NM1", "41", "2", self.submitter_info['BaseName'], "", "", "", "", "46", self.submitter_info['ETIN']]
        PER = ["PER", "IC", self.submitter_info['ContactName'], "TE", self.submitter_info['ContactTel'] ]

        return '*'.join(NM1) + "~" + '*'.join(PER) + "~"

    def loop1000b(self):
        NM1 = ["NM1", "40", "2", self.receiver_info['name'], "", "", "", "", "46", self.receiver_info['id']]

        return '*'.join(NM1) + "~"

    def loop2000a(self):   # billing provider HL
        HL = ["HL", "1", "", "20", "1"]

        return '*'.join(HL) + "~"

    def loop2010aa(self): #Billing provider info
        NM1 = ["NM1", "85", "2", self.bill_provider['BaseName']]
        N3 = ["N3", self.bill_provider['BaseAddress']]
        N4 = ["N4", self.bill_provider['City'], self.bill_provider['State'], self.bill_provider['zipcode']]
        REF = ["REF", "EI", self.bill_provider['TaxID']]

        return '*'.join(NM1) + "~" + '*'.join(N3) + "~" + '*'.join(N4) + "~" + '*'.join(REF) + "~"

    def loop2000b(self):  # subscriber HL
        HL = ["HL", "2", "1", "22", "0"]
        SBR = ["SBR", "P", "18", "", "", "", "", "", "", "MC"]

        return '*'.join(HL) + "~" + '*'.join(SBR) + "~"

    def loop2010ba(self, first, last, medi_num, address, city, state, zipcode, dob, gender):
        if first == "":
            first = "NoRecord"
        if last == "":
            last = "NoRecord"
        if medi_num == "":
            medi_num = "NoRecord"
        if address == "":
            address = 'NoRecord'
        if city == "":
            city = "NoRecord"
        if state == "":
            state = "NoRecord"
        if zipcode == "":
            zipcode = "00000"
        if dob == "":
            dob = "19000101"
        if gender == "":
            gender = "M"

        NM1 = ["NM1", "IL", "1", last.upper(), first.upper(), "", "", "", "MI", medi_num]
        N3 = ["N3", address.upper()]
        N4 = ["N4", city.upper(), state.upper(), str(zipcode)]
        DMG = ["DMG", "D8", str(dob), gender]

        return '*'.join(NM1) + "~" + '*'.join(N3) + "~" + '*'.join(N4) + "~" + '*'.join(DMG) + "~" # subscriber name

    def loop2010bb(self): # payer info
        NM1 = ["NM1", "PR", "2", self.receiver_info['name'], "", "", "", "", "PI", self.receiver_info['id']]
        N3 = ["N3", self.receiver_info['address']]
        N4 = ["N4", self.receiver_info['city'], self.receiver_info['state'], self.receiver_info['zipcode']]
        REF1 = ["REF", "G2", self.submitter_info['MedicaidProviderNum']]
        REF2 = ["REF", "LU", "003"]

        return '*'.join(NM1) + "~" + '*'.join(N3) + "~" + '*'.join(N4) + "~" + '*'.join(REF1) + "~" + '*'.join(REF2) + "~"

    def loop2300(self, invoice_number, amount, pa_num, delay_claim=False, payer_control_num=None): #claim info
        if amount == "":
            amount = "0"
        if pa_num == "":
            pa_num = 0

        if self.replace == False:
            replace_code = '99:B:1'
        else:
            replace_code = '99:B:7'

        if delay_claim == True:
            CLM = ["CLM", str(invoice_number), str(amount), "", "", replace_code, "Y", "A", "Y", "Y", "P", "","","","","","","","","","11"]
        else:
            CLM = ["CLM", str(invoice_number), str(amount), "", "", replace_code, "Y", "A", "Y", "Y", "P"]


        REF = ['REF', "G1", str('{:>011d}'.format(int(pa_num)))]
        HI = ["HI", "ABK:R69"]

        if self.replace == False:
            return '*'.join(CLM) + "~" + '*'.join(REF) + "~" + '*'.join(HI) + "~"
        else:
            REF_replace = ['REF', 'F8', str(payer_control_num)]
            return '*'.join(CLM) + "~" + '*'.join(REF_replace) + '~' + '*'.join(REF) + "~" + '*'.join(HI) + "~"

    def loop2310a(self, driver_first, driver_last, driver_lic, service_name, service_NPI): #referring provider
        if driver_first == "":
            driver_first = "NoRecord"
        if driver_last == "":
            driver_last = "NoRecord"
        if driver_lic == "":
            driver_lic = 000000000
        if service_name == "":
            service_name = "NoRecord"
        if service_NPI == "":
            service_NPI = 000000000
        NM1 = ["NM1", "DN", "1", service_name.upper(), "", "", "", "", "XX", str(service_NPI)]
        NM1_1 = ["NM1", "P3", "1", driver_last.upper(), driver_first.upper()]
        REF = ["REF", "0B", str(driver_lic)]

        return '*'.join(NM1) + "~" + '*'.join(NM1_1) + "~" + '*'.join(REF) + "~"

    def loop2310b(self, driver_plate): #rendering provider name
        if driver_plate == "":
            driver_plate = 'A000000A'
        NM1 = ["NM1", "82", "2", self.submitter_info['BaseName']]
        REF = ["REF", "G2", driver_plate.upper()]

        return '*'.join(NM1) + "~" + "*".join(REF) + "~"

    def loop2310c(self, service_name, service_NPI, service_address, service_city, service_state, service_zip):
        NM1 = ["NM1", "77", "2", service_name.upper().replace(",", ""), "", "", "", "", "XX", str(service_NPI)]
        N3 = ["N3", service_address.upper()]
        N4 = ["N4", service_city.upper(), service_state.upper(), str(service_zip)]

        return '*'.join(NM1) + "~" + '*'.join(N3) + "~" + '*'.join(N4) + "~"

    def lx1(self, code, modifier, amount, unit, service_date):
        if str(modifier) == 'nan':
            SV1_01 = "HC:{0}".format(code)

        else:
            SV1_01 = "HC:{0}:{1}".format(code, modifier)

        if isinstance(unit, np.int64) == True:
            SV1_04 = str(int(unit))
        else:
            SV1_04 = str(unit)

        LX1 = ["LX", "1"]
        SV1 = ["SV1", SV1_01, str(amount), "UN", SV1_04, "", "", "1", "", "", "", "", "", "", "", "0"]
        DTP = ["DTP", "472", "D8", service_date]

        return '*'.join(LX1) + "~" + '*'.join(SV1) + "~" + '*'.join(DTP) + "~"

    def lx2(self, code, modifier, amount, unit, service_date):
        if str(modifier) == 'nan':
            SV2_01 = "HC:{0}".format(code)

        else:
            SV2_01 = "HC:{0}:{1}".format(code, modifier)

        if isinstance(unit, np.int64) == True:
            SV2_04 = str(int(unit))
        else:
            SV2_04 = str(unit)

        LX2 = ["LX", "2"]
        SV2 = ["SV1", SV2_01, str(amount), "UN", SV2_04, "", "", "1", "", "", "", "", "", "", "", "0"]
        DTP = ["DTP", "472", "D8", service_date]

        return '*'.join(LX2) + "~" + '*'.join(SV2) + "~" + '*'.join(DTP) + "~"

    def lx3(self, code, modifier, amount, unit, service_date):
        if str(modifier) == 'nan':
            SV3_01 = "HC:{0}".format(code)

        else:
            SV3_01 = "HC:{0}:{1}".format(code, modifier)


        if isinstance(unit, np.int64) == True:
            SV3_04 = str(int(unit))
        else:
            SV3_04 = str(unit)

        LX3 = ["LX", "3"]
        SV3 = ["SV1", SV3_01, str(amount), "UN", SV3_04 , "", "", "1", "", "", "", "", "", "", "", "0"]
        DTP = ["DTP", "472", "D8", service_date]

        return '*'.join(LX3) + "~" + '*'.join(SV3) + "~" + '*'.join(DTP) + "~"

    def lx4(self, code, modifier, amount, unit, service_date):
        if str(modifier) == 'nan':
            SV4_01 = "HC:{0}".format(code)

        else:
            SV4_01 = "HC:{0}:{1}".format(code, modifier)

        if isinstance(unit, np.int64) == True:
            SV4_04 = str(int(unit))
        else:
            SV4_04 = str(unit)

        LX4 = ["LX", "4"]
        SV4 = ["SV1", SV4_01, str(amount), "UN", SV4_04, "", "", "1", "", "", "", "", "", "", "", "0"]
        DTP = ["DTP", "472", "D8", service_date]

        return '*'.join(LX4) + "~" + '*'.join(SV4) + "~" + '*'.join(DTP) + "~"

    def lx5(self, code, modifier, amount, unit, service_date):
        if str(modifier) == 'nan':
            SV5_01 = "HC:{0}".format(code)

        else:
            SV5_01 = "HC:{0}:{1}".format(code, modifier)

        if isinstance(unit, np.int64) == True:
            SV5_04 = str(int(unit))
        else:
            SV5_04 = str(unit)

        LX5 = ["LX", "5"]
        SV5 = ["SV1", SV5_01, str(amount), "UN", SV5_04, "", "", "1", "", "", "", "", "", "", "", "0"]
        DTP = ["DTP", "472", "D8", service_date]

        return '*'.join(LX5) + "~" + '*'.join(SV5) + "~" + '*'.join(DTP) + "~"

    def lx6(self, code, modifier, amount, unit, service_date):
        if str(modifier) == 'nan':
            SV6_01 = "HC:{0}".format(code)

        else:
            SV6_01 = "HC:{0}:{1}".format(code, modifier)

        if isinstance(unit, np.int64) == True:
            SV6_04 = str(int(unit))
        else:
            SV6_04 = str(unit)

        LX6 = ["LX", "6"]
        SV6 = ["SV1", SV6_01, str(amount), "UN", SV6_04, "", "", "1", "", "", "", "", "", "", "", "0"]
        DTP = ["DTP", "472", "D8", service_date]

        return '*'.join(LX6) + "~" + '*'.join(SV6) + "~" + '*'.join(DTP) + "~"

    def loop2400(self, row_data):

        lx1 = self.lx1(code=row_data['service code 1'].values[0], amount=row_data['amount 1'].values[0], unit=row_data['unit 1'].values[0],
                       service_date=row_data['service date'].values[0], modifier=row_data['modifier code 1'].values[0])

        if row_data['service code 2'].isnull().values[0] == True:
            lx2 = lx3 = lx4 = lx5 = lx6 = ""
        else:
            lx2 = self.lx2(code=row_data['service code 2'].values[0], amount=row_data['amount 2'].values[0], unit=row_data['unit 2'].values[0],
                           service_date=row_data['service date'].values[0], modifier=row_data['modifier code 2'].values[0])

            if row_data['service code 3'].isnull().values[0] == True:
                lx3 = lx4 = lx5 = lx6 = ""

            else:
                lx3 = self.lx3(code=row_data['service code 3'].values[0], amount=row_data['amount 3'].values[0], unit=row_data['unit 3'].values[0],
                               service_date=row_data['service date'].values[0], modifier=row_data['modifier code 3'].values[0])

                if row_data['service code 4'].isnull().values[0] == True:
                    lx4 = lx5 = lx6 = ""

                else:
                    lx4 = self.lx4(code=row_data['service code 4'].values[0], amount=row_data['amount 4'].values[0], unit=row_data['unit 4'].values[0],
                               service_date=row_data['service date'].values[0], modifier=row_data['modifier code 4'].values[0])

                    if row_data['service code 5'].isnull().values[0] == True:
                        lx5 = lx6 = ""

                    else:
                        lx5 = self.lx5(code=row_data['service code 5'].values[0], amount=row_data['amount 5'].values[0], unit=row_data['unit 5'].values[0],
                               service_date=row_data['service date'].values[0], modifier=row_data['modifier code 5'].values[0])

                        if row_data['service code 6'].isnull().values[0] == True:
                            lx6 = ""
                        else:
                            lx6 = self.lx6(code=row_data['service code 6'].values[0], amount=row_data['amount 6'].values[0], unit=row_data['unit 6'].values[0],
                               service_date=row_data['service date'].values[0], modifier=row_data['modifier code 6'].values[0])

        if len(lx1) > 0:
            self.lx_lines += 3

        if len(lx2) > 0:
            self.lx_lines += 3

        if len(lx3) > 0:
            self.lx_lines += 3

        if len(lx4) > 0:
            self.lx_lines += 3

        if len(lx5) > 0:
            self.lx_lines += 3

        if len(lx6) > 0:
            self.lx_lines += 3

        return lx1+lx2+lx3+lx4+lx5+lx6

    def transaction_trailer(self, count_line, iterations):
        SE = ["SE", str(count_line), str('{:>04d}'.format(iterations))]
        return '*'.join(SE) + "~"

    def GE(self, count_ST):
        GE = ["GE", str(count_ST), "1"]

        return '*'.join(GE) + "~"

    def IEA(self):
        IEA = ["IEA", "1", self.interchange_ctrl_number]

        return '*'.join(IEA) + "~"

    def ST_SE_loop(self):

        result = []
        temp_invoice_num = []
        temp_ST_SE = []
        temp_patient_fn = []
        temp_patient_ln = []
        temp_patient_medicaid_num = []
        temp_service_date = []
        temp_837_name = []

        for row in range(self.transaction_num):
            self.lx_lines = 0
            df_row = self.df.ix[[row]]   # get row data

            service_date = df_row['service date'].values[0]
            arrow_serviceDate = arrow.get(service_date, 'YYYYMMDD').datetime

            delayClaim_switch = True if arrow_serviceDate <= self.delayDate_line else False
            payerControlNum = df_row['payer control number'].values[0] if delayClaim_switch == True else None

            ST = self.transaction_header(iterations=row+1, invoice_number= df_row['invoice number'].values[0])
            loop1000a = self.loop1000a()
            loop1000b = self.loop1000b()
            loop2000a = self.loop2000a()
            loop2010aa = self.loop2010aa()
            loop2000b = self.loop2000b()
            loop2010ba = self.loop2010ba(first=df_row['patient first name'].values[0], last=df_row['patient last name'].values[0], medi_num=df_row['patient medicaid number'].values[0],
                                         address=df_row['patient address'].values[0], city=df_row['patient city'].values[0], state=df_row['patient state'].values[0],
                                         zipcode=df_row['patient zip code'].values[0], dob=df_row['patient dob'].values[0], gender=df_row['patient gender'].values[0])
            loop2010bb = self.loop2010bb()
            loop2300 = self.loop2300(invoice_number=df_row['invoice number'].values[0], amount=df_row['claim_amount'].values[0], pa_num=df_row['pa number'].values[0], delay_claim=delayClaim_switch, payer_control_num=payerControlNum)
            loop2310a = self.loop2310a(driver_first=df_row['driver first name'].values[0], driver_last=df_row['driver last name'].values[0],
                                       driver_lic=df_row['driver license number'].values[0], service_name=df_row['service facility name'].values[0],
                                       service_NPI=df_row['service npi'].values[0])
            loop2310b = self.loop2310b(driver_plate=df_row['driver plate number'].values[0])
            loop2310c = self.loop2310c(service_name=df_row['service facility name'].values[0], service_NPI=df_row['service npi'].values[0],
                                       service_address=df_row['service address'].values[0], service_city=df_row['service city'].values[0],
                                       service_state=df_row['service state'].values[0], service_zip=df_row['service zip code'].values[0])
            loop2400 = self.loop2400(df_row)

            lines_st_se = self.basic_line + self.lx_lines
            SE = self.transaction_trailer(count_line=lines_st_se, iterations=row+1)

            merge_loop = ST + loop1000a + loop1000b + loop2000a + loop2010aa + loop2000b + loop2010ba + loop2010bb + loop2300 + loop2310a + loop2310b + loop2310c + loop2400 + SE

            # self.invoice_ST_SE_dict[str(df_row['invoice number'].values[0])] = {'ST_SE loop': merge_loop,
            #                                                                     'Patient FN': df_row['patient first name'].values[0],
            #                                                                     'Patient LN': df_row['patient last name'].values[0],
            #                                                                     'Patient medicaid number': df_row['patient medicaid number'].values[0],
            #                                                                     'Service date': df_row['service date'].values[0],
            #                                                                     '837 file name': self.file_name,
            #                                                                     }
            temp_837_name.append(self.file_name)
            temp_invoice_num.append(df_row['invoice number'].values[0])
            temp_patient_fn.append(df_row['patient first name'].values[0])
            temp_patient_ln.append(df_row['patient last name'].values[0])
            temp_patient_medicaid_num.append(df_row['patient medicaid number'].values[0])
            temp_ST_SE.append(merge_loop)
            temp_service_date.append(df_row['service date'].values[0])

            result.append(merge_loop)

        self.invoice_ST_SE_dict = {'837 file name': temp_837_name,
                                   'Invoice number': temp_invoice_num,
                                   'Patient FN': temp_patient_fn,
                                   'Patient LN': temp_patient_ln,
                                   'Patient medicaid number': temp_patient_medicaid_num,
                                   'Service date': temp_service_date,
                                   'ST_SE': temp_ST_SE}
        return "".join(result)

    def ISA_IEA(self):
        ISA = self.ISA()
        GS = self.GS()
        ST_SE = self.ST_SE_loop()
        GE = self.GE(self.transaction_num)
        IEA = self.IEA()

        return ISA + GS + ST_SE + GE + IEA


class Process_MAS():

    def __init__(self, raw_file):

        self.raw_file = raw_file

        if self.raw_file[-1] == "t":   # determine how to read data
            read_data = pd.read_table
        elif self.raw_file[-1] == "v":
            read_data = pd.read_csv
        else:
            read_data = pd.read_excel

        self.raw_df = read_data(raw_file)   # read data
        self.raw_df['Pick-up Address'] = self.raw_df['Pick-up Address'].apply(lambda x: Process_Method().clean_address(x))        # clean address for the raw data
        self.raw_df['Drop-off Address'] = self.raw_df['Drop-off Address'].apply(lambda x: Process_Method().clean_address(x))

    def add_AB_leg(self, tocsv=False):

        unique_invoice = self.raw_df["Invoice Number"].unique().tolist()   # get unique invoice numbers

        for invoice_num in unique_invoice:
            idx = self.raw_df.loc[(self.raw_df['Invoice Number'] == invoice_num) & (self.raw_df['Record Type'] == 'Leg')].index   # get each invoice number's index, only for legs
            num_legs = idx.__len__()
            leg_name = ["A", "B", "C", "D"]     # ready for ABCD legs

            leg_id = []
            sorted_idx = []
            if num_legs == 4:    # if there are 4 legs, assign ABCD to legs based on leg_id's value from smallest to largest
                for i in idx:
                    leg_id.append(self.raw_df.ix[i, 'Leg ID'])

                leg_id.sort()

                for l in leg_id:
                    sorted_idx.append(self.raw_df.loc[self.raw_df['Leg ID'] == l].index[0])

                for index, l in enumerate(sorted_idx):

                    self.raw_df.ix[l, 'Invoice Number'] = str(self.raw_df.ix[l, 'Invoice Number']) + leg_name[index]

            else:
                for index, i in enumerate(idx):
                    self.raw_df.ix[i , 'Invoice Number'] = str(self.raw_df.ix[i, 'Invoice Number']) + leg_name[index]

        if tocsv == True:
            self.raw_df.to_csv("MAS-1.csv", index=False)

        return self.raw_df

    def add_codes(self, read_from_outside=False, tofile=False, file_outside=None):
        temp_df = pd.DataFrame()

        if read_from_outside == True:
            cd_df = pd.read_csv(file_outside)

        else:
            cd_df = self.add_AB_leg()
            # cd_df = self.raw_df

        cd_df['Code3'] = ""
        cd_df['Code3 Modifier'] = ""

        leg_idx = cd_df.loc[cd_df['Record Type'] == 'Leg'].index
        leg_idx_len = leg_idx.__len__()

        for i in leg_idx:

            # Legs all in NYC
            if (cd_df.ix[i, 'Pick-up Zip'] in info_locker.nyc_zip) and (cd_df.ix[i, "Drop-off Zip"] in info_locker.nyc_zip):
                if cd_df.ix[i, "Leg Mileage"] < 5:
                    cd_df.ix[i, "Code1"] = "A0100"
                    cd_df.ix[i, "Code1 Modifier"] = ""

                    cd_df.ix[i, "Code2"] = ""
                    cd_df.ix[i, "Code2 Modifier"] = ""

                elif 5 <= cd_df.ix[i, "Leg Mileage"] <= 8:
                    cd_df.ix[i, "Code1"] = "A0100"
                    cd_df.ix[i, "Code1 Modifier"] = "TN"

                    cd_df.ix[i, "Code2"] = ""
                    cd_df.ix[i, "Code2 Modifier"] = ""

                elif cd_df.ix[i, "Leg Mileage"] > 8:
                    cd_df.ix[i, "Code1"] = "A0100"
                    cd_df.ix[i, "Code1 Modifier"] = "TN"

                    cd_df.ix[i, "Code2"] = "S0215"
                    cd_df.ix[i, "Code2 Modifier"] = ""

                # one leg in NYC and the other leg not in nyc
            if (cd_df.ix[i, "Pick-up Zip"] not in info_locker.nyc_zip) or (cd_df.ix[i, "Drop-off Zip"] not in info_locker.nyc_zip):
                cd_df.ix[i, "Code1"] = "A0100"
                cd_df.ix[i, "Code1 Modifier"] = "TN"

                cd_df.ix[i, "Code2"] = "S0215"
                cd_df.ix[i, "Code2 Modifier"] = "TN"

             # in queens not in nass, use google APIs
            if (cd_df.ix[i, "Pick-up Zip"] in info_locker.queens_but_not_nass_zip) or (cd_df.ix[i, "Drop-off Zip"] in info_locker.queens_but_not_nass_zip):

                queens_nass_pickup_address = cd_df.ix[i, "Pick-up Address"] + " " + cd_df.ix[i, "Pick-up City"] + " " + str(cd_df.ix[i, "Pick-up Zip"].astype(int))
                queens_nass_dropoff_address = cd_df.ix[i, "Drop-off Address"] + " " + cd_df.ix[i, "Drop-off City"] + " " + str(cd_df.ix[i, "Drop-off Zip"].astype(int))

                queens_nass_pickup_address = re.sub(' +', ' ', queens_nass_pickup_address)
                queens_nass_dropoff_address = re.sub(' +', ' ', queens_nass_dropoff_address)

                bool_pickup_is_nassau = Process_Method().is_in_nassau(queens_nass_pickup_address)
                bool_dropoff_is_nassau = Process_Method().is_in_nassau(queens_nass_dropoff_address)

                if (bool_pickup_is_nassau==True and bool_dropoff_is_nassau==False) or\
                        (bool_pickup_is_nassau==False and bool_dropoff_is_nassau==True) or \
                        (bool_pickup_is_nassau == True and bool_dropoff_is_nassau == True):
                    cd_df.ix[i, "Code1"] = "A0100"
                    cd_df.ix[i, "Code1 Modifier"] = "TN"

                    cd_df.ix[i, "Code2"] = "S0215"
                    cd_df.ix[i, "Code2 Modifier"] = "TN"

                if (bool_pickup_is_nassau==False and bool_dropoff_is_nassau==False):
                    if cd_df.ix[i, "Leg Mileage"] < 5:
                        cd_df.ix[i, "Code1"] = "A0100"
                        cd_df.ix[i, "Code1 Modifier"] = ""

                        cd_df.ix[i, "Code2"] = ""
                        cd_df.ix[i, "Code2 Modifier"] = ""

                    elif 5 <= cd_df.ix[i, "Leg Mileage"] <= 8:
                        cd_df.ix[i, "Code1"] = "A0100"
                        cd_df.ix[i, "Code1 Modifier"] = "TN"

                        cd_df.ix[i, "Code2"] = ""
                        cd_df.ix[i, "Code2 Modifier"] = ""

                    elif cd_df.ix[i, "Leg Mileage"] > 8:
                        cd_df.ix[i, "Code1"] = "A0100"
                        cd_df.ix[i, "Code1 Modifier"] = "TN"

                        cd_df.ix[i, "Code2"] = "S0215"
                        cd_df.ix[i, "Code2 Modifier"] = ""


                # one leg under 110st, the other not in 110st

            if ((cd_df.ix[i, "Pick-up Zip"] in info_locker.under_110st_zip) and (cd_df.ix[i, "Drop-off Zip"] not in info_locker.zip_across_110) and (cd_df.ix[i, "Drop-off Zip"] not in info_locker.under_110st_zip)) or \
                    ((cd_df.ix[i, "Drop-off Zip"] in info_locker.under_110st_zip) and (cd_df.ix[i, "Pick-up Zip"] not in info_locker.zip_across_110) and (cd_df.ix[i, "Pick-up Zip"] not in info_locker.under_110st_zip)):
                if cd_df.ix[i, "Leg Mileage"] >= 3:

                    if cd_df.ix[i, "Code2"].__len__() == 0:
                        cd_df.ix[i, "Code2"] = "A0100"
                        cd_df.ix[i, "Code2 Modifier"] = "SC"
                    else:
                        cd_df.ix[i, "Code3"] = "A0100"
                        cd_df.ix[i, "Code3 Modifier"] = "SC"


            if ((cd_df.ix[i, "Pick-up Zip"] in info_locker.zip_across_110) or (cd_df.ix[i, "Drop-off Zip"] in info_locker.zip_across_110)) and (cd_df.ix[i, "Leg Mileage"] >= 3):

                pickup_address = re.sub(' +', " ", cd_df.ix[i, 'Pick-up Address']) + " " + cd_df.ix[i, 'Pick-up City']
                dropoff_address = re.sub(' +', " ", cd_df.ix[i, 'Drop-off Address']) + " " + cd_df.ix[i, 'Drop-off City']
                pick_lat, pick_lng = Process_Method().google2geo(pickup_address)
                drop_lat, drop_lng = Process_Method().google2geo(dropoff_address)
                point_pickup = Point(pick_lng, pick_lat)
                point_dropoff = Point(drop_lng, drop_lat)
                is_pickup_below_110st = point_pickup.within(info_locker.MH_below_110st_polygon)
                is_dropoff_below_110st = point_dropoff.within(info_locker.MH_below_110st_polygon)

                if is_pickup_below_110st != is_dropoff_below_110st:
                    if cd_df.ix[i, "Code2"].__len__() == 0:
                        cd_df.ix[i, "Code2"] = "A0100"
                        cd_df.ix[i, "Code2 Modifier"] = "SC"

                    else:
                        cd_df.ix[i, "Code3"] = "A0100"
                        cd_df.ix[i, "Code3 Modifier"] = "SC"

        temp_df['service_date'] = cd_df['Service Starts'].apply(lambda x: datetime.strptime(x, '%m/%d/%Y').date())
        min_service_date = min(temp_df['service_date'])
        max_service_date = max(temp_df['service_date'])

        cd_df = cd_df[['Export ID', 'Record_Number', 'Invoice Number', 'Record Type',
                           'First Name', 'Middle Initial', 'Last Name', 'CIN', 'Gender',
                           'Telephone', 'Birthdate', 'Medical Provider', 'Provider ID',
                           'Ordering Provider ID', 'Transport Company', 'Transport Type',
                           'Procedure Code', 'Procedure Code Modifier', 'Service Starts',
                           'Service Ends', 'Standing Order', 'Trips Approved', 'Days Approved',
                           'Wheelchair', 'Contact Name', 'Contact Phone',
                           'Total/Calculated Mileage', 'Pick-up Date', 'Pick-up Time',
                           'Pick-up Address', 'Pick-up Ste/Apt', 'Pick-up City', 'Pick-up State',
                           'Pick-up Zip', 'Drop-off Date', 'Drop-off Time', 'Drop-off Address',
                           'Drop-off Ste/Apt', 'Drop-off City', 'Drop-off State', 'Drop-off Zip',
                           'Leg Mileage', 'Instructions', 'Secondary Service', 'Changed', 'Leg ID',
                           'Code1', 'Code1 Modifier', 'Code2', 'Code2 Modifier', 'Code3', 'Code3 Modifier']]
        if tofile == True:

            current_path = os.getcwd()
            daily_folder = str(datetime.today().date())
            basename = info_locker.base_info['BaseName']
            file_saving_path = os.path.join(current_path, basename, daily_folder)
            if not os.path.exists(file_saving_path):
                os.makedirs(file_saving_path)
                print('Save files to {0}'.format(file_saving_path))

            cd_df.to_excel(os.path.join(file_saving_path, 'Processed MAS-{0}-to-{1}.xlsx'.format(min_service_date, max_service_date)), index=False)

        return cd_df


class SignoffAndCompare():
    def __init__(self):
        pass

    def sign_off(self, mas_2, total_job, tofile=False):         # both are excel files

        temp_df = pd.DataFrame()
        total_job_df = pd.read_csv(total_job, header=None) if total_job[-1] == 'v' else pd.read_excel(total_job, header=None)
        total_job_df.columns = ['FleetNumber', 'ServiceDate', 'CompanyCode', 'CustomerName', 'TripID', 'TollFee',
                                'Amount', 'pComany', 'pReserve', 'pPerson']
        total_job_df = total_job_df.dropna()

        # check if there is duplicated trip in total jobs
        duplicated_idx = total_job_df.duplicated(subset=['TripID'], keep='last')

        if any(duplicated_idx):
            only_duplicated_trips_in_totaljobs = total_job_df.loc[duplicated_idx]

            current_path = os.getcwd()
            daily_folder = str(datetime.today().date())
            basename = info_locker.base_info['BaseName']
            file_saving_path = os.path.join(current_path, basename, daily_folder)
            if not os.path.exists(file_saving_path):
                os.makedirs(file_saving_path)
                print('Save files to {0}'.format(file_saving_path))

            only_duplicated_trips_in_totaljobs.to_excel(os.path.join(file_saving_path, 'duplicated_trips_in_totaljob-{0}-{1}.xlsx'.format(str(datetime.today().date()), str(datetime.now().time().strftime('%H%M%S')))), index=False)

        if isinstance(mas_2, pd.DataFrame):
            mas_2_df = mas_2
        else:
            mas_2_df = pd.read_csv(mas_2) if mas_2[-1] == 'v' else pd.read_excel(mas_2)

        #### drop service type
        service_idx = mas_2_df.loc[mas_2_df['Record Type'] == 'Service'].index
        mas_2_df = mas_2_df.drop(mas_2_df.index[service_idx])

            ### Merge code
        temp_df['merge_code1'] = mas_2_df['Code1'].fillna("") + mas_2_df['Code1 Modifier'].fillna("")
        temp_df['merge_code2'] = mas_2_df['Code2'].fillna("") + mas_2_df['Code2 Modifier'].fillna("")
        temp_df['merge_code3'] = mas_2_df['Code3'].fillna("") + mas_2_df['Code3 Modifier'].fillna("")

        mas_2_df['merge_codes'] = temp_df['merge_code1'] + " "+ temp_df['merge_code2'] + " " + temp_df['merge_code3']
        mas_2_df['merge_codes'] = mas_2_df['merge_codes'].apply(lambda x: str(x).strip().replace(" ", ","))

            ##### clean address
        mas_2_df['Pick-up Address'] = mas_2_df['Pick-up Address'].apply(lambda x: Process_Method().clean_address(x))
        mas_2_df['Drop-off Address'] = mas_2_df['Drop-off Address'].apply(lambda x: Process_Method().clean_address(x))

            ##### add driver info to total jobs
        total_job_df['driver id'] = total_job_df['FleetNumber'].apply(lambda x: info_locker.driver_information[str(x)]['DRIVER_ID'])
        total_job_df['vehicle id'] = total_job_df['FleetNumber'].apply(lambda x: info_locker.driver_information[str(x)]['VEHICLE_ID'])

            ##### compute difference
        data_in_total = mas_2_df[mas_2_df['Invoice Number'].isin(total_job_df['TripID'])]
        # data_not_in_total = mas_2_df[~mas_2_df['Invoice Number'].isin(total_job_df['TripID'])]

        invoice_list_in_total = data_in_total['Invoice Number'].tolist()
        # invoice_list_not_in_total = data_not_in_total['Invoice Number'].tolist()

        total_job_df['Codes'] = ""
        total_job_df['MAS amount'] = ""
        total_job_df['Difference'] = ""
        #total job compares MAS amount
        unique_trip_in_totaljob = total_job_df['TripID'].unique().tolist()
        for trip in unique_trip_in_totaljob:
            idx_trip_totaljob = total_job_df.loc[total_job_df['TripID'] == trip].index.tolist()
            idx_trip_processedjob = mas_2_df.loc[mas_2_df['Invoice Number'] == trip].index.tolist()

            mas_amount = 0.
            if idx_trip_processedjob.__len__() != 0:
                mas_merge_codes = mas_2_df.ix[idx_trip_processedjob[0], 'merge_codes']
                leg_mile = float(mas_2_df.ix[idx_trip_processedjob[0], 'Leg Mileage'])
                total_job_df.ix[idx_trip_totaljob[0], 'Codes'] = mas_merge_codes
                # print(mas_merge_codes)
                for code in mas_merge_codes.split(','):   ######## BUG: mas_merge_codes is string, should split first
                    if code == 'A0100':
                        mas_amount += 25.95
                    elif code == 'A0100TN':
                        mas_amount += 35
                    elif code == 'S0215':
                        mas_amount += 3.21 * (leg_mile - 8.)
                    elif code == 'S0215TN':
                        mas_amount += 2.25*leg_mile
                    elif code == 'A0100SC':
                        mas_amount += 25
                    else:
                        mas_amount += 0

                total_job_df.ix[idx_trip_totaljob[0], 'MAS amount'] = math.floor(float(format(mas_amount * 100, '.2f'))) / 100.0
                total_job_df.ix[idx_trip_totaljob[0], 'Difference'] = mas_amount - total_job_df.ix[idx_trip_totaljob[0], 'Amount']

        current_path = os.getcwd()
        daily_folder = str(datetime.today().date())
        basename = info_locker.base_info['BaseName']
        file_saving_path = os.path.join(current_path, basename, daily_folder)
        if not os.path.exists(file_saving_path):
            os.makedirs(file_saving_path)
            print('Save files to {0}'.format(file_saving_path))

        total_job_df.to_excel(os.path.join(file_saving_path, f'Difference_Totaljobs&Claims_{datetime.today().date()}_{datetime.now().time().strftime("%H%M%S")}.xlsx'), index=False)


        sign_off_df = pd.DataFrame()

        def get_tollfee(x):  # get toll fee from total jobs file
            res = total_job_df.loc[total_job_df['TripID'] == x, 'TollFee'].iloc
            try:
                result = res[0]
            except:
                result = 0
            return result

        def get_leg_status(x):    # if invoice number in total jobs, assign leg status 0
            # print(x)
            if x in invoice_list_in_total:

                return 0
            else:
                return 1

        def get_driver_id(x):
            res = total_job_df.loc[total_job_df['TripID'] == x, 'driver id'].iloc

            try:
                result = res[0]

            except:
                result = ""

            return result

        def get_vehicle_id(x):
            res = total_job_df.loc[total_job_df['TripID']==x, 'vehicle id'].iloc

            try:
                result = res[0]

            except:
                result = ""

            return result

        def transfer2time(x):
            try:
                result = datetime.strptime(x, '%H%M').strftime('%H:%M')

            except:
                result = 'CA:LL'

            return result

        sign_off_df['SERVICE DAY'] = mas_2_df['Service Starts']
        sign_off_df['INVOICE ID'] = mas_2_df['Invoice Number']
        sign_off_df['LEG ID'] = mas_2_df['Leg ID'].astype(int)
        sign_off_df['TOLL FEE'] = sign_off_df['INVOICE ID'].apply(lambda x: get_tollfee(x))
        sign_off_df['PROCEDURE CODE'] = mas_2_df['merge_codes']

        mas_2_df['Leg Mileage'] = mas_2_df['Leg Mileage'].apply(lambda x: math.ceil(float(x)))
        sign_off_df['TRIP MILEAGE'] = mas_2_df['Leg Mileage']

        sign_off_df['PICK UP ADDRESS'] = mas_2_df['Pick-up Address']
        sign_off_df['PICK UP CITY'] = mas_2_df['Pick-up City']
        sign_off_df['PICK UP ZIPCODE'] = mas_2_df['Pick-up Zip'].astype(int)
        sign_off_df['DROP OFF ADDRESS'] = mas_2_df['Drop-off Address']
        sign_off_df['DROP OFF CITY'] = mas_2_df['Drop-off City']
        sign_off_df['DROP OFF ZIPCODE'] = mas_2_df['Drop-off Zip'].astype(int)
        sign_off_df['PICK UP TIME'] = mas_2_df['Pick-up Time']
        sign_off_df['PICK UP TIME'] = sign_off_df['PICK UP TIME'].apply(lambda x: str(x).zfill(4))
        sign_off_df['PICK UP TIME'] = sign_off_df['PICK UP TIME'].apply(lambda x: transfer2time(x))

        def transfer2timeformat(x):
            try:
                result = datetime.strptime(x, '%H:%M').time()
            except:
                result = datetime.strptime('00:00', '%H:%M').time()
            return result

        temp_df['delta_time'] = sign_off_df['TRIP MILEAGE'].apply(lambda x: timedelta(minutes=(int(x)+0.4) * 4))
        temp_df['pick_up time'] = sign_off_df['PICK UP TIME'].apply(lambda x: transfer2timeformat(x))
        temp_df['dropoff_time1'] = temp_df['pick_up time'].apply(lambda x: datetime.combine(datetime.today().date(), x))
        temp_df['dropoff_time'] = temp_df['dropoff_time1'] + temp_df['delta_time']
        temp_df['dropoff_time'] = temp_df['dropoff_time'].apply(lambda x: x.time().strftime('%H:%M'))
        sign_off_df['DROP OFF TIME'] = temp_df['dropoff_time']
        sign_off_df['DRIVER ID'] = sign_off_df['INVOICE ID'].apply(lambda x: get_driver_id(x))
        sign_off_df['VEHICLE ID'] = sign_off_df['INVOICE ID'].apply(lambda x: get_vehicle_id(x))
        sign_off_df['LEG STATUS'] = sign_off_df['INVOICE ID'].apply(lambda x: get_leg_status(x))

        data_not_in_total = total_job_df[~total_job_df['TripID'].isin(sign_off_df['INVOICE ID'])]
        if data_not_in_total.__len__() != 0:

            current_path = os.getcwd()
            daily_folder = str(datetime.today().date())
            basename = info_locker.base_info['BaseName']
            file_saving_path = os.path.join(current_path, basename, daily_folder)
            if not os.path.exists(file_saving_path):
                os.makedirs(file_saving_path)
                print('Save files to {0}'.format(file_saving_path))

            data_not_in_total.to_excel(os.path.join(file_saving_path, 'Missed Trips in TotalJob but not in signoff-' + str(datetime.today().date()) + str(datetime.now().time().strftime("%H%M%S")) + '.xlsx'), index=False)

        unique_invoice = sign_off_df["INVOICE ID"].unique().tolist()


        ####################################### change CALL on pick up or drop off time##############
        pickup_delta = timedelta(minutes=45)

        for invoice_num in unique_invoice:
            idx = sign_off_df.loc[sign_off_df["INVOICE ID"] == invoice_num].index.tolist()
            leg_id = [sign_off_df.ix[i, 'LEG ID'] for i in idx]
            leg_id.sort()

            sorted_idx = [sign_off_df.loc[sign_off_df['LEG ID'] == l].index[0] for l in leg_id]

            for index, i in enumerate(sorted_idx):
                if sign_off_df.ix[i, 'PICK UP TIME'] == 'CA:LL' and index != 0:
                    last_row_idx = sorted_idx[index - 1]
                    last_row_dropoff_time = sign_off_df.ix[last_row_idx, "DROP OFF TIME"]
                    temp_last_dropoff_time = datetime.strptime(last_row_dropoff_time, "%H:%M").time()
                    temp_last_dropoff_time_date = datetime.combine(datetime.today().date(), temp_last_dropoff_time)

                    new_pickup_time = datetime.combine(datetime.today().date(), temp_last_dropoff_time) + pickup_delta
                    new_dropoff_time = new_pickup_time + pickup_delta

                    if temp_last_dropoff_time_date.date() == new_pickup_time.date():
                        sign_off_df.ix[i, 'PICK UP TIME'] = new_pickup_time.strftime("%H:%M")
                        sign_off_df.ix[i, 'DROP OFF TIME'] = new_dropoff_time.strftime("%H:%M")
                    else:
                        pass

        temp_df['service_date'] = mas_2_df['Service Starts'].apply(lambda x: datetime.strptime(x, '%m/%d/%Y').date())
        self.min_service_date = min(temp_df['service_date'])
        self.max_service_date = max(temp_df['service_date'])

        missed_trip_concat_to_signoff_df = pd.DataFrame()
        missed_trip_concat_to_signoff_df['SERVICE DAY'] = data_not_in_total['ServiceDate']
        missed_trip_concat_to_signoff_df['INVOICE ID'] = data_not_in_total['TripID']
        missed_trip_concat_to_signoff_df['LEG ID'] = "NA"
        missed_trip_concat_to_signoff_df['PROCEDURE CODE'] = "NA"
        missed_trip_concat_to_signoff_df['TRIP MILEAGE'] = "NA"
        missed_trip_concat_to_signoff_df['PICK UP ADDRESS'] = "NA"
        missed_trip_concat_to_signoff_df['PICK UP CITY'] = "NA"
        missed_trip_concat_to_signoff_df['PICK UP ZIPCODE'] = "NA"
        missed_trip_concat_to_signoff_df['DROP OFF ADDRESS'] = "NA"
        missed_trip_concat_to_signoff_df['DROP OFF CITY'] = "NA"
        missed_trip_concat_to_signoff_df['DROP OFF ZIPCODE'] = "NA"
        missed_trip_concat_to_signoff_df['PICK UP TIME'] = "NA"
        missed_trip_concat_to_signoff_df['DROP OFF TIME'] = "NA"
        missed_trip_concat_to_signoff_df['DRIVER ID'] = data_not_in_total['driver id']
        missed_trip_concat_to_signoff_df['VEHICLE ID'] = data_not_in_total['vehicle id']
        missed_trip_concat_to_signoff_df['LEG STATUS'] = "NA"
        missed_trip_concat_to_signoff_df['CIN'] = "NA"

        sign_off_df = sign_off_df.sort_values(by='LEG STATUS')
        sign_off_df['INVOICE ID'] = sign_off_df['INVOICE ID'].apply(lambda x: x[:-1])
        sign_off_df['CIN'] = mas_2_df['CIN']
        sign_off_df['NPI'] = mas_2_df['Ordering Provider ID']   # 0429 added

        sign_off_df = pd.concat([sign_off_df, missed_trip_concat_to_signoff_df], 0, sort=False)
        sign_off_df = sign_off_df[['SERVICE DAY', 'INVOICE ID', 'LEG ID', 'TOLL FEE', 'PROCEDURE CODE',
                                   'TRIP MILEAGE', 'PICK UP ADDRESS', 'PICK UP CITY', 'PICK UP ZIPCODE',
                                   'DROP OFF ADDRESS', 'DROP OFF CITY', 'DROP OFF ZIPCODE', 'PICK UP TIME',
                                   'DROP OFF TIME', 'DRIVER ID', 'VEHICLE ID', 'LEG STATUS', 'CIN', 'NPI']]
        if tofile == True:
            # date = datetime.today().date()
            current_path = os.getcwd()
            daily_folder = str(datetime.today().date())
            basename = info_locker.base_info['BaseName']
            file_saving_path = os.path.join(current_path, basename, daily_folder)
            if not os.path.exists(file_saving_path):
                os.makedirs(file_saving_path)
                print('Save files to {0}'.format(file_saving_path))

            sign_off_df.to_excel(os.path.join(file_saving_path, 'MAS Sign-off-{0}-to-{1}.xlsx'.format(self.min_service_date, self.max_service_date)),index=False)

        return sign_off_df

    def compare_signoff_PA(self, signoff, pa_file, tofile=False, to837=False, mas_2=None):
        '''
        Encode unit or Qty as order: [A0100, A0100TN, A0215, A0215TN, A0100SC, A0170CG]
        :param signoff: Sign-off csv file name
        :param pa_file: PA-Roast csv file name
        :param tofile: If generate output csv file
        :return:
        '''
        temp_df = pd.DataFrame()
        result_df = pd.DataFrame()
        df_for_837 = pd.DataFrame()
        missed_trip = pd.DataFrame()

        pa_roast_df = pd.read_csv(pa_file) if pa_file[-1] == 'v' else pd.read_table(pa_file)
        # pa_roast_df = pd.read_table(pa_file)
        pa_roast_df = pa_roast_df.fillna("")
        pa_roast_df['Invoice Number'] = pa_roast_df['Invoice Number'].astype(str)

        signoff_df = pd.read_csv(signoff) if signoff[-1] == 'v' else pd.read_excel(signoff)
        signoff_df = signoff_df.loc[signoff_df['LEG STATUS'] == 0]

        # unique_invoice_pa = pa_roast_df['Invoice Number'].unique().tolist()
        unique_invoice_signoff = signoff_df['INVOICE ID'].unique().tolist()

        invoice_num_list = []
        encode_pa = []
        pa_number = []
        encode_signoff = []
        signoff_Amount_notollfee = []
        service_date_list = []
        signoff_tollfee_list = []
        CIN_list = []
        missed_trips_list = []
        service_NPI = []
        driver_id = []
        vehicle_id = []

        for invoice_num in unique_invoice_signoff:
            ####### process PA roast #########

            idx_pa = pa_roast_df.loc[pa_roast_df['Invoice Number'] == str(invoice_num)].index.tolist()
            if idx_pa.__len__() == 0:
                missed_trips_list.append(invoice_num)

            else:

                pa_number.append(pa_roast_df.ix[idx_pa[0], 'Prior Approval Number'])  # append pa number
                service_NPI.append(pa_roast_df.ix[idx_pa[0], 'Ordering Provider'])
                invoice_num_list.append(invoice_num)
                temp_encode_pa = [0 for _ in range(5)]
                for i in idx_pa:

                    code = pa_roast_df.ix[i, 'Item Code'] + pa_roast_df.ix[i, 'Item Code Mod']
                    unit = pa_roast_df.ix[i, 'Qty']
                    if code == 'A0100':
                        temp_encode_pa[0] = int(unit)
                    elif code == 'A0100TN':
                        temp_encode_pa[1] = int(unit)
                    elif code == 'S0215':
                        temp_encode_pa[2] = unit
                    elif code == 'S0215TN':
                        temp_encode_pa[3] = unit
                    elif code == 'A0100SC':
                        temp_encode_pa[4] = int(unit)
                    # elif code == 'A0170CG': temp_encode[5] = unit
                    else:
                        pass

                encode_pa.append(temp_encode_pa)

                ######## process sign off #############
                idx_sign = signoff_df.loc[signoff_df['INVOICE ID'] == invoice_num].index.tolist()
                service_date_list.append(signoff_df.ix[idx_sign[0], 'SERVICE DAY'])
                CIN_list.append(signoff_df.ix[idx_sign[0], 'CIN'])
                driver_id.append(signoff_df.ix[idx_sign[0], 'DRIVER ID'])
                vehicle_id.append(signoff_df.ix[idx_sign[0], 'VEHICLE ID'])
                temp_encode_signoff = [0 for _ in range(5)]
                all_codes = []
                all_0215mileage = []
                all_0215TN_mileage = []
                signoff_tollfee = []

                for i in idx_sign:
                    code = signoff_df.ix[i, 'PROCEDURE CODE']
                    trip_mile = signoff_df.ix[i, 'TRIP MILEAGE']
                    code = code.split(",")

                    if 'S0215' in code:
                        all_0215mileage.append(trip_mile - 8)
                    if 'S0215TN' in code:
                        all_0215TN_mileage.append(trip_mile)

                    all_codes += code  # update all codes in one invoice number
                    signoff_tollfee.append(signoff_df.ix[i, 'TOLL FEE'])
                toll_fee = sum(signoff_tollfee)

                ######## compute unit #############
                temp_encode_signoff[0] = all_codes.count('A0100')
                temp_encode_signoff[1] = all_codes.count('A0100TN')
                temp_encode_signoff[2] = round(sum(all_0215mileage), 2) if 'S0215' in all_codes else 0
                temp_encode_signoff[3] = round(sum(all_0215TN_mileage), 2) if 'S0215TN' in all_codes else 0
                temp_encode_signoff[4] = all_codes.count('A0100SC')
                # temp_encode[5] = all_codes.count('A0170CG')
                encode_signoff_array = np.asarray(temp_encode_signoff)

                # 2017.12.31，（不包含31号）之前 A0100 = 25.2
                # 根据service day 做判断
                cache_service_day = signoff_df.ix[idx_sign[0], 'SERVICE DAY']
                thresh_date = arrow.get('12/31/2017', 'MM/DD/YYYY').date()

                if arrow.get(cache_service_day, 'MM/DD/YYYY').date() < thresh_date:

                    price_array = np.array([[25.2], [35], [3.02], [2.25], [25]])
                else:
                    price_array = np.array([[25.95], [35], [3.21], [2.25], [25]])

                totalprice = np.dot(encode_signoff_array, price_array)
                totalprice = str(totalprice)
                totalprice = float(totalprice[1:-1])
                totalprice = math.floor(float(format(totalprice * 100, '.2f'))) / 100.0

                signoff_Amount_notollfee.append(totalprice)
                encode_signoff.append(temp_encode_signoff)
                signoff_tollfee_list.append(toll_fee)

        missed_trip['MISSED TRIPS'] = missed_trips_list

        result_df['service_date'] = service_date_list
        result_df['invoice number'] = invoice_num_list
        result_df['CIN'] = CIN_list
        result_df['pa_number'] = pa_number
        result_df['DRIVER ID'] = driver_id
        result_df['VEHICLE ID'] = vehicle_id
        result_df['Service NPI'] = service_NPI
        result_df['encode_pa'] = encode_pa
        result_df['encode_signoff'] = encode_signoff
        result_df['compare_result'] = np.where(result_df['encode_pa'] == result_df['encode_signoff'], "", "Different")
        result_df['sign-off amount no toll fee'] = signoff_Amount_notollfee
        result_df['sign-off toll fee'] = signoff_tollfee_list
        result_df['sign-off Total Amount'] = result_df['sign-off amount no toll fee'] + result_df['sign-off toll fee']
        result_df['sign-off Total Amount'] = result_df['sign-off Total Amount'].apply(lambda x: float(format(x, '.2f')))

        temp_df['service_date'] = signoff_df['SERVICE DAY'].apply(lambda x: datetime.strptime(x, '%m/%d/%Y').date())
        self.min_service_date = min(temp_df['service_date'])
        self.max_service_date = max(temp_df['service_date'])

        if tofile == True:
            current_path = os.getcwd()
            daily_folder = str(datetime.today().date())
            basename = info_locker.base_info['BaseName']
            file_saving_path = os.path.join(current_path, basename, daily_folder)
            if not os.path.exists(file_saving_path):
                os.makedirs(file_saving_path)
                print('Save files to {0}'.format(file_saving_path))

            result_df.to_excel(os.path.join(file_saving_path, 'MAS Correction-{0}-to-{1}.xlsx'.format(self.min_service_date, self.max_service_date)), index=False)

        if missed_trip.__len__() != 0:

            current_path = os.getcwd()
            daily_folder = str(datetime.today().date())
            basename = info_locker.base_info['BaseName']
            file_saving_path = os.path.join(current_path, basename, daily_folder)
            if not os.path.exists(file_saving_path):
                os.makedirs(file_saving_path)
                print('Save files to {0}'.format(file_saving_path))

            missed_trip.to_excel(os.path.join(file_saving_path, 'MISSED TRIPS-{0}-to-{1}.xlsx'.format(self.min_service_date, self.max_service_date)), index=False)

        if to837 == True:
            mas_2_df = pd.read_csv(mas_2) if mas_2[-1] == 'v' else pd.read_excel(mas_2)

            patient_lastname = []
            patient_firstname = []
            patient_address = []
            patient_city = []
            patient_state = []
            patient_zipcode = []
            patient_gender = []
            patient_pregnant = []
            patient_dob = []
            patient_medicaid_num = []
            invoice_number_for837 = []
            pa_number_for837 = []
            driver_lastname = []
            driver_firstname = []
            driver_license = []
            vehicle_plate = []
            service_facility_name_list = []
            service_address_list = []
            service_city = []
            service_state = []
            service_zip = []
            service_date = []
            service_npi = []
            claim_amount = []

            code1 = []
            code1_modifier = []
            code1_amount = []
            code1_unit = []

            code2 = []
            code2_modifier = []
            code2_amount = []
            code2_unit = []

            code3 = []
            code3_modifier = []
            code3_amount = []
            code3_unit = []

            code4 = []
            code4_modifier = []
            code4_amount = []
            code4_unit = []

            code5 = []
            code5_modifier = []
            code5_amount = []
            code5_unit = []

            code6 = []
            code6_modifier = []
            code6_amount = []
            code6_unit = []

            for invoice_num in unique_invoice_signoff:
                invoice_num_in_mas = str(invoice_num) + 'A'  # Get A leg in mas_2_df
                invoice_num_in_mas_index = mas_2_df.loc[mas_2_df['Invoice Number'] == invoice_num_in_mas].index.tolist()

                invoice_num_in_result_df_index = result_df.loc[result_df['invoice number'] == invoice_num].index.tolist()
                invoice_num_in_pa_roast_index = pa_roast_df.loc[pa_roast_df['Invoice Number'] == str(invoice_num)].index.tolist()
                if invoice_num_in_pa_roast_index.__len__() == 0:
                    continue
                invoice_num_in_signoff_index = signoff_df.loc[signoff_df['INVOICE ID'] == invoice_num].index.tolist()

                patient_firstname.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'First Name'].upper())
                patient_lastname.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'Last Name'].upper())
                patient_address.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'Pick-up Address'])
                patient_city.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'Pick-up City'])
                patient_state.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'Pick-up State'])
                patient_zipcode.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'Pick-up Zip'])
                patient_gender.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'Gender'])
                patient_pregnant.append('N')
                patient_dob.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'Birthdate'])
                patient_medicaid_num.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'CIN'])
                invoice_number_for837.append(invoice_num)

                temp_pa_number = re.findall(r'\d+', pa_roast_df.ix[invoice_num_in_pa_roast_index[0], 'Prior Approval Number'])
                if temp_pa_number.__len__() == 0:
                    temp_pa_number = [0]
                pa_number_for837.append(temp_pa_number[0])

                driver_license_num = signoff_df.ix[invoice_num_in_signoff_index[0], 'DRIVER ID']
                vehicle_plate_num = signoff_df.ix[invoice_num_in_signoff_index[0], 'VEHICLE ID']
                # print(info_locker.driver_information)
                driver_fn, driver_ln = Process_Method().use_driver_id_to_find_drivername(int(driver_license_num))

                driver_lastname.append(driver_ln)
                driver_firstname.append(driver_fn)
                driver_license.append(int(driver_license_num))
                vehicle_plate.append(vehicle_plate_num)

                service_facility_name_list.append(str(mas_2_df.ix[invoice_num_in_mas_index[0], 'Medical Provider']).replace(',', ''))
                service_address_list.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'Drop-off Address'])
                service_city.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'Drop-off City'])
                service_state.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'Drop-off State'])
                service_zip.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'Drop-off Zip'])
                service_date.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'Service Starts'])

                threshhold_date = arrow.get('12/31/2017', 'MM/DD/YYYY').date()
                edi_temp_date = mas_2_df.ix[invoice_num_in_mas_index[0], 'Service Starts']

                if arrow.get(edi_temp_date, 'MM/DD/YYYY').date() < threshhold_date:
                    info_locker.decoding_info =  {
                        '0': {'code': 'A0100', 'modifier': "", 'price': 25.2},
                        '1': {'code': 'A0100', 'modifier': "TN", 'price': 35},
                        '2': {'code': 'S0215', 'modifier': "", 'price': 3.02},
                        '3': {'code': 'S0215', 'modifier': "TN", 'price': 2.25},
                        '4': {'code': 'A0100', 'modifier': "SC", 'price': 25},
                        '5': {'code': 'A0170', 'modifier': "CG", }
                    }
                else:
                    info_locker.decoding_info =  {
                        '0': {'code': 'A0100', 'modifier': "", 'price': 25.95},
                        '1': {'code': 'A0100', 'modifier': "TN", 'price': 35},
                        '2': {'code': 'S0215', 'modifier': "", 'price': 3.21},
                        '3': {'code': 'S0215', 'modifier': "TN", 'price': 2.25},
                        '4': {'code': 'A0100', 'modifier': "SC", 'price': 25},
                        '5': {'code': 'A0170', 'modifier': "CG", }
                    }


                service_npi.append(mas_2_df.ix[invoice_num_in_mas_index[0], 'Ordering Provider ID'])

                claim_amount.append(result_df.ix[invoice_num_in_result_df_index[0], 'sign-off Total Amount'])

                #### for service codes
                encoded_service_codes_no_toll = result_df.ix[invoice_num_in_result_df_index[0], 'encode_signoff']
                invoice_num_tollfee = result_df.ix[invoice_num_in_result_df_index[0], 'sign-off toll fee']

                encoded_service_codes_no_toll.append(invoice_num_tollfee)
                encoded_all_service_codes = encoded_service_codes_no_toll

                non_zero_encoding_index = []
                for encoding_index, qty in enumerate(encoded_all_service_codes):
                    if qty == 0:
                        continue
                    else:
                        non_zero_encoding_index.append(encoding_index)

                number_of_codes = non_zero_encoding_index.__len__()

                if number_of_codes == 1:
                    code1.append(info_locker.decoding_info[str(non_zero_encoding_index[0])]['code'])
                    code1_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[0])]['modifier'])
                    code1_qty = encoded_all_service_codes[non_zero_encoding_index[0]]
                    code1_unit.append(code1_qty)
                    code1_amount.append(math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[0])]['price'] * code1_qty * 100, '.2f'))) / 100.0)

                    code2.append("")
                    code2_modifier.append("")
                    code2_amount.append("")
                    code2_unit.append("")

                    code3.append("")
                    code3_modifier.append("")
                    code3_amount.append("")
                    code3_unit.append("")

                    code4.append("")
                    code4_modifier.append("")
                    code4_amount.append("")
                    code4_unit.append("")

                    code5.append("")
                    code5_modifier.append("")
                    code5_amount.append("")
                    code5_unit.append("")

                    code6.append("")
                    code6_modifier.append("")
                    code6_amount.append("")
                    code6_unit.append("")

                if number_of_codes == 2:
                    code1.append(info_locker.decoding_info[str(non_zero_encoding_index[0])]['code'])
                    code1_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[0])]['modifier'])
                    code1_qty = encoded_all_service_codes[non_zero_encoding_index[0]]
                    code1_unit.append(code1_qty)
                    code1_amount.append(math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[0])]['price'] * code1_qty * 100, '.2f'))) / 100.0)

                    if non_zero_encoding_index[1] != 5:
                        code2.append(info_locker.decoding_info[str(non_zero_encoding_index[1])]['code'])
                        code2_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[1])]['modifier'])
                        code2_qty = encoded_all_service_codes[non_zero_encoding_index[1]]
                        code2_unit.append(code2_qty)
                        code2_amount.append(math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[1])]['price'] * code2_qty * 100, '.2f'))) / 100.0)

                    else:
                        code2.append(info_locker.decoding_info[str(non_zero_encoding_index[1])]['code'])
                        code2_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[1])]['modifier'])
                        code2_unit.append(1)
                        code2_amount.append(encoded_all_service_codes[5])

                    code3.append("")
                    code3_modifier.append("")
                    code3_amount.append("")
                    code3_unit.append("")

                    code4.append("")
                    code4_modifier.append("")
                    code4_amount.append("")
                    code4_unit.append("")

                    code5.append("")
                    code5_modifier.append("")
                    code5_amount.append("")
                    code5_unit.append("")

                    code6.append("")
                    code6_modifier.append("")
                    code6_amount.append("")
                    code6_unit.append("")

                if number_of_codes == 3:
                    code1.append(info_locker.decoding_info[str(non_zero_encoding_index[0])]['code'])
                    code1_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[0])]['modifier'])
                    code1_qty = encoded_all_service_codes[non_zero_encoding_index[0]]
                    code1_unit.append(code1_qty)
                    code1_amount.append(math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[0])]['price'] * code1_qty * 100, '.2f'))) / 100.0)

                    code2.append(info_locker.decoding_info[str(non_zero_encoding_index[1])]['code'])
                    code2_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[1])]['modifier'])
                    code2_qty = encoded_all_service_codes[non_zero_encoding_index[1]]
                    code2_unit.append(code2_qty)
                    code2_amount.append(math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[1])]['price'] * code2_qty * 100, '.2f'))) / 100.0)

                    if non_zero_encoding_index[2] != 5:
                        code3.append(info_locker.decoding_info[str(non_zero_encoding_index[2])]['code'])
                        code3_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[2])]['modifier'])
                        code3_qty = encoded_all_service_codes[non_zero_encoding_index[2]]
                        code3_unit.append(code3_qty)
                        code3_amount.append(math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[2])]['price'] * code3_qty * 100, '.2f'))) / 100.0)

                    else:
                        code3.append(info_locker.decoding_info[str(non_zero_encoding_index[2])]['code'])
                        code3_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[2])]['modifier'])
                        code3_unit.append(1)
                        code3_amount.append(encoded_all_service_codes[5])

                    code4.append("")
                    code4_modifier.append("")
                    code4_amount.append("")
                    code4_unit.append("")

                    code5.append("")
                    code5_modifier.append("")
                    code5_amount.append("")
                    code5_unit.append("")

                    code6.append("")
                    code6_modifier.append("")
                    code6_amount.append("")
                    code6_unit.append("")

                if number_of_codes == 4:
                    code1.append(info_locker.decoding_info[str(non_zero_encoding_index[0])]['code'])
                    code1_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[0])]['modifier'])
                    code1_qty = encoded_all_service_codes[non_zero_encoding_index[0]]
                    code1_unit.append(code1_qty)
                    code1_amount.append(
                        math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[0])]['price'] * code1_qty * 100, '.2f'))) / 100.0)

                    code2.append(info_locker.decoding_info[str(non_zero_encoding_index[1])]['code'])
                    code2_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[1])]['modifier'])
                    code2_qty = encoded_all_service_codes[non_zero_encoding_index[1]]
                    code2_unit.append(code2_qty)
                    code2_amount.append(
                        math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[1])]['price'] * code2_qty * 100, '.2f'))) / 100.0)

                    code3.append(info_locker.decoding_info[str(non_zero_encoding_index[2])]['code'])
                    code3_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[2])]['modifier'])
                    code3_qty = encoded_all_service_codes[non_zero_encoding_index[2]]
                    code3_unit.append(code3_qty)
                    code3_amount.append(
                        math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[2])]['price'] * code3_qty * 100, '.2f'))) / 100.0)

                    if non_zero_encoding_index[3] != 5:
                        code4.append(info_locker.decoding_info[str(non_zero_encoding_index[3])]['code'])
                        code4_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[3])]['modifier'])
                        code4_qty = encoded_all_service_codes[non_zero_encoding_index[3]]
                        # code4_unit.append(code4_qty)
                        # code4_amount.append(
                        #     math.floor(decoding_info[str(non_zero_encoding_index[3])]['price'] * code4_qty * 100) / 100.0)
                        code4_unit.append(code4_qty)
                        code4_amount.append(math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[3])]['price'] * code4_qty * 100, '.2f'))) / 100.0)
                    else:
                        code4.append(info_locker.decoding_info[str(non_zero_encoding_index[3])]['code'])
                        code4_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[3])]['modifier'])
                        code4_unit.append(1)
                        code4_amount.append(encoded_all_service_codes[5])

                    code5.append("")
                    code5_modifier.append("")
                    code5_amount.append("")
                    code5_unit.append("")

                    code6.append("")
                    code6_modifier.append("")
                    code6_amount.append("")
                    code6_unit.append("")

                if number_of_codes == 5:
                    code1.append(info_locker.decoding_info[str(non_zero_encoding_index[0])]['code'])
                    code1_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[0])]['modifier'])
                    code1_qty = encoded_all_service_codes[non_zero_encoding_index[0]]
                    code1_unit.append(code1_qty)
                    code1_amount.append(
                        math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[0])]['price'] * code1_qty * 100, '.2f'))) / 100.0)

                    code2.append(info_locker.decoding_info[str(non_zero_encoding_index[1])]['code'])
                    code2_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[1])]['modifier'])
                    code2_qty = encoded_all_service_codes[non_zero_encoding_index[1]]
                    code2_unit.append(code2_qty)
                    code2_amount.append(
                        math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[1])]['price'] * code2_qty * 100, '.2f'))) / 100.0)

                    code3.append(info_locker.decoding_info[str(non_zero_encoding_index[2])]['code'])
                    code3_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[2])]['modifier'])
                    code3_qty = encoded_all_service_codes[non_zero_encoding_index[2]]
                    code3_unit.append(code3_qty)
                    code3_amount.append(
                        math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[2])]['price'] * code3_qty * 100, '.2f'))) / 100.0)

                    code4.append(info_locker.decoding_info[str(non_zero_encoding_index[3])]['code'])
                    code4_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[3])]['modifier'])
                    code4_qty = encoded_all_service_codes[non_zero_encoding_index[3]]
                    code4_unit.append(code4_qty)
                    code4_amount.append(
                        math.floor(float(format(info_locker.decoding_info[str(non_zero_encoding_index[3])]['price'] * code4_qty * 100, '.2f'))) / 100.0)

                    code5.append(info_locker.decoding_info[str(non_zero_encoding_index[4])]['code'])
                    code5_modifier.append(info_locker.decoding_info[str(non_zero_encoding_index[4])]['modifier'])
                    code5_qty = encoded_all_service_codes[non_zero_encoding_index[4]]
                    # code4_unit.append(code4_qty)
                    # code4_amount.append(
                    #     math.floor(decoding_info[str(non_zero_encoding_index[3])]['price'] * code4_qty * 100) / 100.0)
                    code5_unit.append(1)
                    code5_amount.append(encoded_all_service_codes[5])

                    code6.append("")
                    code6_modifier.append("")
                    code6_amount.append("")
                    code6_unit.append("")


            df_for_837['patient last name'] = patient_lastname
            df_for_837['patient first name'] = patient_firstname
            df_for_837['patient address'] = patient_address
            df_for_837['patient city'] = patient_city
            df_for_837['patient state'] = patient_state
            df_for_837['patient zip code'] = patient_zipcode
            df_for_837['patient gender'] = patient_gender
            df_for_837['patient pregnant'] = patient_pregnant
            df_for_837['patient dob'] = patient_dob
            df_for_837['patient medicaid number'] = patient_medicaid_num
            df_for_837['invoice number'] = invoice_number_for837
            df_for_837['pa number'] = pa_number_for837
            df_for_837['driver last name'] = driver_lastname
            df_for_837['driver first name'] = driver_firstname
            df_for_837['driver license number'] = driver_license
            df_for_837['driver plate number'] = vehicle_plate
            df_for_837['service facility name'] = service_facility_name_list
            df_for_837['service address'] = service_address_list
            df_for_837['service city'] = service_city
            df_for_837['service state'] = service_state
            df_for_837['service zip code'] = service_zip
            df_for_837['service date'] = service_date
            df_for_837['service npi'] = service_npi
            df_for_837['claim_amount'] = claim_amount

            df_for_837['service code 1'] = code1
            df_for_837['modifier code 1'] = code1_modifier
            df_for_837['amount 1'] = code1_amount
            df_for_837['unit 1'] = code1_unit

            df_for_837['service code 2'] = code2
            df_for_837['modifier code 2'] = code2_modifier
            df_for_837['amount 2'] = code2_amount
            df_for_837['unit 2'] = code2_unit

            df_for_837['service code 3'] = code3
            df_for_837['modifier code 3'] = code3_modifier
            df_for_837['amount 3'] = code3_amount
            df_for_837['unit 3'] = code3_unit

            df_for_837['service code 4'] = code4
            df_for_837['modifier code 4'] = code4_modifier
            df_for_837['amount 4'] = code4_amount
            df_for_837['unit 4'] = code4_unit

            df_for_837['service code 5'] = code5
            df_for_837['modifier code 5'] = code5_modifier
            df_for_837['amount 5'] = code5_amount
            df_for_837['unit 5'] = code5_unit

            df_for_837['service code 6'] = code6
            df_for_837['modifier code 6'] = code6_modifier
            df_for_837['amount 6'] = code6_amount
            df_for_837['unit 6'] = code6_unit


            # Second 837P
            # df_2nd_837 = df_for_837
            # df_2nd_837 = df_2nd_837.fillna("")
            #
            # for r in range(len(df_2nd_837)):
            #     row_data = df_2nd_837.ix[r, :]
            #
            #     # calculate number of legs
            #     count_legs = int(row_data['unit 1'])
            #
            #     if (row_data['service code 2'] == 'A0100') and (row_data['modifier code 2'] == 'TN'):
            #         count_legs += int(row_data['unit 2'])
            #
            #     if (row_data['service code 2'] == 'S0215'):
            #         if row_data['modifier code 2'] == 'TN':
            #             old_amount2 = row_data['amount 2']
            #
            #             df_2nd_837.ix[r, 'unit 2'] = math.ceil(row_data['unit 2'])
            #             df_2nd_837.ix[r, 'amount 2'] = math.floor(float(format(2.25 * df_2nd_837.ix[r, 'unit 2'] * 100, '.2f'))) / 100.0
            #             delta_amount2 = df_2nd_837.ix[r, 'amount 2'] - old_amount2
            #             delta_amount2 = float(format(delta_amount2, '.2f'))
            #             df_2nd_837.ix[r, 'claim_amount'] += delta_amount2
            #
            #         else:
            #             old_amount2 = row_data['amount 2']
            #
            #             df_2nd_837.ix[r, 'unit 2'] = math.ceil(row_data['unit 2'])
            #             df_2nd_837.ix[r, 'amount 2'] = math.floor(
            #                 float(format(3.21 * df_2nd_837.ix[r, 'unit 2'] * 100, '.2f'))) / 100.0
            #             delta_amount2 = df_2nd_837.ix[r, 'amount 2'] - old_amount2
            #             delta_amount2 = float(format(delta_amount2, '.2f'))
            #             df_2nd_837.ix[r, 'claim_amount'] += delta_amount2
            #
            #     if (row_data['service code 3'] == 'S0215'):
            #         if row_data['modifier code 3'] == 'TN':
            #             old_amount3 = row_data['amount 3']
            #
            #             df_2nd_837.ix[r, 'unit 3'] = math.ceil(row_data['unit 3'])
            #             df_2nd_837.ix[r, 'amount 3'] = math.floor(float(format(2.25 * df_2nd_837.ix[r, 'unit 3'] * 100, '.2f'))) / 100.0
            #             delta_amount3 = df_2nd_837.ix[r, 'amount 3'] - old_amount3
            #             delta_amount3 = float(format(delta_amount3, '.2f'))
            #             df_2nd_837.ix[r, 'claim_amount'] += delta_amount3
            #
            #         else:
            #             old_amount3 = row_data['amount 3']
            #
            #             df_2nd_837.ix[r, 'unit 3'] = math.ceil(row_data['unit 3'])
            #             df_2nd_837.ix[r, 'amount 3'] = math.floor(float(format(3.21 * df_2nd_837.ix[r, 'unit 3'] * 100, '.2f'))) / 100.0
            #             delta_amount3 = df_2nd_837.ix[r, 'amount 3'] - old_amount3
            #             delta_amount3 = float(format(delta_amount3, '.2f'))
            #             df_2nd_837.ix[r, 'claim_amount'] += delta_amount3
            #
            # df_2nd_837.to_excel(os.path.join(file_saving_path, '837P-2 Data-for-{0}-to-{1}.xlsx'.format(self.min_service_date, self.max_service_date)), index=False)


            current_path = os.getcwd()
            daily_folder = str(datetime.today().date())
            basename = info_locker.base_info['BaseName']
            file_saving_path = os.path.join(current_path, basename, daily_folder)
            if not os.path.exists(file_saving_path):
                os.makedirs(file_saving_path)
                print('Save files to {0}'.format(file_saving_path))

            df_for_837.to_excel(os.path.join(file_saving_path, '837P-1 Data-for-{0}-to-{1}.xlsx'.format(self.min_service_date, self.max_service_date)), index=False)

        return result_df

    def new_compare_after_payment(self, signoff_compare_PA_file, payment_raw_file, edi_837P_file=None):

        new_compare_filename0 = re.findall(r'\d{4}-\d{2}-\d{2}-to-\d{4}-\d{2}-\d{2}', signoff_compare_PA_file)[0]
        new_compare_filename = "Check Payment-" + new_compare_filename0 + '.xlsx'

        def split_CIN_receipt(x):
            # print(x)
            splited = str(x).split(" ")
            CIN, receipt_num = splited[0], splited[1]
            receipt_num = receipt_num.replace("-", "")
            return CIN, int(receipt_num)

        def reverse_minus(x):

            x = str(x)
            if x[-1] == '-':
                x = '-' + x.replace("-", '')
                return float(x)
            else:
                return float(x)

        def remove_leg_from_invoice_number(x):
            if type(x) == str:
                x = x[:-1]
                return int(x)
            else:
                return x

        ### process payment raw file first ###
        payment_df = pd.read_excel(payment_raw_file)
        payment_df.columns = ['useless', 'invoice number', 'patient name', 'CIN and receipt number', 'service date',
                              'code', 'code unit', 'claim amount', 'paid amount', 'note']


        useless_0_index = payment_df.loc[payment_df['useless'] == 0].index
        payment_df = payment_df.drop(payment_df.index[useless_0_index])

        payment_df['CIN'], payment_df['receipt number'] = zip(*payment_df['CIN and receipt number'].map(split_CIN_receipt))
        payment_df = payment_df.drop(['CIN and receipt number'], axis=1)

        payment_df['code unit'] = payment_df['code unit'].apply(lambda x: reverse_minus(x))
        payment_df['claim amount'] = payment_df['claim amount'].apply(lambda x: reverse_minus(x))
        payment_df['paid amount'] = payment_df['paid amount'].apply(lambda x: reverse_minus(x))
        # payment_df['paid amount'] = payment_df['paid amount'].apply(lambda x: math.floor(x * 100) / 100.0)

        payment_df['service date'] = payment_df['service date'].apply(lambda x: datetime.strptime(str(x), "%Y-%m-%d %H:%M:%S").strftime('%m/%d/%Y'))
        payment_df['invoice number'] = payment_df['invoice number'].apply(lambda x: remove_leg_from_invoice_number(x))
        # print(payment_df['paid amount'].tolist())
        ############### Finish process payment raw data ##############################

        signoff_compare_PA_df = pd.read_excel(signoff_compare_PA_file)

        # signoff_compare_PA_df['service date'] = ""
        signoff_compare_PA_df['encode payment'] = ""
        signoff_compare_PA_df['payment paid amount'] = ""
        signoff_compare_PA_df['payer claim control number'] = ""
        # signoff_compare_PA_df['CIN'] = ""
        signoff_compare_PA_df['signoff payment compare'] = ""
        signoff_compare_PA_df['payment result'] = ""
        signoff_compare_PA_df['payment toll fee amount'] = 0

        unique_invoice_number_payment = payment_df['invoice number'].unique().tolist()

        for invoice_number in unique_invoice_number_payment:

            idx_payment = payment_df.loc[payment_df['invoice number'] == invoice_number].index.tolist()
            idx_signoff_compare_PA = signoff_compare_PA_df.loc[signoff_compare_PA_df['invoice number'] == invoice_number].index.tolist()

            if idx_signoff_compare_PA.__len__() == 0:
                continue
            else:
                # signoff_compare_PA_df.ix[idx_signoff_compare_PA[0], 'service date'] = payment_df.ix[idx_payment[0], 'service date']
                signoff_compare_PA_df.ix[idx_signoff_compare_PA[0], 'payer claim control number'] = payment_df.ix[idx_payment[0], 'receipt number']
                # signoff_compare_PA_df.ix[idx_signoff_compare_PA[0], 'CIN'] = payment_df.ix[idx_payment[0], 'CIN']

                temp_encode_payment = [0 for _ in range(5)]
                temp_paid_amount = []
                temp_payment_tollfee = 0

                for i in idx_payment:
                    temp_paid_amount.append(payment_df.ix[i, 'paid amount'])
                    code = payment_df.ix[i, 'code']
                    unit = payment_df.ix[i, 'code unit']
                    if unit < 0:
                        continue
                    else:
                        if code == 'A0100':
                            temp_encode_payment[0] = int(unit)
                        elif code == 'A0100TN':
                            temp_encode_payment[1] = int(unit)
                        elif code == 'S0215':
                            temp_encode_payment[2] = unit
                        elif code == 'S0215TN':
                            temp_encode_payment[3] = unit
                        elif code == 'A0100SC':
                            temp_encode_payment[4] = int(unit)
                        elif code == 'A0170CG':
                            temp_payment_tollfee = payment_df.ix[i, 'paid amount']
                        else:
                            pass

                signoff_compare_PA_df.ix[idx_signoff_compare_PA[0], 'payment toll fee amount'] = float(temp_payment_tollfee)
                signoff_compare_PA_df.ix[idx_signoff_compare_PA[0], 'encode payment'] = str((temp_encode_payment))
                signoff_compare_PA_df.ix[idx_signoff_compare_PA[0], 'payment paid amount'] = round(sum(temp_paid_amount), 2) - float(temp_payment_tollfee)


                if signoff_compare_PA_df.ix[idx_signoff_compare_PA[0], 'encode_signoff'] != signoff_compare_PA_df.ix[idx_signoff_compare_PA[0], 'encode payment']:
                    signoff_compare_PA_df.ix[idx_signoff_compare_PA[0], 'signoff payment compare'] = 'DIFFERENT'
                else:
                    pass


                if signoff_compare_PA_df.ix[idx_signoff_compare_PA[0], 'sign-off Total Amount'] <= signoff_compare_PA_df.ix[idx_signoff_compare_PA[0], 'payment paid amount']:
                    signoff_compare_PA_df.ix[idx_signoff_compare_PA[0], 'payment result'] = 'OKAY'
                else:
                    signoff_compare_PA_df.ix[idx_signoff_compare_PA[0], 'payment result'] = 'DIFFERENT'


        signoff_compare_PA_df = signoff_compare_PA_df.fillna("")

        none_encode_payment_idx = signoff_compare_PA_df.loc[signoff_compare_PA_df['encode payment'] == ""].index.tolist()
        for i in none_encode_payment_idx:
            notFoundServiceDate = signoff_compare_PA_df.ix[i, 'service_date']
            notFoundCIN = signoff_compare_PA_df.ix[i, 'CIN']
            maybeReplacedInvoice = payment_df.loc[((payment_df['CIN'] == notFoundCIN) & (payment_df['service date'] == notFoundServiceDate)), 'invoice number'].tolist()

            if maybeReplacedInvoice.__len__() == 0:
                signoff_compare_PA_df.ix[i, 'payment result'] = 'Not Found'
                signoff_compare_PA_df.ix[i, 'payment tollfee result'] = 'Not Found'

            else:
                # print(maybeReplacedInvoice[0])
                idx_maybeReplacedInvoice = payment_df.loc[payment_df['invoice number'] == maybeReplacedInvoice[0]].index.tolist()
                replacedReceiptNumber = payment_df.ix[idx_maybeReplacedInvoice[0], 'receipt number']
                replacedPaidamount = [payment_df.ix[r, 'paid amount'] for r in idx_maybeReplacedInvoice]
                replacedTotalPaidAmount = round(sum(replacedPaidamount), 2)

                signoff_compare_PA_df.ix[i, 'payment result'] = 'Replaced ' + str(maybeReplacedInvoice[0])
                signoff_compare_PA_df.ix[i, 'payer claim control number'] = replacedReceiptNumber
                signoff_compare_PA_df.ix[i, 'payment paid amount'] = replacedTotalPaidAmount

        signoff_compare_PA_df['payment tollfee result'] = np.where(
            signoff_compare_PA_df['sign-off toll fee'] == signoff_compare_PA_df['payment toll fee amount'], 'OKAY',
            'DIFFERENT')

        for l in range(signoff_compare_PA_df.__len__()):
            row = signoff_compare_PA_df.ix[l, :]

            try:
                reclaim_replace = [round(literal_eval(row['encode_pa'])[i] - literal_eval(row['encode payment'])[i], 2) for i in range(5)]
                real_reclaim_replace = [round(literal_eval(row['encode_pa'])[i] - literal_eval(row['encode payment'])[i], 2) for i in range(5)]
            except:
                reclaim_replace = literal_eval(row['encode_pa'])
                real_reclaim_replace = literal_eval(row['encode_pa'])

            # signoff_compare_PA_df.ix[l, 'reclaim_replace'] = str(reclaim_replace)

            reclaim_replace_gt_0 = [idx for idx, v in enumerate(reclaim_replace) if v > 0]


            for i in reclaim_replace_gt_0:
                real_reclaim_replace[i] = literal_eval(row['encode_signoff'])[i]

            signoff_compare_PA_df.ix[l, 'reclaim_replace'] = str(real_reclaim_replace)

            # print(row['invoice number'], reclaim_replace)


            if row['encode payment'] == "":
                signoff_compare_PA_df.ix[l, 'reclaim_replace_result'] = 'Reclaim'

            elif all(i <= 0 for i in reclaim_replace) and row['sign-off toll fee'] <= row['payment toll fee amount']:
                signoff_compare_PA_df.ix[l, 'reclaim_replace_result'] = 'Passed'

            elif all(reclaim_replace[i] == literal_eval(row['encode_pa'])[i] for i in reclaim_replace_gt_0) or (row['sign-off toll fee'] != 0 and row['payment toll fee amount'] == 0):
                signoff_compare_PA_df.ix[l, 'reclaim_replace_result'] = 'Reclaim'

            else:
                signoff_compare_PA_df.ix[l, 'reclaim_replace_result'] = 'Replace'


        signoff_compare_PA_df['payment result'] = np.where(signoff_compare_PA_df['sign-off amount no toll fee'] == signoff_compare_PA_df['payment paid amount'], 'OKAY', 'DIFFERENT')

        ordered_columns = ['service_date', 'invoice number', 'pa_number', 'encode_pa', 'encode_signoff', 'compare_result', 'encode payment',
                            'reclaim_replace', 'reclaim_replace_result', 'sign-off toll fee', 'payment toll fee amount', 'payment tollfee result', 'sign-off amount no toll fee',
                            'payment paid amount', 'payment result', 'payer claim control number', 'CIN', 'DRIVER ID', 'VEHICLE ID', 'Service NPI']
        signoff_compare_PA_df = signoff_compare_PA_df[ordered_columns]

        current_path = os.getcwd()
        daily_folder = str(datetime.today().date())
        basename = info_locker.base_info['BaseName']
        file_saving_path = os.path.join(current_path, basename, daily_folder)
        if not os.path.exists(file_saving_path):
            os.makedirs(file_saving_path)
            print('Save files to {0}'.format(file_saving_path))

        signoff_compare_PA_df.to_excel(os.path.join(file_saving_path, new_compare_filename), index=False)

        # For reclaim and replacement trips
        if edi_837P_file != None:
            cache_837P_df = pd.read_excel(edi_837P_file)
            cache_837P_df['payer control number'] = signoff_compare_PA_df['payer claim control number']
            #
            # # 1. Replace
            replace_df = signoff_compare_PA_df.loc[signoff_compare_PA_df['reclaim_replace_result'] == 'Replace']
            replace_837_df = cache_837P_df[cache_837P_df['invoice number'].isin(replace_df['invoice number'])]

            replace_837_df.to_excel(os.path.join(file_saving_path, 'Replace_837P_' + new_compare_filename0 + '.xlsx'), index=False)

            ###################################################################################################

            # 2. Reclaim
            # Reset code , code modifier, code amount, code unit
            reclaim_df = signoff_compare_PA_df.loc[signoff_compare_PA_df['reclaim_replace_result'] == 'Reclaim']
            reclaim_837_df = cache_837P_df[cache_837P_df['invoice number'].isin(reclaim_df['invoice number'])]

            reclaim_837_df['service code 1'] = ''
            reclaim_837_df['modifier code 1'] = ''
            reclaim_837_df['amount 1'] = ''
            reclaim_837_df['unit 1'] = ''

            reclaim_837_df['service code 2'] = ''
            reclaim_837_df['modifier code 2'] = ''
            reclaim_837_df['amount 2'] = ''
            reclaim_837_df['unit 2'] = ''

            reclaim_837_df['service code 3'] = ''
            reclaim_837_df['modifier code 3'] = ''
            reclaim_837_df['amount 3'] = ''
            reclaim_837_df['unit 3'] = ''

            reclaim_837_df['service code 4'] = ''
            reclaim_837_df['modifier code 4'] = ''
            reclaim_837_df['amount 4'] = ''
            reclaim_837_df['unit 4'] = ''

            reclaim_837_df['service code 5'] = ''
            reclaim_837_df['modifier code 5'] = ''
            reclaim_837_df['amount 5'] = ''
            reclaim_837_df['unit 5'] = ''

            reclaim_837_df['service code 6'] = ''
            reclaim_837_df['modifier code 6'] = ''
            reclaim_837_df['amount 6'] = ''
            reclaim_837_df['unit 6'] = ''

            reclaim_837_df['claim_amount'] = 0

            ####################################################################################
            trips_to_reclaim = reclaim_df['invoice number'].tolist()
            threshhold_date = arrow.get('12/31/2017', 'MM/DD/YYYY').date()

            for i in trips_to_reclaim:

                idx_reclaim_df = reclaim_df.loc[reclaim_df['invoice number'] == i].index.tolist()
                idx_reclaim_837_df = reclaim_837_df.loc[reclaim_837_df['invoice number'] == i].index.tolist()

                reclaim_code = literal_eval(reclaim_df.ix[idx_reclaim_df[0], 'reclaim_replace'])


                service_date = reclaim_df.ix[idx_reclaim_df[0], 'service_date']
                arrow_service_date = arrow.get(service_date, 'MM/DD/YYYY').date()

                signoff_tollfee = reclaim_df.ix[idx_reclaim_df[0], 'sign-off toll fee']
                payment_tollfee = reclaim_df.ix[idx_reclaim_df[0], 'payment toll fee amount']

                if signoff_tollfee > payment_tollfee:
                    reclaim_tollfee = True
                else:
                    reclaim_tollfee = False


                #### Date check ####
                if arrow_service_date < threshhold_date:
                    A0100_price = 25.2
                    S0215_price = 3.02
                else:
                    A0100_price = 25.95
                    S0215_price = 3.21


                count = 1
                reclaim_amount = 0
                for idx_code, c in enumerate(reclaim_code):
                    if c == 0:
                        continue
                    else:
                        if idx_code == 0:
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'service code {count}'] = 'A0100'
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'modifier code {count}'] = ""
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'amount {count}'] = math.floor(float(format(c * A0100_price * 100, '.2f'))) / 100.0
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'unit {count}'] = c
                            reclaim_amount += math.floor(float(format(c * A0100_price * 100, '.2f'))) / 100.0

                        elif idx_code == 1:
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'service code {count}'] = 'A0100'
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'modifier code {count}'] = "TN"
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'amount {count}'] = math.floor(
                                float(format(c * 35 * 100, '.2f'))) / 100.0
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'unit {count}'] = c

                            reclaim_amount += math.floor(
                                float(format(c * 35 * 100, '.2f'))) / 100.0

                        elif idx_code == 2:
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'service code {count}'] = 'S0215'
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'modifier code {count}'] = ""
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'amount {count}'] = math.floor(
                                float(format(c * S0215_price * 100, '.2f'))) / 100.0
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'unit {count}'] = c

                            reclaim_amount += math.floor(
                                float(format(c * S0215_price * 100, '.2f'))) / 100.0

                        elif idx_code == 3:
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'service code {count}'] = 'S0215'
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'modifier code {count}'] = "TN"
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'amount {count}'] = math.floor(
                                float(format(c * 2.25 * 100, '.2f'))) / 100.0
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'unit {count}'] = c

                            reclaim_amount += math.floor(
                                float(format(c * 2.25 * 100, '.2f'))) / 100.0

                        elif idx_code == 4:
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'service code {count}'] = 'A0100'
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'modifier code {count}'] = "SC"
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'amount {count}'] = math.floor(
                                float(format(c * 25 * 100, '.2f'))) / 100.0
                            reclaim_837_df.ix[idx_reclaim_837_df[0], f'unit {count}'] = c

                            reclaim_amount += math.floor(
                                float(format(c * 25 * 100, '.2f'))) / 100.0

                        else:
                            pass

                        count += 1

                if reclaim_tollfee:
                    reclaim_837_df.ix[idx_reclaim_837_df[0], f'service code {count}'] = 'A0170'
                    reclaim_837_df.ix[idx_reclaim_837_df[0], f'modifier code {count}'] = "CG"
                    reclaim_837_df.ix[idx_reclaim_837_df[0], f'amount {count}'] = signoff_tollfee
                    reclaim_837_df.ix[idx_reclaim_837_df[0], f'unit {count}'] = 1

                    reclaim_amount += signoff_tollfee
                else:
                    pass

                reclaim_837_df.ix[idx_reclaim_837_df[0], 'claim_amount'] = reclaim_amount

            reclaim_837_df.to_excel(os.path.join(file_saving_path, 'Reclaim_837P_' + new_compare_filename0 + '.xlsx'), index=False)


class Process_Method():

    def __init__(self):
        pass

    @staticmethod
    def use_driver_id_to_find_drivername(driverid):

        for key, value in info_locker.driver_information.items():

            if value['DRIVER_ID'] == driverid:
                return value['FirstName'], value['LastName']

    @staticmethod
    def is_in_nassau(address):
        google_geocode_api_url = "https://maps.googleapis.com/maps/api/geocode/json"
        key_list = ['AIzaSyCJ69KvhuscmlIgr5IqyOideByOqJzZHcs', 'AIzaSyA-2V1w_acgbN4RO-40e2HJiwnzuMFtrrQ',
                    'AIzaSyA0b1WxrDmzoJFBuD6zua4CfVXJn1tvgko', 'AIzaSyB3K9wP-0U5EB2AeHsZIN4K5bk0MCBSW2s',
                    'AIzaSyD0OasuP_KjPwlSAc3kZrU8o4zLRh_bsrM', 'AIzaSyCMdT7Q3a178rNw6KqDt9jp8SSgud5V5gM',
                    'AIzaSyC-Axh7DKF4GGBkPYpOVrAP3IsAOpwRHkk', 'AIzaSyB_L0jCnP6hdPg8CDxIDnKp6YKGAZ7eQFM',
                    'AIzaSyAK5T_kCyb1r8aft0sRhy3KBZ1E5N4kcNM']
        random_index = random.randint(0, 8)
        # print(random_index)
        params = {
            "address": address,
            "key": key_list[random_index],
                  }

        req = requests.get(google_geocode_api_url, params=params)
        res = req.json()
        result = res['results']
        text = str(result[0]['address_components'])
        # print(text)
        return 'Nassau County' in text

    @staticmethod
    def add2geo(address):
        geo = None
        count = 0

        while geo == None:
            geo = geocoder.google(address).latlng
            count += 1
            if count > 10:
                geo = [-1, -1]
                break
            sleep(0.1)
        return geo[0], geo[1]

    @staticmethod
    def google2geo(address):
        google_geocode_api_url = "https://maps.googleapis.com/maps/api/geocode/json"
        key_list = ['AIzaSyCJ69KvhuscmlIgr5IqyOideByOqJzZHcs', 'AIzaSyA-2V1w_acgbN4RO-40e2HJiwnzuMFtrrQ',
                    'AIzaSyA0b1WxrDmzoJFBuD6zua4CfVXJn1tvgko', 'AIzaSyB3K9wP-0U5EB2AeHsZIN4K5bk0MCBSW2s',
                    'AIzaSyD0OasuP_KjPwlSAc3kZrU8o4zLRh_bsrM', 'AIzaSyCMdT7Q3a178rNw6KqDt9jp8SSgud5V5gM',
                    'AIzaSyC-Axh7DKF4GGBkPYpOVrAP3IsAOpwRHkk', 'AIzaSyB_L0jCnP6hdPg8CDxIDnKp6YKGAZ7eQFM',
                    'AIzaSyAK5T_kCyb1r8aft0sRhy3KBZ1E5N4kcNM']
        random_index = random.randint(0, 8)
        # print(random_index)
        params = {
            "address": address,
            "key": key_list[random_index],
        }
        req = requests.get(google_geocode_api_url, params=params)
        res = req.json()
        result = res['results']
        geometry = result[0]['geometry']['location']
        return geometry['lat'], geometry['lng']

    @staticmethod
    def is_under_110st(geo_x, geo_y):
        fn = -2.38056214 * geo_x + 23.1700644

        if fn > geo_y:
            return True
        elif fn < geo_y:
            return False
        else:
            print("On 110st!")

    @staticmethod
    def clean_address(x):
        if type(x) is float:
            return

        else:
            x = x.upper()
            a = x.replace(".", " ").split(" ")
            for i in a:
                if i in ['AV', 'AVE', 'AVENUE', 'BLD', 'BOULEVARD', 'BLVD', 'BLDG', 'BOWERY', 'BROADWAY', 'CI',
                         'CT', 'CIR', 'DR', 'DRIVER', 'EXP', 'EXPY', 'EXPRESSWAY', 'EXPWY', 'EXWY',
                         'HIGHWAY', 'HWY', 'LN', 'PL', 'PI', 'PARKWAY', 'PLACE', 'PLZ', 'PKWY', 'RD', 'ROAD',
                         'SQ', 'STR', 'ST', 'STREET', 'SQUARE', 'TNPK', 'TPKE', 'TURNPIKE', 'WAY', 'MALL']:
                    del a[a.index(i) + 1:]
            return " ".join(a)

    @staticmethod
    def transfer2lines(input_file, add_sep="~"):
        df = pd.read_csv(input_file, delimiter="~", header=None,)
        df = df.transpose()
        df.columns = ['line']
        df['line'] = df['line'].dropna().apply(lambda x: x + add_sep)
        inputfile_name = input_file.split("/")[-1]
        df.to_csv("Lined-"+inputfile_name, index=False, header=None)

    @staticmethod
    def transfer2stream(input_file, add_delimiter=False):
        df = pd.read_csv(input_file, names=['lines'])

        df_list = df.ix[:, 0].tolist()
        if add_delimiter == True:
            df_list = map(lambda x: x + "~", df_list)

        result = ''.join(df_list)
        inputfile_name = input_file.split("/")[-1]
        with open('Stream-' + inputfile_name, 'w') as f:
            f.write(result)

    @staticmethod
    def write_txt(data, output_file):
        with open(output_file, 'w') as f:
            f.write(data)

    @staticmethod
    def get_receipt_code(receipt_file, lined_file=True):
        if lined_file==False:    # for raw receipt data
            receipt_df = pd.read_csv(receipt_file, delimiter="~", header=None,)
            receipt_df = receipt_df.transpose()
            receipt_df.columns = ['line']
            receipt_df['line'] = receipt_df['line'].dropna().apply(lambda x: x)
        else:          # already split into lines
            receipt_df = pd.read_csv(receipt_file)
            receipt_df.columns = ['line']

        receipt_df = receipt_df.dropna()
        receipt_df['line_sep'] = receipt_df['line'].apply(lambda x: x.split("*"))

        res_dict = {}
        temp_dict = {}
        temp_inv = ""
        temp_receipt = ""

        for l in range(receipt_df.__len__()):
            row = receipt_df.ix[l, 1]

            if row[0] == 'BHT':
                temp_inv = row[3]

            if row[0] == "REF" and row[1] == "1K":
                temp_receipt = row[2]

            temp_dict[str(temp_inv)] = temp_receipt
            res_dict.update(temp_dict)

            if temp_dict.__len__() >= 1:
                temp_dict = {}

        res_dict.pop("")

        return res_dict

    @staticmethod
    def process_270_receipt(receipt_file, lined_file=True):
        '''
        :param receipt_file: receipt file from EDI270
        :param lined_file: If the file is separated by line
        :return: pandas dataframe containing eligibilty info
        '''

        SQ = mysqlite('EDI.db')   # connect to sqlite3

        if lined_file==False:    # for raw receipt data
            receipt_df = pd.read_csv(receipt_file, delimiter="~", header=None,)
            receipt_df = receipt_df.transpose()
            receipt_df.columns = ['line']
            receipt_df['line'] = receipt_df['line'].dropna()
        else:          # already split into lines
            receipt_df = pd.read_csv(receipt_file)
            receipt_df.columns = ['line']

        receipt_df = receipt_df.dropna()
        receipt_df['line_sep'] = receipt_df['line'].apply(lambda x: x.split("*"))
        # print(receipt_df)

        result_dict = {}
        temp_dict = {}
        invoice_num = ""
        patient_lastname = ""
        patient_firstname = ""
        CIN = ""
        dob = ""
        gender = ""
        service_date = ""
        eligible_code = ""
        payer_name = ""
        plan_code = ""
        address = ""
        # contact_name = ""
        contact_tel = ""
        covered_service_codes = []
        other_payer_name = []
        other_payer_address = []
        other_payer_policy_number = ""
        other_payer_telephone = []
        other_payer_group_number = []

        other_payer_name1 = ""
        other_payer_address1 = ""
        other_payer_telephone1 = ""
        other_payer_group_number1 = ""
        other_payer_name2 = ""
        other_payer_address2 = ""
        other_payer_telephone2 = ""
        other_payer_group_number2 = ""
        eligible_result = ""
        CD = ""


        for l in range(receipt_df.__len__()):
            row = receipt_df.ix[l, 1]

            if row[0] == 'BHT':
                invoice_num = row[3]

            elif row[0] == 'AAA' and row[1] == 'N':
                if row[3] == '15':
                    eligible_code = 'Required Application Data Missing'
                elif row[3] == '35':
                    eligible_code = 'Out of Network'
                elif row[3] == '42':
                    eligible_code = 'Unable to respond at current time'
                elif row[3] == '43':
                    eligible_code = 'Invalid/missing provider ID'
                elif row[3] == '45':
                    eligible_code = 'Invalid/missing provider specialty'
                elif row[3] == '47':
                    eligible_code = 'Invalid/missing provider state'
                elif row[3] == '48':
                    eligible_code = 'Invalid/missing referring provider ID number'
                elif row[3] == '49':
                    eligible_code = 'Provider is not primary care physician'
                elif row[3] == '51':
                    eligible_code = 'Provider not on file'
                elif row[3] == '52':
                    eligible_code = 'Service dates not within provider plan enrollment'
                elif row[3] == '56':
                    eligible_code = 'Inappropriate date'
                elif row[3] == '57':
                    eligible_code = 'Invalid/missing date of service'
                elif row[3] == '58':
                    eligible_code = 'Invalid/missing date of birth'
                elif row[3] == '60':
                    eligible_code = 'Date of birth follows date of service'
                elif row[3] == '61':
                    eligible_code = 'Date of death precedes date of service'
                elif row[3] == '62':
                    eligible_code = 'Date of service not within allowable inquiry period'
                elif row[3] == '63':
                    eligible_code = 'date of service in future'
                elif row[3] == '71':
                    eligible_code = 'Patient date of birth does not match patient in database'
                elif row[3] == '72':
                    eligible_code = 'Invalid/missing subscriber/insured ID'
                elif row[3] == '73':
                    eligible_code = 'Invalid/missing subscriber/insured name'
                elif row[3] == '74':
                    eligible_code = 'Invalid/missing subscriber/insured gender code'
                elif row[3] == '75':
                    eligible_code = 'Subscriber/insurer not found'
                elif row[3] == '76':
                    eligible_code = 'Duplicate subscriber/insurer ID number'
                elif row[3] == '78':
                    eligible_code = 'Subscriber/insured not in group/plan identified'
                else:
                    eligible_code = "AAA"


            elif row[0] == 'NM1' and row[1] == 'IL':
                patient_lastname, patient_firstname, CIN = row[3], row[4], row[9]

            elif row[0] == 'DMG' and row[1] == 'D8':
                dob = row[2]
                dob = datetime.strptime(dob, '%Y%m%d').date()
                gender = row[3]

            elif row[0] == 'DTP' and row[1] == '472':
                service_date = row[3]
                service_date = datetime.strptime(service_date, '%Y%m%d').date()

            elif (row[0] == 'EB' and row[1] == 'U' and row[2] == 'IND' and row[3] == '30') or \
                    (row[0] == 'EB' and row[1] == '1' and row[2] =='IND' and row[3] == '30') :
                eligible_code = row[5]

            elif row[0] == 'EB' and row[1] == '6':
                eligible_code = 'Inactive'

            elif row[0] == 'NM1' and row[1]=='Y2':
                payer_name = row[3]
                plan_code = row[9]

                address_row1 = receipt_df.ix[l+1, 1]  #N3
                address_row2 = receipt_df.ix[l+2, 1]  #N4
                contact_row = receipt_df.ix[l+3, 1]   #PER

                address = address_row1[1] + " " + address_row2[1] + " " + address_row2[2] + " " + address_row2[3]
                # contact_name = contact_row[2]
                contact_tel = contact_row[4]

            elif row[0] == 'NM1' and row[1] == 'P4':
                other_payer_name.append(row[3])
                try:
                    other_payer_group_number.append(row[9])
                except:
                    other_payer_group_number.append("")

                N3_row = receipt_df.ix[l+1, 1]
                N4_row = receipt_df.ix[l+2, 1]
                PER_row = receipt_df.ix[l+3, 1]

                if N3_row[0] == "N3" and N4_row[0] == "N4":
                    other_payer_address.append(N3_row[1] + " " + N4_row[1] + " " + N4_row[2] + " " + N4_row[3])
                    if PER_row[0] == 'PER' and PER_row[1] == 'IC':
                        other_payer_tel_tmp = PER_row[4]
                    else:
                        other_payer_tel_tmp = "0"

                    other_payer_telephone.append(other_payer_tel_tmp)
                else:
                    other_payer_address.append("")
                    other_payer_telephone.append("")

            elif row[0] == 'REF' and row[1] == '18':
                other_payer_policy_number = row[2]

            elif row[0] == 'EB' and row[1] == '1' and row[2] == 'IND':
                covered_service_codes.append(str(row[3]))

            elif row[0] == 'MSG':
                find_cnty = re.findall('CNTY', row[1])
                if find_cnty.__len__() != 0:
                    CD = row[1].split(" ")[1]
                    CD = int(re.findall(r'\d+', CD)[0])
                else:
                    pass

            if other_payer_name.__len__() == 1:
                other_payer_name1 = other_payer_name[0]
                other_payer_address1 = other_payer_address[0]
                other_payer_telephone1 = other_payer_telephone[0]
                other_payer_group_number1 = other_payer_group_number[0]

            if other_payer_name.__len__() == 2:
                other_payer_name2 = other_payer_name[1]
                other_payer_address2 = other_payer_address[1]
                other_payer_telephone2 = other_payer_telephone[1]
                other_payer_group_number2 = other_payer_group_number[1]

            temp_dict[str(invoice_num)] = {'Invoice number': invoice_num,
                                           'Patient lastname': patient_lastname,
                                           'Patient firstname': patient_firstname,
                                           'Patient DOB': dob,
                                           'Patient gender': gender,
                                           'CIN': CIN,
                                           'Service date': service_date,
                                           'Eligible': eligible_code,
                                           'Payer name': payer_name,
                                           'Payer address': address,
                                           # 'Contact name': contact_name,
                                           'Contact Tel.': contact_tel,
                                           'Plan code': plan_code,
                                           'Covered Codes': str(covered_service_codes),
                                           'CNTY': CD,

                                           'Other Payer1 name': other_payer_name1,
                                           'Other Payer1 address': other_payer_address1,
                                           'Other Payer1 tel.': other_payer_telephone1,
                                           'Other Payer1 group number': other_payer_group_number1,
                                           'Other Payer2 name': other_payer_name2,
                                           'Other Payer2 address': other_payer_address2,
                                           'Other Payer2 tel.': other_payer_telephone2,
                                           'Other Payer2 group number': other_payer_group_number2,
                                           'Other Payer policy number': other_payer_policy_number,
                                           }

            if row[0] == 'SE':   # section ends

                ifPlanCodeInDB = SQ.IfplancodeInDB(table='PlanCodeLib', plancode=plan_code)
                if ifPlanCodeInDB:
                    eligible_result = "OKAY"
                elif eligible_code in ["ELIGIBLE PCP", "Community Coverage w/CBLTC", "EP - Family Planning and Non Emerg Trans Only", 'MA Eligible',
                 'Eligible Only Outpatient Care', 'Community Coverage No LTC', 'Outpatient Coverage w/ CBLTC'] and ifPlanCodeInDB == False:
                    eligible_result = "OKAY"
                else:
                    eligible_result = 'PENDING'

                temp_dict[str(invoice_num)] = {'Invoice number': invoice_num,
                                               'Eligibility Result': eligible_result,
                                               'Patient lastname': patient_lastname,
                                               'Patient firstname': patient_firstname,
                                               'Patient DOB': dob,
                                               'Patient gender': gender,
                                               'CIN': CIN,
                                               'Service date': service_date,
                                               'Eligible': eligible_code,
                                               'Payer name': payer_name,
                                               'Payer address': address,
                                               # 'Contact name': contact_name,
                                               'Contact Tel.': contact_tel,
                                               'Plan code': plan_code,
                                               'Covered Codes': str(covered_service_codes),
                                               'CNTY': CD,

                                               'Other Payer1 name': other_payer_name1,
                                               'Other Payer1 address': other_payer_address1,
                                               'Other Payer1 tel.': other_payer_telephone1,
                                               'Other Payer1 group number': other_payer_group_number1,
                                               'Other Payer2 name': other_payer_name2,
                                               'Other Payer2 address': other_payer_address2,
                                               'Other Payer2 tel.': other_payer_telephone2,
                                               'Other Payer2 group number': other_payer_group_number2,
                                               'Other Payer policy number': other_payer_policy_number,
                                               }

                result_dict.update(temp_dict)
                # Reset var.
                invoice_num = ""
                patient_lastname = ""
                patient_firstname = ""
                CIN = ""
                dob = ""
                gender = ""
                service_date = ""
                eligible_code = ""
                payer_name = ""
                plan_code = ""
                address = ""
                # contact_name = ""
                contact_tel = ""
                other_payer_name1 = ""
                other_payer_address1 = ""
                other_payer_telephone1 = ""
                other_payer_group_number1 = ""
                other_payer_name2 = ""
                other_payer_address2 = ""
                other_payer_telephone2 = ""
                other_payer_group_number2 = ""

                other_payer_name = []
                other_payer_address = []
                other_payer_policy_number = ""
                eligible_result = ""
                other_payer_telephone = []
                other_payer_group_number = []
                CD = ""

                covered_service_codes = []
                temp_dict = {}

        result_dict.pop("")
        result_df = pd.DataFrame(result_dict)
        result_df = result_df.transpose()
        result_df = result_df[['Invoice number', 'Eligibility Result', 'CNTY', 'Service date', 'Patient firstname', 'Patient lastname', 'Plan code', 'Eligible', 'CIN', 'Covered Codes', 'Patient DOB', 'Patient gender',
                               'Payer name', 'Payer address', 'Contact Tel.', 'Other Payer1 name', 'Other Payer1 address', 'Other Payer1 tel.', 'Other Payer1 group number',
                               'Other Payer2 name', 'Other Payer2 address', 'Other Payer2 tel.', 'Other Payer2 group number', 'Other Payer policy number']]

        file_name_271 = str(datetime.today().date()) + str(datetime.now().time().strftime("%H%M%S"))

        current_path = os.getcwd()
        daily_folder = str(datetime.today().date())
        basename = info_locker.base_info['BaseName']
        file_saving_path = os.path.join(current_path, basename, daily_folder)
        if not os.path.exists(file_saving_path):
            os.makedirs(file_saving_path)
            print('Save files to {0}'.format(file_saving_path))
        result_df.to_excel(os.path.join(file_saving_path, '271-' + file_name_271 + '.xlsx'), index=False)
        return result_df

    @staticmethod
    def generate_276(receipt837_file, edi837_data, lined_file=True):
        df_837 = pd.read_csv(edi837_data) if edi837_data[-1] == 'v' else pd.read_excel(edi837_data)

        if lined_file==False:    # for raw receipt data
            receipt_df = pd.read_csv(receipt837_file, delimiter="~", header=None,)
            receipt_df = receipt_df.transpose()
            receipt_df.columns = ['line']
            receipt_df['line'] = receipt_df['line'].dropna()
        else:          # already split into lines
            receipt_df = pd.read_csv(receipt837_file)
            receipt_df.columns = ['line']

        receipt_df = receipt_df.dropna()
        receipt_df['line_sep'] = receipt_df['line'].apply(lambda x: x.split("*"))

        result_dict = {}
        temp_dict = {}

        invoice_num = ""
        patient_lastname = ""
        patient_firstname = ""
        CIN = ""
        claim_number = ""
        service_date = ""

        for l in range(receipt_df.__len__()):
            row = receipt_df.ix[l, 1]

            if row[0] == 'BHT':
                invoice_num = row[3]

            elif row[0] == 'NM1' and row[1] == 'QC' and row[2] == '1':
                patient_lastname = row[3]
                patient_firstname = row[4]
                CIN = row[9]

            elif row[0] == 'REF' and row[1] == '1K':
                claim_number = row[2]

            elif row[0] == 'DTP' and row[1] == '472':
                service_date = row[3]

            temp_dict[str(invoice_num)] = {
                'INVOICE NUMBER': invoice_num,
                'CLIENT LAST NAME': patient_lastname,
                'CLIENT FIRST NAME': patient_firstname,
                'MEDICAID ID NUMBER': CIN,
                'CLAIM CONTROL NUMBER': claim_number,
                'SVC DATE': service_date,
            }

            if row[0] == 'SE':   # section ends
                idx_837 = df_837.loc[df_837['invoice number'] == int(invoice_num)].index.tolist()

                if idx_837.__len__() == 0:
                    patient_dob = "00001225"
                    patient_gender = "M"
                else:
                    patient_dob = df_837.ix[idx_837[0], 'patient dob']
                    patient_dob = datetime.strptime(str(patient_dob), '%m/%d/%Y').strftime('%Y%m%d')
                    patient_gender = df_837.ix[idx_837[0], 'patient gender']

                temp_dict[str(invoice_num)] = {
                    'INVOICE NUMBER': invoice_num,
                    'CLIENT LAST NAME': patient_lastname,
                    'CLIENT FIRST NAME': patient_firstname,
                    'MEDICAID ID NUMBER': CIN,
                    'CLAIM CONTROL NUMBER': claim_number,
                    'SVC DATE': service_date,
                    'GENDER': patient_gender,
                    'DOB': patient_dob
                }

                result_dict.update(temp_dict)
                invoice_num = ""
                patient_lastname = ""
                patient_firstname = ""
                CIN = ""
                claim_number = ""
                service_date = ""

        result_dict.pop("")
        result_df = pd.DataFrame(result_dict)
        result_df = result_df.transpose()
        result_df = result_df[['INVOICE NUMBER', 'DOB', 'GENDER', 'CLIENT LAST NAME',
                               'CLIENT FIRST NAME', 'MEDICAID ID NUMBER', 'CLAIM CONTROL NUMBER', 'SVC DATE']]

        current_path = os.getcwd()
        daily_folder = str(datetime.today().date())
        basename = info_locker.base_info['BaseName']
        file_saving_path = os.path.join(current_path, basename, daily_folder)
        if not os.path.exists(file_saving_path):
            os.makedirs(file_saving_path)
            print('Save files to {0}'.format(file_saving_path))

        result_df.to_excel(os.path.join(file_saving_path,'276-data-' + str(datetime.today().date()) + '.xlsx'), index=False)
        # 276 data is ready and output an excel file to show 276 data
        # To generate edi 276 file now

        edi = EDI276(result_df)
        stream_276_data = edi.ISA_IEA()
        filename = edi.file_name
        Process_Method().write_txt(stream_276_data, os.path.join(file_saving_path, filename))
        return

    @staticmethod
    def process_276_receipt(receipt_file, edi837=None, lined_file=True):
        if lined_file==False:    # for raw receipt data
            receipt_df = pd.read_csv(receipt_file, delimiter="~", header=None,)
            receipt_df = receipt_df.transpose()
            receipt_df.columns = ['line']
            receipt_df['line'] = receipt_df['line'].dropna().apply(lambda x: x)
        else:          # already split into lines
            receipt_df = pd.read_csv(receipt_file)
            receipt_df.columns = ['line']

        receipt_df = receipt_df.dropna()
        receipt_df['line_sep'] = receipt_df['line'].apply(lambda x: x.split("*"))

        if edi837:
            edi837_df = pd.read_excel(edi837)
            edi837_df['invoice number'] = edi837_df['invoice number'].astype(str)

        result_dict = {}
        temp_dict = {}

        invoice_num = ""
        patient_lastname = ""
        patient_firstname = ""
        CIN = ""
        total_expected_amt = ""
        total_paid_amt = ""
        claim_ctrl_num = ""
        service_date = ""
        encode_expected_list = [0, 0, 0, 0, 0, 0]
        encode_paid_list = [0, 0, 0, 0, 0, 0]
        error_codes = []
        result = ''
        status_code = ""
        status_code2 = ""

        for l in range(receipt_df.__len__()):
            row = receipt_df.ix[l, 1]

            if row[0] == 'BHT':
                invoice_num = row[3]

            elif row[0] == 'NM1' and row[1] == 'IL' and row[2] == '1':
                patient_lastname = row[3]
                patient_firstname = row[4]
                CIN = row[9]

            elif row[0] == 'TRN' and row[1] == '2':
                next_row = receipt_df.ix[l+1, 1]
                total_expected_amt = float(next_row[4])
                total_paid_amt = float(next_row[5])
                status_code = next_row[1]

                if status_code == 'F2:54':
                    description_status_code = ' -Duplicated Claim'
                elif status_code == 'F2:562':
                    description_status_code = ' -Wrong NPI'
                elif status_code == 'D0:21':
                    description_status_code = ' -Missing or invalid info'
                # elif status_code == 'F2:84':
                #     description_status_code = ' -Service Not Authorized'
                else:
                    description_status_code = ""

                if (abs(total_expected_amt - total_paid_amt) <= 0.02) and (total_expected_amt != 0):
                    result = 'Paid'
                elif total_paid_amt == 0:
                    if total_expected_amt == 0:
                        result = 'Error' + description_status_code
                    else:
                        result = 'Denied' + description_status_code
                else:
                    result = 'Partial Paid'


            elif row[0] == 'REF' and row[1] == '1K':
                claim_ctrl_num = row[2]

            elif row[0] == 'DTP' and row[1] == '472' and row[2] == 'RD8':
                service_date = row[3]

            elif row[0] == 'SVC' and row[1] == 'HC:A0100':
                encode_expected_list[0] = float(row[2])
                encode_paid_list[0] = float(row[3])
                if encode_expected_list[0] != encode_paid_list[0]:
                    error_codes.append('A0100')

                next_row = receipt_df.ix[l + 1, 1]
                status_code2 = next_row[1]
                if status_code2 == 'P0:252':
                    description_status_code = ' -No PA Number'
                elif status_code2 == 'F2:54':
                    description_status_code = ' -Duplicated Claim'
                elif status_code2 == 'F2:84':
                    description_status_code = ' -Service Not Authorized'
                elif status_code2 == 'F2:483':
                    description_status_code = ' - MAS Codes Wrong'
                elif status_code2 == 'F2:109:DK' and next_row[10] == "F2:562:DN":
                    description_status_code = ' -Wrong NPI'
                else:
                    description_status_code = ""

                result = result + description_status_code

            elif row[0] == 'SVC' and row[1] == 'HC:A0100:TN':
                encode_expected_list[1] = float(row[2])
                encode_paid_list[1] = float(row[3])
                if encode_expected_list[1] != encode_paid_list[1]:
                    error_codes.append('A0100TN')

                next_row = receipt_df.ix[l + 1, 1]
                status_code2 = next_row[1]
                if status_code2 == 'P0:252':
                    description_status_code = ' -No PA Number'
                elif status_code2 == 'F2:54':
                    description_status_code = ' -Duplicated Claim'
                elif status_code2 == 'F2:84':
                    description_status_code = ' -Service Not Authorized'
                elif status_code2 == 'F2:483':
                    description_status_code = ' - MAS Codes Wrong'
                elif status_code2 == 'F2:109:DK' and next_row[10] == "F2:562:DN":
                    description_status_code = ' -Wrong NPI'
                else:
                    description_status_code = ""

                result = result + description_status_code

            elif row[0] == 'SVC' and row[1] == 'HC:S0215':
                encode_expected_list[2] = float(row[2])
                encode_paid_list[2] = float(row[3])
                if abs(encode_expected_list[2] - encode_paid_list[2]) > 0.02:
                    error_codes.append('S0215')

                next_row = receipt_df.ix[l + 1, 1]
                status_code2 = next_row[1]
                if status_code2 == 'P0:252':
                    description_status_code = ' -No PA Number'
                elif status_code2 == 'F2:54':
                    description_status_code = ' -Duplicated Claim'
                elif status_code2 == 'F2:84':
                    description_status_code = ' -Service Not Authorized'
                elif status_code2 == 'F2:483':
                    description_status_code = ' - MAS Codes Wrong'
                elif status_code2 == 'F2:109:DK' and next_row[10] == "F2:562:DN":
                    description_status_code = ' -Wrong NPI'
                else:
                    description_status_code = ""

                result = result + description_status_code

            elif row[0] == 'SVC' and row[1] == 'HC:S0215:TN':
                encode_expected_list[3] = float(row[2])
                encode_paid_list[3] = float(row[3])
                if encode_expected_list[3] != encode_paid_list[3]:
                    error_codes.append('S0215TN')

                next_row = receipt_df.ix[l + 1, 1]
                status_code2 = next_row[1]
                if status_code2 == 'P0:252':
                    description_status_code = ' -No PA Number'
                elif status_code2 == 'F2:54':
                    description_status_code = ' -Duplicated Claim'
                elif status_code2 == 'F2:84':
                    description_status_code = ' -Service Not Authorized'
                elif status_code2 == 'F2:483':
                    description_status_code = ' - MAS Codes Wrong'
                elif status_code2 == 'F2:109:DK' and next_row[10] == "F2:562:DN":
                    description_status_code = ' -Wrong NPI'
                else:
                    description_status_code = ""

                result = result + description_status_code

            elif row[0] == 'SVC' and row[1] == 'HC:A0100:SC':
                encode_expected_list[4] = float(row[2])
                encode_paid_list[4] = float(row[3])
                if encode_expected_list[4] != encode_paid_list[4]:
                    error_codes.append('A0100SC')

                next_row = receipt_df.ix[l + 1, 1]
                status_code2 = next_row[1]
                if status_code2 == 'P0:252':
                    description_status_code = ' -No PA Number'
                elif status_code2 == 'F2:54':
                    description_status_code = ' -Duplicated Claim'
                elif status_code2 == 'F2:84':
                    description_status_code = ' -Service Not Authorized'
                elif status_code2 == 'F2:483':
                    description_status_code = ' - MAS Codes Wrong'
                elif status_code2 == 'F2:109:DK' and next_row[10] == "F2:562:DN":
                    description_status_code = ' -Wrong NPI'
                else:
                    description_status_code = ""

                result = result + description_status_code

            elif row[0] == 'SVC' and row[1] == 'HC:A0170:CG':
                encode_expected_list[5] = float(row[2])
                encode_paid_list[5] = float(row[3])
                if encode_expected_list[5] != encode_paid_list[5]:
                    error_codes.append('A0170CG')

                next_row = receipt_df.ix[l + 1, 1]
                status_code2 = next_row[1]
                if status_code2 == 'P0:252':
                    description_status_code = ' -No PA Number'
                elif status_code2 == 'F2:54':
                    description_status_code = ' -Duplicated Claim'
                elif status_code2 == 'F2:84':
                    description_status_code = ' -Service Not Authorized'
                elif status_code2 == 'F2:483':
                    description_status_code = ' - MAS Codes Wrong'
                elif status_code2 == 'F2:109:DK' and next_row[10] == "F2:562:DN":
                    description_status_code = ' -Wrong NPI'
                else:
                    description_status_code = ""

                result = result + description_status_code

            if row[0] == 'SE': # section ends

                if error_codes.__len__() != 0:
                    result = result + "(Wrong Codes: {0})".format(",".join(error_codes))

                if edi837:
                    # print(invoice_num)
                    npi_temp = edi837_df.loc[edi837_df['invoice number'] == invoice_num, 'service npi'].tolist()
                    NPI = int(npi_temp[0]) if len(npi_temp) != 0 else ""
                    # print(NPI)

                    driverid_temp = edi837_df.loc[edi837_df['invoice number'] == invoice_num, 'driver license number'].tolist()
                    Driver_id = int(driverid_temp[0]) if len(driverid_temp) != 0 else ""

                    vehicleid_temp = edi837_df.loc[edi837_df['invoice number'] == invoice_num, 'driver plate number'].tolist()
                    Vehicle_id = vehicleid_temp[0] if len(vehicleid_temp) != 0 else ""

                    claim_amount_temp = edi837_df.loc[edi837_df['invoice number'] == invoice_num, 'claim_amount'].tolist()
                    claim_amount = float(claim_amount_temp[0]) if len(claim_amount_temp) != 0 else 0

                    if total_paid_amt >= claim_amount:
                        result = ""

                    temp_dict[str(invoice_num)] = {
                        'Invoice Number': invoice_num,
                        'Patient Lastname': patient_lastname,
                        'Patient Firstname': patient_firstname,
                        'CIN': CIN,
                        'Claim Ctrl Number': claim_ctrl_num,
                        'P1 Total Expected Amt': claim_amount,
                        'P2 Total Expected Amt': total_expected_amt,
                        'Total Paid Amt': total_paid_amt,
                        'Service Date': service_date,
                        'Encoded Expected Amt': encode_expected_list,
                        'Encoded Paid Amt': encode_paid_list,
                        'Result': result,
                        'NPI': NPI,
                        'DRIVER ID': Driver_id,
                        'VEHICLE ID': Vehicle_id}


                else:
                    temp_dict[str(invoice_num)] = {
                        'Invoice Number': invoice_num,
                        'Patient Lastname': patient_lastname,
                        'Patient Firstname': patient_firstname,
                        'CIN': CIN,
                        'Claim Ctrl Number': claim_ctrl_num,
                        'Total Expected Amt': total_expected_amt,
                        'Total Paid Amt': total_paid_amt,
                        'Service Date': service_date,
                        'Encoded Expected Amt': encode_expected_list,
                        'Encoded Paid Amt': encode_paid_list,
                        'Result': result,
                    }


                result_dict.update(temp_dict)

                #reset var.
                invoice_num = ""
                patient_lastname = ""
                patient_firstname = ""
                CIN = ""
                total_expected_amt = ""
                total_paid_amt = ""
                claim_ctrl_num = ""
                service_date = ""
                encode_expected_list = [0, 0, 0, 0, 0, 0]
                encode_paid_list = [0, 0, 0, 0, 0, 0]
                error_codes = []
                result = ''
                status_code = ""
                status_code2 = ""

        # result_dict.pop("")
        result_df = pd.DataFrame(result_dict)
        result_df = result_df.transpose()
        if edi837:
            result_df = result_df[['Invoice Number', 'Result', 'P1 Total Expected Amt', 'P2 Total Expected Amt', 'Total Paid Amt', 'Encoded Expected Amt', 'Encoded Paid Amt',
                               'Patient Lastname', 'Patient Firstname', 'CIN', 'Claim Ctrl Number', 'Service Date', 'NPI', 'DRIVER ID', 'VEHICLE ID']]
        else:
            result_df = result_df[
                ['Invoice Number', 'Result', 'Total Expected Amt', 'Total Paid Amt', 'Encoded Expected Amt',
                 'Encoded Paid Amt',
                 'Patient Lastname', 'Patient Firstname', 'CIN', 'Claim Ctrl Number', 'Service Date']]

        file_name_276277 = str(datetime.today().date()) + str(datetime.now().time().strftime("%H%M%S"))

        current_path = os.getcwd()
        daily_folder = str(datetime.today().date())
        basename = info_locker.base_info['BaseName']
        file_saving_path = os.path.join(current_path, basename, daily_folder)
        if not os.path.exists(file_saving_path):
            os.makedirs(file_saving_path)
            print('Save files to {0}'.format(file_saving_path))

        result_df.to_excel(os.path.join(file_saving_path, '276-277-' + file_name_276277 + '.xlsx'), index=False)

    @staticmethod
    def generate_270(mas_raw_file):
        raw_df = pd.read_table(mas_raw_file) if mas_raw_file[-1] == 't' else pd.read_csv(mas_raw_file)
        raw_df['Pick-up Address'] = raw_df['Pick-up Address'].apply(lambda x: Process_Method.clean_address(x))
        raw_df['Drop-off Address'] = raw_df['Drop-off Address'].apply(lambda x: Process_Method.clean_address(x))

        result_df = pd.DataFrame()
        unique_invoice = raw_df["Invoice Number"].unique().tolist()
        invoice_number_list = []
        service_name = []
        service_npi = []
        client_lastname = []
        client_firstname = []
        CIN = []
        gender = []
        dob = []
        service_date = []

        for invoice_number in unique_invoice:
            idx = raw_df.loc[
                (raw_df['Invoice Number'] == invoice_number) & (raw_df['Record Type'] == 'Leg')].index.tolist()

            invoice_number_list.append(invoice_number)
            service_name.append(raw_df.ix[idx[0], 'Medical Provider'].upper())
            service_npi.append(int(raw_df.ix[idx[0], 'Ordering Provider ID']))
            client_lastname.append(raw_df.ix[idx[0], 'Last Name'].upper())
            client_firstname.append(raw_df.ix[idx[0], 'First Name'].upper())
            CIN.append(raw_df.ix[idx[0], 'CIN'])
            gender.append(raw_df.ix[idx[0], 'Gender'])
            dob.append(raw_df.ix[idx[0], 'Birthdate'])
            service_date.append(raw_df.ix[idx[0], 'Service Starts'])

        result_df['INVOICE NUMBER'] = invoice_number_list
        result_df['SVC NAME'] = service_name
        result_df['SVC NPI'] = service_npi
        result_df['CLIENT LAST NAME'] = client_lastname
        result_df['CLIENT FIRST NAME'] = client_firstname
        result_df['MEDICAID ID NUMBER'] = CIN
        result_df['GENDER'] = gender
        result_df['DOB'] = dob
        result_df['SVC DATE'] = service_date

        current_path = os.getcwd()
        daily_folder = str(datetime.today().date())
        basename = info_locker.base_info['BaseName']
        file_saving_path = os.path.join(current_path, basename, daily_folder)
        if not os.path.exists(file_saving_path):
            os.makedirs(file_saving_path)
            print('Save files to {0}'.format(file_saving_path))

        result_df.to_excel(os.path.join(file_saving_path,'270-data-' + str(datetime.today().date()) + str(datetime.now().time().strftime('%H%M%S')) + '.xlsx'), index=False)
        # 270 data is ready and output an excel file to show 270 data
        # to generate edi 270 file now

        edi = EDI270(result_df)
        stream_270_data = edi.ISA_IEA()
        filename = edi.file_name

        Process_Method().write_txt(stream_270_data, os.path.join(file_saving_path, filename))
        # Process_Method().transfer2lines(filename)

        return

    @staticmethod
    def generate_837(data, replace_switch):
        edi = EDI837P(data, replace_switch)
        stream_837data = edi.ISA_IEA()
        filename = edi.file_name + '.txt'

        current_path = os.getcwd()
        daily_folder = str(datetime.today().date())
        basename = info_locker.base_info['BaseName']
        file_saving_path = os.path.join(current_path, basename, daily_folder)
        if not os.path.exists(file_saving_path):
            os.makedirs(file_saving_path)
            print('Save files to {0}'.format(file_saving_path))
        Process_Method().write_txt(stream_837data, os.path.join(file_saving_path, filename))

        return

    @staticmethod
    def mas_signoff(mas_raw_data, total_job):   # use MAS raw data and total jobs file to generate Processed MAS file and sign-off
        processed_mas_df = Process_MAS(mas_raw_data).add_codes(tofile=True)
        # this step will output an excel and return a pandas dataframe for further processing

        S = SignoffAndCompare()
        S.sign_off(processed_mas_df, total_job, tofile=True)

    @staticmethod
    def transfer2Excel(input_file):
        df = pd.read_csv(input_file)
        df.to_excel(f'{input_file}_EXCEL.xlsx', index=False)

    @staticmethod
    def process_835(receipt_file, lined_file=True):
        if lined_file==False:    # for raw receipt data
            receipt_df = pd.read_csv(receipt_file, delimiter="~", header=None,)
            receipt_df = receipt_df.transpose()
            receipt_df.columns = ['line']
            receipt_df['line'] = receipt_df['line'].dropna()
        else:          # already split into lines
            receipt_df = pd.read_csv(receipt_file)
            receipt_df.columns = ['line']

        receipt_df = receipt_df.dropna()
        receipt_df['line_sep'] = receipt_df['line'].apply(lambda x: x.split("*"))

        clp_idx = [l for l in range(receipt_df.__len__()) if receipt_df.ix[l, 1][0] == 'CLP'] + [receipt_df.__len__()]

        invoice_number = []
        expect_amount = []
        paid_amount = []
        claim_number = []
        patient_ln = []
        patient_fn = []
        patient_medicaid = []
        service_date = []

        all_codes = []

        for i in range(0, len(clp_idx)-1):
            code = []

            for r in range(clp_idx[i], clp_idx[i+1]):
                row = receipt_df.ix[r, 1]
                if row[0] == "CLP":
                    invoice_number.append(row[1])
                    expect_amount.append(float(row[3]))
                    paid_amount.append(float(row[4]))
                    claim_number.append(row[7])

                elif row[0] == "NM1" and row[1] == "QC":
                    patient_ln.append(row[3])
                    patient_fn.append(row[4])
                    patient_medicaid.append(row[9])

                elif row[0] == 'DTM' and row[1] == "232":
                    service_date.append(arrow.get(row[2], 'YYYYMMDD').format('MM/DD/YYYY'))

                elif row[0] == 'SVC':
                    code.append(row[1][3:])

            all_codes.append(code)

        # print(invoice_number.__len__(), all_codes.__len__())
        result = pd.DataFrame()
        result['Invoice Number'] = invoice_number
        result['Claim Number'] = claim_number
        result['Expected Amount'] = expect_amount
        result['Paid Amount'] = paid_amount
        result['Patient Firstname'] = patient_fn
        result['Patient Lastname'] = patient_ln
        result['Patient Medicaid'] = patient_medicaid
        result['Service Date'] = service_date
        result['Code'] = all_codes

        last_line = len(result) + 1
        result.ix[last_line, 'Claim Number'] = 'Total:'
        result.ix[last_line, 'Expected Amount'] = sum(expect_amount)
        result.ix[last_line, 'Paid Amount'] = sum(paid_amount)
        result.ix[last_line, 'Patient Firstname'] = abs(result.ix[last_line, 'Expected Amount'] - result.ix[last_line, 'Paid Amount'])

        file_name_835= str(arrow.get().date()) + str(datetime.now().time().strftime("%H%M%S"))

        current_path = os.getcwd()
        daily_folder = str(datetime.today().date())
        basename = info_locker.base_info['BaseName']
        file_saving_path = os.path.join(current_path, basename, daily_folder)
        if not os.path.exists(file_saving_path):
            os.makedirs(file_saving_path)
            print('Save files to {0}'.format(file_saving_path))

        result.to_excel(os.path.join(file_saving_path, '835-Decoding-' + file_name_835 + '.xlsx'), index=False)


class window(QMainWindow):

    def __init__(self):
        super(window, self).__init__()
        self.setGeometry(500, 500, 480, 280)
        self.setWindowTitle('EDI')

        plancode_lib = QAction('PlanCode Lib', self)
        plancode_lib.triggered.connect(self.open_plancode_subwindow)

        process_txt = QAction('Process .TXT', self)
        process_txt.triggered.connect(self.process_TXT)

        add_base = QAction('New Base', self)
        add_base.triggered.connect(self.AddNewBase)

        add_driver = QAction('New Driver', self)
        add_driver.triggered.connect(self.AddNewDriver)

        mainMenu = self.menuBar()
        tool = mainMenu.addMenu('&Tools')
        tool.addAction(plancode_lib)
        tool.addAction(process_txt)
        tool.addAction(add_base)
        tool.addAction(add_driver)

        SQ = mysqlite('EDI.db')
        base_df = pd.read_sql("SELECT * FROM AllBases", con=SQ.conn)
        dict_base_df = base_df.to_dict('list')
        self.only_basenames = dict_base_df['BaseName']

        self.home()

    def home(self):
        btn837 = QPushButton('Operr Claim', self)
        btn837.clicked.connect(self.open_837_subwindow)
        btn837.resize(140, 40)
        btn837.move(50, 20)

        nameLabel1 = QLabel('Base:', self)
        self.base_combobox = QComboBox(self)
        self.base_combobox.addItem('')
        for base_name in self.only_basenames:
            self.base_combobox.addItem(base_name)
        # self.base_combobox.addItem('Clean Air Base')
        nameLabel1.move(280, 35)
        self.base_combobox.move(320, 25)
        self.base_combobox.resize(140, 40)
        self.base_combobox.activated[str].connect(self.Select_base_and_save_info)

        btn270_271 = QPushButton('Eligibility Checking', self)
        btn270_271.clicked.connect(self.open_270_271_subwindow)
        btn270_271.resize(140, 40)
        btn270_271.move(50, 80)

        btn276_277 = QPushButton('Payment Check', self)
        btn276_277.clicked.connect(self.open_276_277_subwindow)
        btn276_277.resize(140, 40)
        btn276_277.move(50, 140)

        btnMAS = QPushButton('MAS Billing', self)
        btnMAS.clicked.connect(self.open_MAS_subwindow)
        btnMAS.resize(140, 40)
        btnMAS.move(50, 200)

        btnQuit = QPushButton('Close', self)
        btnQuit.clicked.connect(self.close_application)
        btnQuit.resize(100, 40)
        btnQuit.move(380, 230)


        _versionLabel = QLabel(_version, self)
        _versionLabel.move(10, 250)

        self.show()

    def close_application(self):
        choice = QMessageBox.question(self, 'Message',
                                     "Are you sure to quit?", QMessageBox.Yes |
                                     QMessageBox.No, QMessageBox.No)

        if choice == QMessageBox.Yes:
            sys.exit()
        else:
            pass

    def open_837_subwindow(self):
        if not info_locker.base_info:
            QMessageBox.about(self, 'Message', 'Select Base first!')
        else:
            self.new_837_window = subwindow_837()
            self.new_837_window.show()

    def open_270_271_subwindow(self):
        SQ = mysqlite('EDI.db')
        SQ.delete_lastmonth_manually271Lib(table='ManuallyCheck271')

        if not info_locker.base_info:
            QMessageBox.about(self, 'Message', 'Select Base first!')
        else:
            self.new_270_271_window = subwindow_270_271()
            self.new_270_271_window.show()

    def open_276_277_subwindow(self):
        if not info_locker.base_info:
            QMessageBox.about(self, 'Message', 'Select Base first!')
        else:
            self.new_276_277_window = subwindow_276_277()
            self.new_276_277_window.show()

    def open_MAS_subwindow(self):
        if not info_locker.base_info:
            QMessageBox.about(self, 'Message', 'Select Base first!')
        else:
            self.new_mas_window = subwindow_MAS()
            self.new_mas_window.show()

    def open_plancode_subwindow(self):
        self.new_plancode_window = subwindow_plancode()
        self.new_plancode_window.show()

    def process_TXT(self):
        self.new_processTXT_window = subwindow_processTXT()
        self.new_processTXT_window.show()

    def AddNewBase(self):
        self.addnewbase = subwindow_addbase()
        self.addnewbase.show()

    def Select_base_and_save_info(self, text):
        # print(text)
        SQ = mysqlite('EDI.db')
        base_df = pd.read_sql("SELECT * FROM AllBases WHERE BaseName='{0}'".format(text), con=SQ.conn)
        dict_base_df = base_df.to_dict('records')
        info_locker.base_info = dict_base_df[0] if dict_base_df else None

        driver_df = pd.read_sql("SELECT * FROM driver_info WHERE Base='{0}'".format(text), con=SQ.conn)
        driver_df.set_index(['Fleet'], inplace=True)
        dict_driver_df = driver_df.to_dict('index')
        info_locker.driver_information = dict_driver_df if dict_driver_df else None

    def AddNewDriver(self):
        self.addnewdriver = subwindow_addDriver()
        self.addnewdriver.show()


class subwindow_837(QMainWindow):
    class My837TabWidget(QTabWidget):

        def __init__(self, parent):
            super(QWidget, self).__init__(parent)
            self.layout = QGridLayout(self)
            self.file_name1 = None
            self.tabs = QTabWidget()
            self.tab1 = QWidget()

            self.tabs.addTab(self.tab1, '-*Claim*-')

            self.replace_switch = False
            self.mytab1()

            self.layout.addWidget(self.tabs)
            self.setLayout(self.layout)

        def mytab1(self):
            self.tab1.layout = QGridLayout()
            nameLabel1 = QLabel('Data Claims P2:')
            self.textbox1 = QLineEdit()
            btnSelect1 = QPushButton('...')
            btnSelect1.clicked.connect(self.select_file1)
            btnRun1 = QPushButton('Run')
            btnRun1.clicked.connect(self.generate_837)
            self.checkbox = QCheckBox('Replace Claims', self)
            self.checkbox.stateChanged.connect(self.switchToReplace)
            # btnQuit1 = QPushButton('Quit')
            # btnQuit1.clicked.connect(self.close_application)

            self.tab1.layout.addWidget(nameLabel1, 0, 0)
            self.tab1.layout.addWidget(self.textbox1, 0, 1)
            self.tab1.layout.addWidget(btnSelect1, 0, 2)
            self.tab1.layout.addWidget(btnRun1, 0, 3)
            # self.tab1.layout.addWidget(btnQuit1, 3, 0)
            self.tab1.layout.addWidget(self.checkbox, 3, 0)
            self.tab1.setLayout(self.tab1.layout)

        def select_file1(self):
            self.file_name1, _ = QFileDialog.getOpenFileName(self, 'Open File', options=QFileDialog.DontUseNativeDialog)
            self.textbox1.setText(self.file_name1)

        def close_application(self):
            choice = QMessageBox.question(self, 'Message',
                                          "Are you sure to quit?", QMessageBox.Yes |
                                          QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                sys.exit()
            else:
                pass

        def generate_837(self):
            choice = QMessageBox.question(self, 'Message', 'Are you sure to generate 837P?',
                                          QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:

                if not self.file_name1:
                    QMessageBox.about(self, 'Message', 'Error!')

                else:
                    if not info_locker.base_info:
                        QMessageBox.about(self, 'Message', 'Select Base first!')

                    else:
                        P = Process_Method()
                        P.generate_837(self.file_name1, self.replace_switch)

                        QMessageBox.about(self, 'Message', 'File generated successfully!')
            else:
                pass

        def switchToReplace(self, state):
            if state == Qt.Checked:
                self.replace_switch = True
            else:
                self.replace_switch = False

    def __init__(self):
        super(subwindow_837, self).__init__()
        self.setGeometry(600, 600, 600, 380)
        self.setWindowTitle('Operr Claims')
        # pprint(info_locker.base_info['BaseName'])
        self.home()

    def home(self):
        self.table_widget = self.My837TabWidget(self)
        self.setCentralWidget(self.table_widget)


class subwindow_270_271(QMainWindow):
    class My270_271TabWidget(QTabWidget):

        def __init__(self, parent):
            super(QWidget, self).__init__(parent)
            self.layout = QGridLayout(self)

            self.file_name2_1 = None
            self.file_name3_1 = None
            self.file_name6_1 = None
            self.file_name6_2 = None
            self.file_name6_3 = None
            self.df = pd.DataFrame()

            self.tabs = QTabWidget()
            self.tab2 = QWidget()
            self.tab3 = QWidget()

            self.tabs.addTab(self.tab2, '-*Upload File*-')
            self.tabs.addTab(self.tab3, '-*Eligible Result*-')

            self.mytab2()
            self.mytab3()

            self.layout.addWidget(self.tabs)
            self.setLayout(self.layout)

        def mytab2(self):
            self.tab2.layout = QGridLayout()
            nameLabel1 = QLabel('MAS Raw File:')
            self.textboxTab2_1 = QLineEdit()
            btnSelectTab2_1 = QPushButton('...')
            btnSelectTab2_1.clicked.connect(self.select_fileTab2_1)
            btnRunTab2_1 = QPushButton('Run')
            btnRunTab2_1.clicked.connect(self.generate_270)
            btnQuit2 = QPushButton('Quit')
            btnQuit2.clicked.connect(self.close_application)

            self.tab2.layout.addWidget(nameLabel1, 0, 0)
            self.tab2.layout.addWidget(self.textboxTab2_1, 0, 1)
            self.tab2.layout.addWidget(btnSelectTab2_1, 0, 2)
            self.tab2.layout.addWidget(btnRunTab2_1, 0, 3)
            # self.tab2.layout.addWidget(btnQuit2, 3, 0)
            self.tab2.setLayout(self.tab2.layout)

        def mytab3(self):
            self.tab3.layout = QGridLayout()
            nameLabel1 = QLabel('Operr 10001:')
            self.textboxTab3_1 = QLineEdit()
            btnSelectTab3_1 = QPushButton('...')
            btnSelectTab3_1.clicked.connect(self.select_fileTab3_1)
            btnRunTab3 = QPushButton('Run')
            btnRunTab3.clicked.connect(self.process_271)
            btnQuit3 = QPushButton('Quit')
            btnManualCheck = QPushButton('Manual Check')
            btnManualCheck.clicked.connect(self.showManually271Lib)
            # btnQuit3.clicked.connect(self.close_application)
            btnShowData = QPushButton('Display Data')
            btnShowData.clicked.connect(self.switchToShow)

            # btnShowPendingData = QPushButton('Display the Pendings')
            # btnShowPendingData.clicked.connect(self.switchToShowPending)

            self.tab3.layout.addWidget(nameLabel1, 0, 0)
            self.tab3.layout.addWidget(self.textboxTab3_1, 0, 1)
            self.tab3.layout.addWidget(btnSelectTab3_1, 0, 2)
            self.tab3.layout.addWidget(btnShowData, 1, 3)
            self.tab3.layout.addWidget(btnManualCheck, 1, 0)
            self.tab3.layout.addWidget(btnRunTab3, 0, 3)
            # self.tab3.layout.addWidget(btnQuit3, 3, 0)
            self.tab3.setLayout(self.tab3.layout)

        def select_fileTab2_1(self):
            self.file_name2_1, _ = QFileDialog.getOpenFileName(self, 'Open File',
                                                               options=QFileDialog.DontUseNativeDialog)
            self.textboxTab2_1.setText(self.file_name2_1)

        def select_fileTab3_1(self):
            self.file_name3_1, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                               options=QFileDialog.DontUseNativeDialog)
            self.textboxTab3_1.setText(self.file_name3_1)

        def close_application(self):
            choice = QMessageBox.question(self, 'Message',
                                          "Are you sure to quit?", QMessageBox.Yes |
                                          QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                sys.exit()
            else:
                pass

        def generate_270(self):
            choice = QMessageBox.question(self, 'Message', 'Are you sure to generate EDI 270?',
                                          QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                if not self.file_name2_1:
                    QMessageBox.about(self, 'Message', 'Error!')

                else:

                    P = Process_Method()
                    P.generate_270(self.file_name2_1)
                    QMessageBox.about(self, 'Message', 'File generated successfully!')

            else:
                pass

        def create_table(self, data):
            self.tableWidget = QTableWidget(self)
            countRow = data.__len__()
            countCol = data.shape[1]
            headers = data.columns.tolist()
            self.tableWidget.setRowCount(countRow)
            self.tableWidget.setColumnCount(countCol)
            for r in range(countRow):
                for c in range(countCol):
                    self.tableWidget.setItem(r, c, QTableWidgetItem(str(data.ix[r, c])))

            self.tableWidget.setHorizontalHeaderLabels(headers)
            self.tableWidget.resizeColumnsToContents()
            self.tableWidget.resizeRowsToContents()
            self.tableWidget.move(0, 0)

            self.layout.addWidget(self.tableWidget)
            self.tab4.setLayout(self.tab4.layout)
            self.show()

        def switchToShow(self):

            if self.df.__len__() == 0:
                QMessageBox.about(self, 'Message', 'Process Data First!')
            else:
                # self.create_table(self.df)
                self.sub_win = EDI270data_subwindow(self.df)
                self.sub_win.show()

        def process_271(self):
            choice = QMessageBox.question(self, 'Message', 'Are you sure to process EDI 271?',
                                          QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                if not self.file_name3_1:
                    QMessageBox.about(self, 'Message', 'Error!')
                else:
                    P = Process_Method()
                    SQ = mysqlite('EDI.db')
                    self.df = P.process_270_receipt(self.file_name3_1, lined_file=False)
                    SQ.upsert271(table='Eligibility271', data=self.df)
                    self.pendingFromdf = self.df.loc[self.df['Eligibility Result'] == 'PENDING']
                    self.pendingFromdf_cinList = self.pendingFromdf['CIN'].tolist()

                    self.manual_df = SQ.generate_excel_from_manually271Lib(table='ManuallyCheck271', tofile=False)
                    self.eligibleFrom_manual_df_cinList = self.manual_df.loc[self.manual_df['Eligible'] == 'Eligible', 'CIN'].tolist()

                    if self.eligibleFrom_manual_df_cinList.__len__() != 0:
                        for pendingCIN in self.pendingFromdf_cinList:
                            if pendingCIN in self.eligibleFrom_manual_df_cinList:
                                pendingCIN_idx = self.pendingFromdf.loc[self.pendingFromdf['CIN'] == pendingCIN].index.tolist()
                                self.pendingFromdf = self.pendingFromdf.drop(index=pendingCIN_idx)

                    current_path = os.getcwd()
                    daily_folder = str(datetime.today().date())
                    basename = info_locker.base_info['BaseName']
                    file_saving_path = os.path.join(current_path, basename, daily_folder)
                    if not os.path.exists(file_saving_path):
                        os.makedirs(file_saving_path)
                        print('Save files to {0}'.format(file_saving_path))

                    self.pendingFromdf.to_excel(os.path.join(file_saving_path, '271-Not eligible Trips' + str(datetime.today().date()) + "-" + str(datetime.now().time().strftime("%H%M%S")) + '.xlsx'), index=False)
                    QMessageBox.about(self, 'Message', 'File Processed Successfully!')

            else:
                pass

        def showManually271Lib(self):
            self.subwindow_manuallyChecking = subwindow_manually271Lib()
            self.subwindow_manuallyChecking.show()

    def __init__(self):
        super(subwindow_270_271, self).__init__()
        self.setGeometry(600, 600, 600, 380)
        self.setWindowTitle('Eligibility Check')
        self.home()

    def home(self):
        self.table_widget = self.My270_271TabWidget(self)
        self.setCentralWidget(self.table_widget)


class subwindow_manually271Lib(QMainWindow):
    class MyManualCheckTabWidget(QTabWidget):

        def __init__(self, parent):
            super(QWidget, self).__init__(parent)
            self.layout = QGridLayout(self)

            self.tabs = QTabWidget()
            self.tab1 = QWidget()
            self.tabs.addTab(self.tab1, 'Manual Checking Lib')

            self.mytab1()

            self.layout.addWidget(self.tabs)
            self.setLayout(self.layout)

        def mytab1(self):
            self.tab1.layout = QGridLayout()
            nameLabel1 = QLabel('- Add/Update -')
            nameLabel2 = QLabel('Eligible:')
            nameLabel3 = QLabel('First Name:')
            nameLabel4 = QLabel('Last Name:')
            nameLabel5 = QLabel('CIN:')
            nameLabel6 = QLabel('Description:')
            nameLabel7 = QLabel('- Delete -')
            nameLabel8 = QLabel('CIN:')

            self.textboxTab1_1 = QComboBox(self)
            self.textboxTab1_1.addItem('Not Eligible')
            self.textboxTab1_1.addItem('Eligible')
            self.textboxTab1_2 = QLineEdit()
            self.textboxTab1_3 = QLineEdit()
            self.textboxTab1_4 = QLineEdit()
            self.textboxTab1_5 = QLineEdit()
            self.textboxTab1_6 = QLineEdit()

            btnAddUpdate = QPushButton('Add/Update')
            btnAddUpdate.clicked.connect(self.AddUpdateManualLib)

            btnOutputExcel = QPushButton('Get Excel')
            btnOutputExcel.clicked.connect(self.OutputExcel)

            btnDelete = QPushButton('Delete')
            btnDelete.clicked.connect(self.DeleteManualLibByCIN)

            btnShowData = QPushButton('Display Lib')
            btnShowData.clicked.connect(self.ShowManualCheckLib)

            self.tab1.layout.addWidget(nameLabel1, 0, 1)
            self.tab1.layout.addWidget(nameLabel2, 1, 0)
            self.tab1.layout.addWidget(nameLabel3, 2, 0)
            self.tab1.layout.addWidget(nameLabel4, 3, 0)
            self.tab1.layout.addWidget(nameLabel5, 4, 0)
            self.tab1.layout.addWidget(nameLabel6, 5, 0)
            self.tab1.layout.addWidget(self.textboxTab1_1, 1, 1)
            self.tab1.layout.addWidget(self.textboxTab1_2, 2, 1)
            self.tab1.layout.addWidget(self.textboxTab1_3, 3, 1)
            self.tab1.layout.addWidget(self.textboxTab1_4, 4, 1)
            self.tab1.layout.addWidget(self.textboxTab1_5, 5, 1)
            self.tab1.layout.addWidget(btnOutputExcel, 6, 0)
            self.tab1.layout.addWidget(btnAddUpdate, 6, 1)

            self.tab1.layout.addWidget(nameLabel7, 0, 3)
            self.tab1.layout.addWidget(nameLabel8, 2, 2)
            self.tab1.layout.addWidget(self.textboxTab1_6, 2, 3)
            self.tab1.layout.addWidget(btnDelete, 6, 3)
            self.tab1.layout.addWidget(btnShowData, 7, 0)
            self.tab1.setLayout(self.tab1.layout)

        def AddUpdateManualLib(self):
            SQ = mysqlite('EDI.db')
            eligible = str(self.textboxTab1_1.currentText())
            fn = self.textboxTab1_2.text()
            ln = self.textboxTab1_3.text()
            cin = self.textboxTab1_4.text()
            description = self.textboxTab1_5.text()

            SQ.manuallyUpsert271Lib(table='ManuallyCheck271', eligible=eligible, patient_ln=ln, patient_fn=fn, cin=cin, description=description)
            QMessageBox.about(self, 'Message', 'Client with CIN {0} has been added now!'.format(cin))
            self.textboxTab1_2.setText("")
            self.textboxTab1_3.setText("")
            self.textboxTab1_4.setText("")
            self.textboxTab1_5.setText("")

        def DeleteManualLibByCIN(self):
            SQ = mysqlite('EDI.db')
            cin = self.textboxTab1_6.text()
            SQ.delete_manually271Lib(table='ManuallyCheck271', cin=cin)
            QMessageBox.about(self, 'Message', 'Client with CIN {0} has been removed now!'.format(cin))

        def OutputExcel(self):
            SQ = mysqlite('EDI.db')
            choice = QMessageBox.question(self, 'Message', 'Are you sure to output file?',
                                          QMessageBox.Yes | QMessageBox.No, QMessageBox.No)
            if choice == QMessageBox.Yes:
                SQ.generate_excel_from_manually271Lib(table='ManuallyCheck271')
            else:
                pass
            QMessageBox.about(self, 'Message', 'File generated successfully!')

        def ShowManualCheckLib(self):
            self.show_manualcheck_lib = ShowManualCheck_subwindow()
            self.show_manualcheck_lib.show()

    def __init__(self):
        super(subwindow_manually271Lib, self).__init__()
        self.setGeometry(600, 600, 600, 380)
        self.setWindowTitle('Manually Checking Lib')
        self.home()

    def home(self):
        self.table_widget = self.MyManualCheckTabWidget(self)
        self.setCentralWidget(self.table_widget)


class ShowManualCheck_subwindow(QMainWindow):
    def __init__(self):
        super(ShowManualCheck_subwindow, self).__init__()
        self.setGeometry(600, 600, 700, 380)

        self.setWindowTitle('EDI GUI')
        self.home()

    def home(self):
        SQ = mysqlite('EDI.db')
        data = SQ.generate_excel_from_manually271Lib(table='ManuallyCheck271', tofile=False)

        self.tableWidget = QTableWidget(self)
        countRow = data.__len__()
        countCol = data.shape[1]
        headers = data.columns.tolist()
        self.tableWidget.setRowCount(countRow)
        self.tableWidget.setColumnCount(countCol)
        for r in range(countRow):
            for c in range(countCol):
                self.tableWidget.setItem(r, c, QTableWidgetItem(str(data.ix[r, c])))

        self.tableWidget.setHorizontalHeaderLabels(headers)
        self.tableWidget.resizeColumnsToContents()
        self.tableWidget.resizeRowsToContents()
        self.tableWidget.move(0, 0)
        self.tableWidget.resize(2560, 1440)


class EDI270data_subwindow(QMainWindow):

    def __init__(self, data):
        super(EDI270data_subwindow, self).__init__()
        self.data = data
        self.setGeometry(600, 600, 1000, 500)
        self.setWindowTitle('EDI GUI')
        self.home()

    def home(self):
        self.tableWidget = QTableWidget(self)
        countRow = self.data.__len__()
        countCol = self.data.shape[1]
        headers = self.data.columns.tolist()
        self.tableWidget.setRowCount(countRow)
        self.tableWidget.setColumnCount(countCol)
        for r in range(countRow):
            for c in range(countCol):
                self.tableWidget.setItem(r, c, QTableWidgetItem(str(self.data.ix[r, c])))

        self.tableWidget.setHorizontalHeaderLabels(headers)
        self.tableWidget.resizeColumnsToContents()
        self.tableWidget.resizeRowsToContents()
        self.tableWidget.move(0, 0)
        self.tableWidget.resize(1000, 500)


class EDI271_pending_subwindow(QMainWindow):
    def __init__(self):
        super(EDI271_pending_subwindow, self).__init__()
        self.data = pd.read_sql("SELECT * FROM UNKNOWN271", con=mysqlite('EDI.db').conn)
        self.setGeometry(600, 600, 1000, 500)
        self.setWindowTitle('EDI GUI')
        self.home()

    def home(self):
        self.tableWidget = QTableWidget(self)
        countRow = self.data.__len__()
        countCol = self.data.shape[1]
        headers = self.data.columns.tolist()
        self.tableWidget.setRowCount(countRow)
        self.tableWidget.setColumnCount(countCol)
        for r in range(countRow):
            for c in range(countCol):
                self.tableWidget.setItem(r, c, QTableWidgetItem(str(self.data.ix[r, c])))


        self.tableWidget.doubleClicked.connect(self.clickAndChange)

        self.tableWidget.setHorizontalHeaderLabels(headers)
        self.tableWidget.resizeColumnsToContents()
        self.tableWidget.resizeRowsToContents()
        self.tableWidget.move(0, 0)
        self.tableWidget.resize(1000, 500)

    def clickAndChange(self, cell):
        row_idx = cell.row()
        col_idx = cell.column()
        print(self.tableWidget.item(row_idx, col_idx).text())


class subwindow_276_277(QMainWindow):
    class My276_277TabWidget(QTabWidget):

        def __init__(self, parent):
            super(QWidget, self).__init__(parent)
            self.layout = QGridLayout(self)

            self.file_name1 = None
            self.file_name2_1 = None
            self.file_name3_1 = None
            self.file_name6_1 = None
            self.file_name6_2 = None
            self.file_name6_3 = None
            self.file_name6_4 = None
            self.file_name8 = None
            self.df = pd.DataFrame()

            self.tabs = QTabWidget()

            self.tab6 = QWidget()
            self.tab7 = QWidget()
            self.tab8 = QWidget()

            self.tabs.addTab(self.tab6, '-*Upload*-')
            self.tabs.addTab(self.tab7, '-*Payment Check*-')
            self.tabs.addTab(self.tab8, '-*835*-')

            self.mytab6()
            self.mytab7()
            self.mytab8()

            self.layout.addWidget(self.tabs)
            self.setLayout(self.layout)

        def mytab6(self):
            self.tab6.layout = QGridLayout()
            nameLabel1 = QLabel('Operr Claim P2:')
            self.textboxTab6_1 = QLineEdit()
            btnSelectTab6_1 = QPushButton('...')
            btnSelectTab6_1.clicked.connect(self.select_fileTab6_1)
            nameLabel2 = QLabel('Operr 50001:')
            self.textboxTab6_2 = QLineEdit()
            btnSelectTab6_2 = QPushButton('...')
            btnSelectTab6_2.clicked.connect(self.select_fileTab6_2)
            btnRun6 = QPushButton('Run')
            btnRun6.clicked.connect(self.generate_276)

            self.tab6.layout.addWidget(nameLabel1, 0, 0)
            self.tab6.layout.addWidget(self.textboxTab6_1, 0, 1)
            self.tab6.layout.addWidget(btnSelectTab6_1, 0, 2)
            self.tab6.layout.addWidget(nameLabel2, 1, 0)
            self.tab6.layout.addWidget(self.textboxTab6_2, 1, 1)
            self.tab6.layout.addWidget(btnSelectTab6_2, 1, 2)
            self.tab6.layout.addWidget(btnRun6, 2, 2)
            self.tab6.setLayout(self.tab6.layout)

        def mytab7(self):
            self.tab7.layout = QGridLayout()
            self.nameLabel3 = QLabel("Operr 90001:")
            self.textboxTab6_3 = QLineEdit()
            self.btnSelectTab6_3 = QPushButton('...')
            self.btnSelectTab6_3.clicked.connect(self.select_fileTab6_3)
            self.nameLabel4 = QLabel("Claims P1: \n(Optional)")
            self.textboxTab6_4 = QLineEdit()
            self.btnSelectTab6_4 = QPushButton('...')
            self.btnSelectTab6_4.clicked.connect(self.select_fileTab6_4)

            self.btnProcess = QPushButton('Run')
            self.btnProcess.clicked.connect(self.process276277)

            self.tab7.layout.addWidget(self.nameLabel3, 0, 0)
            self.tab7.layout.addWidget(self.textboxTab6_3, 0, 1)
            self.tab7.layout.addWidget(self.btnSelectTab6_3, 0, 2)
            self.tab7.layout.addWidget(self.nameLabel4, 1, 0)
            self.tab7.layout.addWidget(self.textboxTab6_4, 1, 1)
            self.tab7.layout.addWidget(self.btnSelectTab6_4, 1, 2)
            self.tab7.layout.addWidget(self.btnProcess, 2, 2)
            self.tab7.setLayout(self.tab7.layout)

        def mytab8(self):
            self.tab8.layout = QGridLayout()

            self.nameLabel_835_1 = QLabel('835 File:')
            self.textboxTab8_1 = QLineEdit()
            self.btnSelectTab8 = QPushButton('...')
            self.btnSelectTab8.clicked.connect(self.select_fileTab8)

            self.btnRun = QPushButton('Run')
            self.btnRun.clicked.connect(self.process835)

            self.tab8.layout.addWidget(self.nameLabel_835_1, 0, 0)
            self.tab8.layout.addWidget(self.textboxTab8_1, 0, 1)
            self.tab8.layout.addWidget(self.btnSelectTab8, 0, 2)
            self.tab8.layout.addWidget(self.btnRun, 1, 2)
            self.tab8.setLayout(self.tab8.layout)

        def select_fileTab6_1(self):
            self.file_name6_1, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                               options=QFileDialog.DontUseNativeDialog)
            self.textboxTab6_1.setText(self.file_name6_1)

        def select_fileTab6_2(self):
            self.file_name6_2, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                               options=QFileDialog.DontUseNativeDialog)
            self.textboxTab6_2.setText(self.file_name6_2)

        def select_fileTab6_3(self):
            self.file_name6_3, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                               options=QFileDialog.DontUseNativeDialog)
            self.textboxTab6_3.setText(self.file_name6_3)

        def select_fileTab6_4(self):
            self.file_name6_4, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                               options=QFileDialog.DontUseNativeDialog)
            self.textboxTab6_4.setText(self.file_name6_4)

        def select_fileTab8(self):
            self.file_name8, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                               options=QFileDialog.DontUseNativeDialog)
            self.textboxTab8_1.setText(self.file_name8)

        def close_application(self):
            choice = QMessageBox.question(self, 'Message',
                                          "Are you sure to quit?", QMessageBox.Yes |
                                          QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                sys.exit()
            else:
                pass

        def generate_276(self):
            choice = QMessageBox.question(self, 'Message', 'Are you sure to generate EDI 276?',
                                          QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                if not self.file_name6_1 or not self.file_name6_2:
                    QMessageBox.about(self, 'Message', 'Error!')

                else:
                    if not info_locker.base_info:
                        QMessageBox.about(self, 'Message', 'Select Base first!')
                    else:
                        P = Process_Method()
                        data_for276 = P.generate_276(receipt837_file=self.file_name6_2, edi837_data=self.file_name6_1,
                                                           lined_file=False)
                        QMessageBox.about(self, 'Message', 'File generated successfully!')
            else:
                pass

        def process276277(self):
            choice = QMessageBox.question(self, 'Message', "Are you sure to process EDI 276's 277?",
                                          QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                if not self.file_name6_3:
                    QMessageBox.about(self, 'Message', 'Error!')

                else:
                    P = Process_Method()
                    P.process_276_receipt(self.file_name6_3, self.file_name6_4, lined_file=False)
                    QMessageBox.about(self, 'Message', 'File Processed Successfully!')

            else:
                pass

        def process835(self):
            choice = QMessageBox.question(self, 'Message', "Are you sure to process EDI 276's 277?",
                                          QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                if not self.file_name8:
                    QMessageBox.about(self, 'Message', 'Error!')
                else:
                    P = Process_Method()
                    P.process_835(self.file_name8, lined_file=False)
                    QMessageBox.about(self, 'Message', 'File Processed Successfully!')
            else:
                pass

    def __init__(self):
        super(subwindow_276_277, self).__init__()
        self.setGeometry(600, 600, 600, 380)
        self.setWindowTitle('Payment')
        self.home()

    def home(self):
        self.table_widget = self.My276_277TabWidget(self)
        self.setCentralWidget(self.table_widget)


class subwindow_MAS(QMainWindow):
    class MyMASTabWidget(QTabWidget):
        def __init__(self, parent):
            super(QWidget, self).__init__(parent)
            self.layout = QGridLayout(self)
            # self.layout.setSpacing(2)

            self.tabs = QTabWidget()
            self.tab1 = QWidget()
            self.tab2 = QWidget()
            self.tab3 = QWidget()
            self.tab4 = QWidget()

            self.tabs.addTab(self.tab2, 'MAS Sign Off')
            self.tabs.addTab(self.tab3, 'Sign-off and PA Roster')
            self.tabs.addTab(self.tab4, 'Check Payment')

            self.bool_to837_file = False
            self.filenameTab3_3 = None
            self.ifcollect270 = False
            self.only270 = False
            self.file_name1 = None
            self.filenameTab4_3 = None

            self.mytab2()
            self.mytab3()
            self.mytab4()

            ############### add tabs to Widget
            self.layout.addWidget(self.tabs)
            self.setLayout(self.layout)

            ################ tab 1  Process MAS from RAW DATA

        def mytab2(self):
            self.tab2.layout = QGridLayout()
            nameLabel1 = QLabel('MAS Raw Data:')
            self.textbox1 = QLineEdit()
            btnSelect1 = QPushButton('...')
            btnSelect1.clicked.connect(self.select_file1)
            nameLabel2 = QLabel('Total Jobs:')
            self.textbox2 = QLineEdit()
            btnSelect2 = QPushButton('...')
            btnSelect2.clicked.connect(self.select_file2)
            btnRun2 = QPushButton('Run')
            btnRun2.clicked.connect(self.mas_sign_off)
            btnQuit2 = QPushButton('Quit')
            btnQuit2.clicked.connect(self.close_application)

            # self.checkboxTab2 = QCheckBox('Also generate 837 file?', self)
            # self.checkboxTab2.stateChanged.connect(self.clickbox)

            self.tab2.layout.addWidget(nameLabel1, 0, 0)
            self.tab2.layout.addWidget(self.textbox1, 0, 1)
            self.tab2.layout.addWidget(btnSelect1, 0, 2)
            self.tab2.layout.addWidget(nameLabel2, 1, 0)
            self.tab2.layout.addWidget(self.textbox2, 1, 1)
            self.tab2.layout.addWidget(btnSelect2, 1, 2)
            self.tab2.layout.addWidget(btnRun2, 2, 2)

            # self.tab2.layout.addWidget(btnQuit2, 3, 0)
            self.tab2.setLayout(self.tab2.layout)

            ################### tab3 SIGN OFF compares with PA roast ################

        def mytab3(self):

            self.tab3.layout = QGridLayout()
            nameLabelTab3_1 = QLabel('Sign-off:')
            self.textboxTab3_1 = QLineEdit()
            btnSelectTab3_1 = QPushButton('...')
            btnSelectTab3_1.clicked.connect(self.select_fileTab3_1)
            nameLabelTab3_2 = QLabel('PA Roster:')
            self.textboxTab3_2 = QLineEdit()
            btnSelectTab3_2 = QPushButton('...')
            btnSelectTab3_2.clicked.connect(self.select_fileTab3_2)
            btnRunTab3 = QPushButton('Run')
            btnRunTab3.clicked.connect(self.signoff_W_PA)
            btnQuitTab3 = QPushButton('Quit')
            btnQuitTab3.clicked.connect(self.close_application)

            self.checkboxTab3 = QCheckBox('Collect data for claims?', self)
            self.checkboxTab3.stateChanged.connect(self.clickbox)

            self.nameLabelTab3_3 = QLabel('Processed MAS:')
            self.textboxTab3_3 = QLineEdit()
            self.btnSelectTab3_3 = QPushButton('...')
            self.btnSelectTab3_3.clicked.connect(self.select_fileTab3_3)

            self.nameLabelTab3_3.hide()
            self.textboxTab3_3.hide()
            self.btnSelectTab3_3.hide()

            self.tab3.layout.addWidget(nameLabelTab3_1, 0, 0)
            self.tab3.layout.addWidget(self.textboxTab3_1, 0, 1)
            self.tab3.layout.addWidget(btnSelectTab3_1, 0, 2)
            self.tab3.layout.addWidget(nameLabelTab3_2, 1, 0)
            self.tab3.layout.addWidget(self.textboxTab3_2, 1, 1)
            self.tab3.layout.addWidget(btnSelectTab3_2, 1, 2)

            self.tab3.layout.addWidget(self.nameLabelTab3_3, 2, 0)
            self.tab3.layout.addWidget(self.textboxTab3_3, 2, 1)
            self.tab3.layout.addWidget(self.btnSelectTab3_3, 2, 2)

            self.tab3.layout.addWidget(btnRunTab3, 3, 2)
            self.tab3.layout.addWidget(self.checkboxTab3, 3, 0)
            # self.tab3.layout.addWidget(btnQuitTab3, 4, 0)
            self.tab3.setLayout(self.tab3.layout)

        def mytab4(self):
            self.tab4.layout = QGridLayout()
            nameLabelTab4_1 = QLabel('MAS Correction:')
            self.textboxTab4_1 = QLineEdit()
            btnSelectTab4_1 = QPushButton('...')
            btnSelectTab4_1.clicked.connect(self.select_fileTab4_1)
            nameLabelTab4_2 = QLabel('Payment:')
            self.textboxTab4_2 = QLineEdit()
            btnSelectTab4_2 = QPushButton('...')
            btnSelectTab4_2.clicked.connect(self.select_fileTab4_2)

            nameLabelTab4_3 = QLabel('Claims Data: \n(Optional)')
            self.textboxTab4_3 = QLineEdit()
            btnSelectTab4_3 = QPushButton('...')
            btnSelectTab4_3.clicked.connect(self.select_fileTab4_3)


            btnRunTab4 = QPushButton('Run')
            btnRunTab4.clicked.connect(self.compare_after_payment)
            btnQuitTab4 = QPushButton('Quit')
            btnQuitTab4.clicked.connect(self.close_application)

            self.tab4.layout.addWidget(nameLabelTab4_1, 0, 0)
            self.tab4.layout.addWidget(self.textboxTab4_1, 0, 1)
            self.tab4.layout.addWidget(btnSelectTab4_1, 0, 2)
            self.tab4.layout.addWidget(nameLabelTab4_2, 1, 0)
            self.tab4.layout.addWidget(self.textboxTab4_2, 1, 1)
            self.tab4.layout.addWidget(btnSelectTab4_2, 1, 2)
            self.tab4.layout.addWidget(nameLabelTab4_3, 2, 0)
            self.tab4.layout.addWidget(self.textboxTab4_3, 2, 1)
            self.tab4.layout.addWidget(btnSelectTab4_3, 2, 2)
            self.tab4.layout.addWidget(btnRunTab4, 3, 2)
            # self.tab4.layout.addWidget(btnQuitTab4, 4, 0)
            self.tab4.setLayout(self.tab4.layout)

        def select_file(self):
            self.file_name, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                            options=QFileDialog.DontUseNativeDialog)
            self.textbox.setText(self.file_name)

        def select_file1(self):
            self.file_name1, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                             options=QFileDialog.DontUseNativeDialog)
            self.textbox1.setText(self.file_name1)

        def select_file2(self):
            self.file_name2, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                             options=QFileDialog.DontUseNativeDialog)
            self.textbox2.setText(self.file_name2)

        def close_application(self):
            choice = QMessageBox.question(self, 'Message',
                                          "Are you sure to quit?", QMessageBox.Yes |
                                          QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                sys.exit()
            else:
                pass

        def SwitchToCollect270(self, state):
            if state == Qt.Checked:
                self.ifcollect270 = True
            else:
                self.ifcollect270 = False

        def OnlyCollect270(self, state):
            if state == Qt.Checked:
                self.only270 = True
            else:
                self.only270 = False

        def clickbox(self, state):
            if state == Qt.Checked:
                self.nameLabelTab3_3.show()
                self.textboxTab3_3.show()
                self.btnSelectTab3_3.show()
                self.bool_to837_file = True

            else:
                self.nameLabelTab3_3.hide()
                self.textboxTab3_3.hide()
                self.btnSelectTab3_3.hide()
                self.bool_to837_file = False

        def mas_raw_process(self):
            choice = QMessageBox.question(self, 'Message', 'Are you sure to process raw data?',
                                          QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                p = Process_MAS(self.file_name)

                if self.only270 == True:
                    p.generate_270_data(tofile=True)

                elif self.ifcollect270 == True:
                    p.generate_270_data(tofile=True)
                    p.add_codes(tofile=True)

                sleep(0.5)
                QMessageBox.about(self, 'Message', 'File generated successfully!')

            else:
                pass

        def mas_sign_off(self):
            choice = QMessageBox.question(self, 'Message', 'Are you sure to process raw data?',
                                          QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                if self.file_name1:
                    Process_Method().mas_signoff(mas_raw_data=self.file_name1, total_job=self.file_name2)
                    QMessageBox.about(self, 'Message', 'File generated successfully!')
                else:
                    total_job_df = pd.read_csv(self.file_name2, header=None) if self.file_name2[-1] == 'v' else pd.read_excel(
                        self.file_name2, header=None)
                    total_job_df.columns = ['FleetNumber', 'ServiceDate', 'CompanyCode', 'CustomerName', 'TripID',
                                            'TollFee',
                                            'Amount', 'pComany', 'pReserve', 'pPerson']
                    total_job_df = total_job_df.dropna()

                    # check if there is duplicated trip in total jobs
                    duplicated_idx = total_job_df.duplicated(subset=['TripID'], keep='last')
                    if any(duplicated_idx):
                        only_duplicated_trips_in_totaljobs = total_job_df.loc[duplicated_idx]

                        current_path = os.getcwd()
                        daily_folder = str(datetime.today().date())
                        basename = info_locker.base_info['BaseName']
                        file_saving_path = os.path.join(current_path, basename, daily_folder)
                        if not os.path.exists(file_saving_path):
                            os.makedirs(file_saving_path)
                            print('Save files to {0}'.format(file_saving_path))

                        only_duplicated_trips_in_totaljobs.to_excel(os.path.join(file_saving_path,
                                                                                 'duplicated_trips_in_totaljob-{0}-{1}.xlsx'.format(
                                                                                     str(datetime.today().date()), str(
                                                                                         datetime.now().time().strftime(
                                                                                             '%H%M%S')))), index=False)
                    QMessageBox.about(self, 'Message', 'File generated successfully!')


            else:
                pass

        def select_fileTab3_1(self):
            self.filenameTab3_1, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                                 options=QFileDialog.DontUseNativeDialog)
            self.textboxTab3_1.setText(self.filenameTab3_1)

        def select_fileTab3_2(self):
            self.filenameTab3_2, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                                 options=QFileDialog.DontUseNativeDialog)
            self.textboxTab3_2.setText(self.filenameTab3_2)

        def select_fileTab3_3(self):
            self.filenameTab3_3, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                                 options=QFileDialog.DontUseNativeDialog)
            self.textboxTab3_3.setText(self.filenameTab3_3)

        def select_fileTab4_1(self):
            self.filenameTab4_1, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                                 options=QFileDialog.DontUseNativeDialog)
            self.textboxTab4_1.setText(self.filenameTab4_1)

        def select_fileTab4_2(self):
            self.filenameTab4_2, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                                 options=QFileDialog.DontUseNativeDialog)
            self.textboxTab4_2.setText(self.filenameTab4_2)

        def select_fileTab4_3(self):
            self.filenameTab4_3, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                                 options=QFileDialog.DontUseNativeDialog)
            self.textboxTab4_3.setText(self.filenameTab4_3)

        def compare_after_payment(self):
            choice = QMessageBox.question(self, 'Message', 'Are you sure to use payment file to compare?',
                                          QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                S = SignoffAndCompare()
                S.new_compare_after_payment(signoff_compare_PA_file=self.filenameTab4_1,
                                            payment_raw_file=self.filenameTab4_2,
                                            edi_837P_file=self.filenameTab4_3)
                sleep(0.5)
                QMessageBox.about(self, 'Message', 'File generated successfully!')

            else:
                pass

        def signoff_W_PA(self):
            choice = QMessageBox.question(self, 'Message', 'Are you sure to compare two files?',
                                          QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                S = SignoffAndCompare()
                S.compare_signoff_PA(self.filenameTab3_1, self.filenameTab3_2, tofile=True, to837=self.bool_to837_file,
                                     mas_2=self.filenameTab3_3)
                sleep(0.5)
                QMessageBox.about(self, 'Message', 'File Generated Successfully!')

            else:
                pass

    def __init__(self):
        super(subwindow_MAS, self).__init__()
        self.setGeometry(600, 600, 600, 380)
        self.setWindowTitle('MAS Billing')
        # print(info_locker.driver_information)
        self.home()

    def home(self):
        self.table_widget = self.MyMASTabWidget(self)
        self.setCentralWidget(self.table_widget)


class subwindow_plancode(QMainWindow):
    class MyPlanCodeTabWidget(QTabWidget):

        def __init__(self, parent):
            super(QWidget, self).__init__(parent)
            self.layout = QGridLayout(self)

            self.tabs = QTabWidget()
            self.tab4 = QWidget()
            self.tabs.addTab(self.tab4, 'PlanCode Lib')

            self.mytab4()

            self.layout.addWidget(self.tabs)
            self.setLayout(self.layout)

        def mytab4(self):
            # plan code library
            self.tab4.layout = QGridLayout()
            nameLabel1 = QLabel('- Add/Update -')
            nameLabel2 = QLabel('Plan Code:')
            nameLabel3 = QLabel('Provider Name:')
            nameLabel4 = QLabel('Tel.:')
            nameLabel5 = QLabel('Plan Type:')
            nameLabel6 = QLabel('- Delete -')
            nameLabel7 = QLabel('Plan Code:')

            self.textboxTab4_2 = QLineEdit()
            self.textboxTab4_3 = QLineEdit()
            self.textboxTab4_4 = QLineEdit()
            self.textboxTab4_5 = QLineEdit()
            self.textboxTab4_7 = QLineEdit()

            btnAddUpdate = QPushButton('Add/Update')
            btnAddUpdate.clicked.connect(self.AddUpdatePlancode)
            btnDelete = QPushButton('Delete')
            btnDelete.clicked.connect(self.DeletePlancode)
            btnShowLib = QPushButton('Show Lib')
            btnShowLib.clicked.connect(self.ShowLib)
            btnQuit4 = QPushButton('Quit')
            btnQuit4.clicked.connect(self.close_application)

            self.tab4.layout.addWidget(nameLabel1, 0, 1)
            self.tab4.layout.addWidget(nameLabel2, 1, 0)
            self.tab4.layout.addWidget(self.textboxTab4_2, 1, 1)
            self.tab4.layout.addWidget(nameLabel3, 2, 0)
            self.tab4.layout.addWidget(self.textboxTab4_3, 2, 1)
            self.tab4.layout.addWidget(nameLabel4, 3, 0)
            self.tab4.layout.addWidget(self.textboxTab4_4, 3, 1)
            self.tab4.layout.addWidget(nameLabel5, 4, 0)
            self.tab4.layout.addWidget(self.textboxTab4_5, 4, 1)
            self.tab4.layout.addWidget(nameLabel6, 0, 3)
            self.tab4.layout.addWidget(nameLabel7, 2, 2)
            self.tab4.layout.addWidget(self.textboxTab4_7, 2, 3)
            self.tab4.layout.addWidget(btnAddUpdate, 5, 1)
            self.tab4.layout.addWidget(btnDelete, 5, 3)
            # self.tab4.layout.addWidget(btnQuit4, 7, 0)
            self.tab4.layout.addWidget(btnShowLib, 6, 0)
            self.tab4.setLayout(self.tab4.layout)

        def close_application(self):
            choice = QMessageBox.question(self, 'Message',
                                          "Are you sure to quit?", QMessageBox.Yes |
                                          QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                sys.exit()
            else:
                pass

        def AddUpdatePlancode(self):
            SQ = mysqlite('EDI.db')
            plancode = self.textboxTab4_2.text()
            providername = self.textboxTab4_3.text()
            tel = self.textboxTab4_4.text()
            plantype = self.textboxTab4_5.text()
            SQ.upsert_271_plancodes(table='PlanCodeLib', plancode=plancode, providername=providername,
                                    tel=tel, plantype=plantype)

            QMessageBox.about(self, 'Message', 'Plan code {0} has been added now!'.format(plancode))

        def DeletePlancode(self):
            SQ = mysqlite('EDI.db')
            del_plancode = self.textboxTab4_7.text()
            SQ.delete_271_plancodes(table='PlanCodeLib', plancode=del_plancode)
            QMessageBox.about(self, 'Message', 'Plan code {0} has been deleted now!'.format(del_plancode))

        def ShowLib(self):
            # SQ = mysqlite('EDI.db')
            # data = SQ.get_data_from_271_plancode('PlanCodeLib')
            #
            # self.tableWidget = QTableWidget(self)
            # countRow = data.__len__()
            # countCol = data.shape[1]
            # headers = data.columns.tolist()
            # self.tableWidget.setRowCount(countRow)
            # self.tableWidget.setColumnCount(countCol)
            # for r in range(countRow):
            #     for c in range(countCol):
            #         self.tableWidget.setItem(r, c, QTableWidgetItem(str(data.ix[r, c])))
            #
            # self.tableWidget.setHorizontalHeaderLabels(headers)
            # self.tableWidget.resizeColumnsToContents()
            # self.tableWidget.resizeRowsToContents()
            # self.tableWidget.move(0, 0)
            #
            # self.layout.addWidget(self.tableWidget)
            # self.setLayout(self.layout)
            # self.show()
            self.second_win = ShowLib_subwindow()
            self.second_win.show()

    def __init__(self):
        super(subwindow_plancode, self).__init__()
        self.setGeometry(600, 600, 600, 380)
        self.setWindowTitle('PlanCode Lib')
        self.home()

    def home(self):
        self.table_widget = self.MyPlanCodeTabWidget(self)
        self.setCentralWidget(self.table_widget)


class ShowLib_subwindow(QMainWindow):

    def __init__(self):
        super(ShowLib_subwindow, self).__init__()
        self.setGeometry(600, 600, 750, 400)
        self.setWindowTitle('EDI GUI')
        self.home()

    def home(self):
        SQ = mysqlite('EDI.db')
        data = SQ.get_data_from_271_plancode('PlanCodeLib')

        self.tableWidget = QTableWidget(self)
        countRow = data.__len__()
        countCol = data.shape[1]
        headers = data.columns.tolist()
        self.tableWidget.setRowCount(countRow)
        self.tableWidget.setColumnCount(countCol)
        for r in range(countRow):
            for c in range(countCol):
                self.tableWidget.setItem(r, c, QTableWidgetItem(str(data.ix[r, c])))

        self.tableWidget.setHorizontalHeaderLabels(headers)
        self.tableWidget.resizeColumnsToContents()
        self.tableWidget.resizeRowsToContents()
        self.tableWidget.move(0, 0)
        self.tableWidget.resize(750, 400)


class subwindow_processTXT(QMainWindow):
    class MyTXTTabWidget(QTabWidget):

        def __init__(self, parent):
            super(QWidget, self).__init__(parent)
            self.layout = QGridLayout(self)

            self.file_name5_1 = None

            self.df = pd.DataFrame()

            self.tabs = QTabWidget()
            self.tab5 = QWidget()
            self.tabs.addTab(self.tab5, 'Process Method')

            self.mytab5()

            self.layout.addWidget(self.tabs)
            self.setLayout(self.layout)

        def mytab5(self):
            self.tab5.layout = QGridLayout()
            nameLabel1 = QLabel('TXT File:')
            self.textboxTab5_1 = QLineEdit()
            btnToLines = QPushButton('To Lines')
            btnToStream = QPushButton('To Stream')
            btnToExcel = QPushButton('To Excel')
            btnToLines.clicked.connect(self.transfer2lines)
            btnToStream.clicked.connect(self.transfer2stream)
            btnToExcel.clicked.connect(self.transfer2Excel)
            btnSelectFileTab5_1 = QPushButton('...')
            btnSelectFileTab5_1.clicked.connect(self.select_fileTab5_1)

            self.tab5.layout.addWidget(nameLabel1, 0, 0)
            self.tab5.layout.addWidget(self.textboxTab5_1, 0, 1)
            self.tab5.layout.addWidget(btnSelectFileTab5_1, 0, 2)
            self.tab5.layout.addWidget(btnToLines, 1, 2)
            self.tab5.layout.addWidget(btnToStream, 2, 2)
            self.tab5.layout.addWidget(btnToExcel, 3, 2)
            self.tab5.setLayout(self.tab5.layout)

        def select_fileTab5_1(self):
            self.file_name5_1, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                               options=QFileDialog.DontUseNativeDialog)
            self.textboxTab5_1.setText(self.file_name5_1)

        def close_application(self):
            choice = QMessageBox.question(self, 'Message',
                                          "Are you sure to quit?", QMessageBox.Yes |
                                          QMessageBox.No, QMessageBox.No)

            if choice == QMessageBox.Yes:
                sys.exit()
            else:
                pass

        def transfer2lines(self):
            P = Process_Method()
            if not self.file_name5_1:
                QMessageBox.about(self, 'Message', 'Error!')
            else:
                P.transfer2lines(self.file_name5_1)
                QMessageBox.about(self, 'Message', 'File generated successfully!')

        def transfer2stream(self):
            P = Process_Method()
            if not self.file_name5_1:
                QMessageBox.about(self, 'Message', 'Error!')

            else:
                P.transfer2stream(self.file_name5_1)
                QMessageBox.about(self, 'Message', 'File generated successfully!')

        def transfer2Excel(self):
            P = Process_Method()
            if not self.file_name5_1:
                QMessageBox.about(self, 'Message', 'Error!')
            else:
                P.transfer2Excel(self.file_name5_1)
                QMessageBox.about(self, 'Message', 'File generated successfully!')

    def __init__(self):
        super(subwindow_processTXT, self).__init__()
        self.setGeometry(600, 600, 600, 380)
        self.setWindowTitle('Process TXT File')
        self.home()

    def home(self):
        self.table_widget = self.MyTXTTabWidget(self)
        self.setCentralWidget(self.table_widget)


class subwindow_addbase(QMainWindow):
    class MyAddBaseTabWidget(QTabWidget):

        def __init__(self, parent):
            super(QWidget, self).__init__(parent)
            self.layout = QGridLayout(self)

            self.tabs = QTabWidget()
            self.tab1 = QWidget()
            self.tabs.addTab(self.tab1, 'Add Base')

            self.mytab1()

            self.layout.addWidget(self.tabs)
            self.setLayout(self.layout)

        def mytab1(self):
            self.tab1.layout = QGridLayout()
            nameLabel0 = QLabel('Add Base:')
            nameLabel1 = QLabel('Name:')
            nameLabel2 = QLabel('Address:')
            nameLabel3 = QLabel('City:')
            nameLabel4 = QLabel('State:')
            nameLabel5 = QLabel('ZipCode:')
            nameLabel6 = QLabel('ETIN:')
            nameLabel7 = QLabel('NPI:')
            nameLabel8 = QLabel('Medicaid Provider#:')
            nameLabel9 = QLabel('TaxID:')
            nameLabel10 = QLabel('Contact Name:')
            nameLabel11 = QLabel('Contact Tel.:')
            nameLabel12 = QLabel('Location Code:')

            nameLabel13 = QLabel('- Delete Base -')
            nameLabel14 = QLabel('NPI:')

            self.textbox1 = QLineEdit()
            self.textbox2 = QLineEdit()
            self.textbox3 = QLineEdit()
            self.state_combobox = QComboBox(self)
            self.state_combobox.addItem("")
            self.state_combobox.addItem("NY")
            self.textbox5 = QLineEdit()
            self.textbox6 = QLineEdit()
            self.textbox7 = QLineEdit()
            self.textbox8 = QLineEdit()
            self.textbox9 = QLineEdit()
            self.textbox10 = QLineEdit()
            self.textbox11 = QLineEdit()
            self.textbox12 = QLineEdit()
            self.textbox13 = QLineEdit()

            # self.tab1.layout.addWidget(nameLabel0, 0, 0)
            self.tab1.layout.addWidget(nameLabel1, 1, 0)
            self.tab1.layout.addWidget(nameLabel2, 2, 0)
            self.tab1.layout.addWidget(nameLabel3, 3, 0)
            self.tab1.layout.addWidget(nameLabel4, 4, 0)
            self.tab1.layout.addWidget(nameLabel5, 5, 0)
            self.tab1.layout.addWidget(nameLabel6, 6, 0)
            self.tab1.layout.addWidget(nameLabel7, 7, 0)
            self.tab1.layout.addWidget(nameLabel8, 8, 0)
            self.tab1.layout.addWidget(nameLabel9, 9, 0)
            self.tab1.layout.addWidget(nameLabel10, 10, 0)
            self.tab1.layout.addWidget(nameLabel11, 11, 0)
            self.tab1.layout.addWidget(nameLabel12, 12, 0)
            self.tab1.layout.addWidget(nameLabel13, 14, 0)
            self.tab1.layout.addWidget(nameLabel14, 15, 0)

            btnCreateBase = QPushButton('Create')
            btnCancel = QPushButton('Cancel')
            btnCreateBase.clicked.connect(self.createBase2DB)

            btnDelete = QPushButton('Delete')
            btnDelete.clicked.connect(self.deleteBase)

            btnShowBase = QPushButton('Show Base')
            btnShowBase.clicked.connect(self.showbase)

            self.tab1.layout.addWidget(self.textbox1, 1, 1)
            self.tab1.layout.addWidget(self.textbox2, 2, 1)
            self.tab1.layout.addWidget(self.textbox3, 3, 1)
            self.tab1.layout.addWidget(self.state_combobox, 4, 1)
            self.tab1.layout.addWidget(self.textbox5, 5, 1)
            self.tab1.layout.addWidget(self.textbox6, 6, 1)
            self.tab1.layout.addWidget(self.textbox7, 7, 1)
            self.tab1.layout.addWidget(self.textbox8, 8, 1)
            self.tab1.layout.addWidget(self.textbox9, 9, 1)
            self.tab1.layout.addWidget(self.textbox10, 10, 1)
            self.tab1.layout.addWidget(self.textbox11, 11, 1)
            self.tab1.layout.addWidget(self.textbox12, 12, 1)
            self.tab1.layout.addWidget(self.textbox13, 15, 1)

            self.tab1.layout.addWidget(btnCreateBase, 13, 1)
            self.tab1.layout.addWidget(btnShowBase, 13, 0)
            self.tab1.layout.addWidget(btnDelete, 16, 1)

            self.tab1.setLayout(self.tab1.layout)

        def createBase2DB(self):
            basename = self.textbox1.text()
            baseaddress = self.textbox2.text()
            city = self.textbox3.text()
            state = self.state_combobox.currentText()
            zipcode = self.textbox5.text()
            etin = self.textbox6.text()
            npi = self.textbox7.text()
            medicaid_providerNum = self.textbox8.text()
            taxid = self.textbox9.text()
            contactname = self.textbox10.text()
            contacttel = self.textbox11.text()
            locationcode = self.textbox12.text()

            if not basename or not baseaddress or not city or not state or not zipcode or not etin or not npi or not medicaid_providerNum or not taxid or not contactname or not contacttel or not locationcode:
                QMessageBox.about(self, 'Message', 'All fields are required!')
            else:
                SQ = mysqlite('EDI.db')
                SQ.upsert_newbase(table='AllBases', basename=basename, baseaddress=baseaddress, city=city, state=state, zipcode=zipcode, etin=etin, npi=npi,
                                  medicaid_provider_num=medicaid_providerNum, taxid=taxid, contactname=contactname, contactTel=contacttel, locationcode=locationcode)
                QMessageBox.about(self, 'Message', 'New base {0} are added!'.format(basename))

        def deleteBase(self):
            npi = self.textbox13.text()
            SQ = mysqlite('EDI.db')
            SQ.delete_newbase(table='AllBases', npi=npi)
            QMessageBox.about(self, 'Message', 'Base {0} are deleted!'.format(npi))

        def showbase(self):
            self.show_new_base = subwindow_ShowNewBase()
            self.show_new_base.show()

    def __init__(self):
        super(subwindow_addbase, self).__init__()
        self.setGeometry(600, 600, 400, 600)
        self.setWindowTitle('Add A New Base')
        self.home()

    def home(self):
        self.table_widget = self.MyAddBaseTabWidget(self)
        self.setCentralWidget(self.table_widget)


class subwindow_ShowNewBase(QMainWindow):

    def __init__(self):
        super(subwindow_ShowNewBase, self).__init__()
        self.setGeometry(600, 600, 750, 400)
        self.setWindowTitle('EDI GUI')
        self.home()

    def home(self):
        SQ = mysqlite('EDI.db')
        data = SQ.get_data_from_271_plancode('AllBases')

        self.tableWidget = QTableWidget(self)
        countRow = data.__len__()
        countCol = data.shape[1]
        headers = data.columns.tolist()
        self.tableWidget.setRowCount(countRow)
        self.tableWidget.setColumnCount(countCol)
        for r in range(countRow):
            for c in range(countCol):
                self.tableWidget.setItem(r, c, QTableWidgetItem(str(data.ix[r, c])))

        self.tableWidget.setHorizontalHeaderLabels(headers)
        self.tableWidget.resizeColumnsToContents()
        self.tableWidget.resizeRowsToContents()
        self.tableWidget.move(0, 0)
        self.tableWidget.resize(750, 400)


class subwindow_addDriver(QMainWindow):
    class MyAddDriverWidget(QTabWidget):
        def __init__(self, parent):
            super(QWidget, self).__init__(parent)
            self.layout = QGridLayout(self)

            self.tabs = QTabWidget()
            self.tab1 = QWidget()
            self.tabs.addTab(self.tab1, 'Add Driver')

            self.ImportFile_name = None

            self.only_basenames = window().only_basenames

            self.mytab1()

            self.layout.addWidget(self.tabs)
            self.setLayout(self.layout)

        def mytab1(self):
            self.tab1.layout = QGridLayout()
            nameLabel1 = QLabel('Fleet:')
            nameLabel2 = QLabel('Base:')
            nameLabel3 = QLabel('FirstName:')
            nameLabel4 = QLabel('LastName:')
            nameLabel5 = QLabel('Driver ID:')
            nameLabel6 = QLabel('Vehicle ID:')
            nameLabel7 = QLabel('- Delete Driver -')
            nameLabel8 = QLabel('Fleet:')
            nameLabel9 = QLabel('Base:')
            nameLabel10 = QLabel('File:')

            self.textbox1 = QLineEdit()
            self.base_combobox = QComboBox(self)
            self.delete_base_combobox = QComboBox(self)

            for base in self.only_basenames:
                self.base_combobox.addItem(base)
                self.delete_base_combobox.addItem(base)

            self.textbox3 = QLineEdit()
            self.textbox4 = QLineEdit()
            self.textbox5 = QLineEdit()
            self.textbox6 = QLineEdit()
            self.textbox8 = QLineEdit()
            self.textbox9 = QLineEdit()

            btnAddDriver = QPushButton('Add')
            btnAddDriver.clicked.connect(self.add_driver2DB)
            btnDeleteDriver = QPushButton('Delete')
            btnDeleteDriver.clicked.connect(self.deleteDriver)
            btnShowDriver = QPushButton('Show Driver')
            btnShowDriver.clicked.connect(self.showDriver)
            btnImportFile = QPushButton('Import File')
            btnImportFile.clicked.connect(self.ImportFile)

            self.tab1.layout.addWidget(nameLabel1, 0, 0)
            self.tab1.layout.addWidget(nameLabel2, 1, 0)
            self.tab1.layout.addWidget(nameLabel3, 2, 0)
            self.tab1.layout.addWidget(nameLabel4, 3, 0)
            self.tab1.layout.addWidget(nameLabel5, 4, 0)
            self.tab1.layout.addWidget(nameLabel6, 5, 0)
            self.tab1.layout.addWidget(nameLabel10, 6, 0)
            self.tab1.layout.addWidget(btnShowDriver, 8, 0)
            self.tab1.layout.addWidget(nameLabel7, 9, 0)
            self.tab1.layout.addWidget(nameLabel8, 10, 0)
            self.tab1.layout.addWidget(self.textbox1, 0, 1)
            self.tab1.layout.addWidget(self.base_combobox, 1, 1)
            self.tab1.layout.addWidget(self.textbox3, 2, 1)
            self.tab1.layout.addWidget(self.textbox4, 3, 1)
            self.tab1.layout.addWidget(self.textbox5, 4, 1)
            self.tab1.layout.addWidget(self.textbox6, 5, 1)
            self.tab1.layout.addWidget(self.textbox9, 6, 1)
            self.tab1.layout.addWidget(btnImportFile, 7, 1)
            self.tab1.layout.addWidget(btnAddDriver, 8, 1)
            self.tab1.layout.addWidget(self.textbox8, 10, 1)
            self.tab1.layout.addWidget(btnDeleteDriver, 12, 1)
            self.tab1.layout.addWidget(nameLabel9, 11, 0)
            self.tab1.layout.addWidget(self.delete_base_combobox, 11, 1)

            self.tab1.setLayout(self.tab1.layout)

        def add_driver2DB(self):
            fleet = self.textbox1.text()
            base = self.base_combobox.currentText()
            firstname = self.textbox3.text()
            lastname = self.textbox4.text()
            driverid = self.textbox5.text()
            vehicleid = self.textbox6.text()

            if self.ImportFile_name:
                SQ = mysqlite('EDI.db')
                driver_df = pd.read_excel(self.ImportFile_name)
                for r in range(len(driver_df)):
                    SQ.upsert_newdriver(table='driver_info', fleet=driver_df.ix[r, 'Fleet'], base=base, firstname=driver_df.ix[r, 'FirstName'],lastname=driver_df.ix[r, 'LastName'], driverid=int(driver_df.ix[r, 'DriverID']), vehicleid=driver_df.ix[r, 'VehicleID'])

            elif not fleet or not base or not firstname or not lastname or not driverid or not vehicleid:
                QMessageBox.about(self, 'Message', 'All fields are required!')

            else:
                SQ = mysqlite('EDI.db')
                SQ.upsert_newdriver(table='driver_info', fleet=fleet, base=base, firstname=firstname, lastname=lastname, driverid=driverid, vehicleid=vehicleid)
                QMessageBox.about(self, 'Message', 'Driver {0} {1} are added'.format(firstname, lastname))
                self.textbox1.setText("")
                self.textbox3.setText("")
                self.textbox4.setText("")
                self.textbox5.setText("")
                self.textbox6.setText("")

        def deleteDriver(self):
            delete_fleet = self.textbox8.text()
            delete_basename = self.delete_base_combobox.currentText()
            SQ = mysqlite('EDI.db')
            SQ.delete_driver(table='driver_info', fleet=delete_fleet, base=delete_basename)
            QMessageBox.about(self, 'Message', 'Driver {0} is deleted!'.format(delete_fleet))

        def showDriver(self):
            info_locker.add_driver_basename = self.base_combobox.currentText()
            self.show_driver = subwindow_ShowDriver()
            self.show_driver.show()

        def ImportFile(self):
            self.ImportFile_name, _ = QFileDialog.getOpenFileName(self, 'Select File',
                                                                 options=QFileDialog.DontUseNativeDialog)
            self.textbox9.setText(self.ImportFile_name)

    def __init__(self):
        super(subwindow_addDriver, self).__init__()
        self.setGeometry(600, 600, 420, 480)
        self.setWindowTitle('Add A New Driver')
        self.home()

    def home(self):
        self.table_widget = self.MyAddDriverWidget(self)
        self.setCentralWidget(self.table_widget)


class subwindow_ShowDriver(QMainWindow):

    def __init__(self):
        super(subwindow_ShowDriver, self).__init__()
        self.setGeometry(600, 600, 800, 600)
        self.setWindowTitle('EDI GUI')
        self.home()

    def home(self):
        self.base_combobox_text = info_locker.add_driver_basename

        SQ = mysqlite('EDI.db')
        data = SQ.get_data_from_driver('driver_info', self.base_combobox_text)
        self.tableWidget = QTableWidget(self)
        countRow = data.__len__()
        countCol = data.shape[1]
        headers = data.columns.tolist()
        self.tableWidget.setRowCount(countRow)
        self.tableWidget.setColumnCount(countCol)
        for r in range(countRow):
            for c in range(countCol):
                self.tableWidget.setItem(r, c, QTableWidgetItem(str(data.ix[r, c])))

        self.tableWidget.setHorizontalHeaderLabels(headers)
        self.tableWidget.resizeColumnsToContents()
        self.tableWidget.resizeRowsToContents()
        self.tableWidget.move(0, 0)
        self.tableWidget.resize(800, 600)


class MyEDITabWidget(QTabWidget):

    def __init__(self, parent):
        super(QWidget, self).__init__(parent)
        self.layout = QGridLayout(self)

        self.file_name1 = None
        self.file_name2_1 = None
        self.file_name3_1 = None
        self.file_name6_1 = None
        self.file_name6_2 = None
        self.file_name6_3 = None
        self.df = pd.DataFrame()

        self.tabs = QTabWidget()
        self.tab1 = QWidget()
        self.tab2 = QWidget()
        self.tab3 = QWidget()
        self.tab4 = QWidget()
        self.tab5 = QWidget()
        self.tab6 = QWidget()

        self.tabs.addTab(self.tab1, '-*837*-')
        self.tabs.addTab(self.tab2, '-*270*-')
        self.tabs.addTab(self.tab3, '-*271*-')
        self.tabs.addTab(self.tab6, '-*276*-')
        self.tabs.addTab(self.tab4, 'PlanCode Lib')
        self.tabs.addTab(self.tab5, 'Process Method')

        self.mytab1()
        self.mytab2()
        self.mytab3()
        self.mytab4()
        self.mytab5()
        self.mytab6()

        self.layout.addWidget(self.tabs)
        self.setLayout(self.layout)

    def mytab1(self):
        self.tab1.layout = QGridLayout()
        nameLabel1 = QLabel('Data for 837:')
        self.textbox1 = QLineEdit()
        btnSelect1 = QPushButton('...')
        btnSelect1.clicked.connect(self.select_file1)
        btnRun1 = QPushButton('Run')
        btnRun1.clicked.connect(self.generate_837)
        btnQuit1 = QPushButton('Quit')
        btnQuit1.clicked.connect(self.close_application)

        self.tab1.layout.addWidget(nameLabel1, 0, 0)
        self.tab1.layout.addWidget(self.textbox1, 0, 1)
        self.tab1.layout.addWidget(btnSelect1, 0, 2)
        self.tab1.layout.addWidget(btnRun1, 0, 3)
        self.tab1.layout.addWidget(btnQuit1, 3, 0)
        self.tab1.setLayout(self.tab1.layout)

    def mytab2(self):
        self.tab2.layout = QGridLayout()
        nameLabel1 = QLabel('Data for 270:')
        self.textboxTab2_1 = QLineEdit()
        btnSelectTab2_1 = QPushButton('...')
        btnSelectTab2_1.clicked.connect(self.select_fileTab2_1)
        btnRunTab2_1 = QPushButton('Run')
        btnRunTab2_1.clicked.connect(self.generate_270)
        btnQuit2 = QPushButton('Quit')
        btnQuit2.clicked.connect(self.close_application)

        self.tab2.layout.addWidget(nameLabel1, 0, 0)
        self.tab2.layout.addWidget(self.textboxTab2_1, 0, 1)
        self.tab2.layout.addWidget(btnSelectTab2_1, 0, 2)
        self.tab2.layout.addWidget(btnRunTab2_1, 0, 3)
        self.tab2.layout.addWidget(btnQuit2, 3, 0)
        self.tab2.setLayout(self.tab2.layout)

    def mytab3(self):
        self.tab3.layout = QGridLayout()
        nameLabel1 = QLabel('271 File:')
        self.textboxTab3_1 = QLineEdit()
        btnSelectTab3_1 = QPushButton('...')
        btnSelectTab3_1.clicked.connect(self.select_fileTab3_1)
        btnRunTab3 = QPushButton('Run')
        btnRunTab3.clicked.connect(self.process_271)
        btnQuit3 = QPushButton('Quit')
        btnQuit3.clicked.connect(self.close_application)
        btnShowData = QPushButton('Display Data')
        btnShowData.clicked.connect(self.switchToShow)

        self.tab3.layout.addWidget(nameLabel1, 0, 0)
        self.tab3.layout.addWidget(self.textboxTab3_1, 0, 1)
        self.tab3.layout.addWidget(btnSelectTab3_1, 0, 2)
        self.tab3.layout.addWidget(btnShowData, 1, 3)
        self.tab3.layout.addWidget(btnRunTab3, 0, 3)
        self.tab3.layout.addWidget(btnQuit3, 3, 0)
        self.tab3.setLayout(self.tab3.layout)

    def mytab4(self):
        # plan code library
        self.tab4.layout = QGridLayout()
        nameLabel1 = QLabel('- Add/Update -')
        nameLabel2 = QLabel('Plan Code:')
        nameLabel3 = QLabel('Provider Name:')
        nameLabel4 = QLabel('Tel.:')
        nameLabel5 = QLabel('Plan Type:')
        nameLabel6 = QLabel('- Delete -')
        nameLabel7 = QLabel('Plan Code:')

        self.textboxTab4_2 = QLineEdit()
        self.textboxTab4_3 = QLineEdit()
        self.textboxTab4_4 = QLineEdit()
        self.textboxTab4_5 = QLineEdit()
        self.textboxTab4_7 = QLineEdit()

        btnAddUpdate = QPushButton('Add/Update')
        btnAddUpdate.clicked.connect(self.AddUpdatePlancode)
        btnDelete = QPushButton('Delete')
        btnDelete.clicked.connect(self.DeletePlancode)
        btnShowLib = QPushButton('Show Lib')
        btnShowLib.clicked.connect(self.ShowLib)
        btnQuit4 = QPushButton('Quit')
        btnQuit4.clicked.connect(self.close_application)

        self.tab4.layout.addWidget(nameLabel1, 0, 1)
        self.tab4.layout.addWidget(nameLabel2, 1, 0)
        self.tab4.layout.addWidget(self.textboxTab4_2, 1, 1)
        self.tab4.layout.addWidget(nameLabel3, 2, 0)
        self.tab4.layout.addWidget(self.textboxTab4_3, 2, 1)
        self.tab4.layout.addWidget(nameLabel4, 3, 0)
        self.tab4.layout.addWidget(self.textboxTab4_4, 3, 1)
        self.tab4.layout.addWidget(nameLabel5, 4, 0)
        self.tab4.layout.addWidget(self.textboxTab4_5, 4, 1)
        self.tab4.layout.addWidget(nameLabel6, 0, 3)
        self.tab4.layout.addWidget(nameLabel7, 2, 2)
        self.tab4.layout.addWidget(self.textboxTab4_7, 2, 3)
        self.tab4.layout.addWidget(btnAddUpdate, 5, 1)
        self.tab4.layout.addWidget(btnDelete, 5, 3)
        self.tab4.layout.addWidget(btnQuit4, 7, 0)
        self.tab4.layout.addWidget(btnShowLib, 6, 0)
        self.tab4.setLayout(self.tab4.layout)

    def mytab5(self):
        self.tab5.layout = QGridLayout()
        nameLabel1 = QLabel('File:')
        self.textboxTab5_1 = QLineEdit()
        btnToLines = QPushButton('ToLines')
        btnToStream = QPushButton('ToStream')
        btnToLines.clicked.connect(self.transfer2lines)
        btnToStream.clicked.connect(self.transfer2stream)
        btnSelectFileTab5_1 = QPushButton('...')
        btnSelectFileTab5_1.clicked.connect(self.select_fileTab5_1)

        self.tab5.layout.addWidget(nameLabel1, 0, 0)
        self.tab5.layout.addWidget(self.textboxTab5_1, 0, 1)
        self.tab5.layout.addWidget(btnSelectFileTab5_1, 0, 2)
        self.tab5.layout.addWidget(btnToLines, 1, 2)
        self.tab5.layout.addWidget(btnToStream, 2, 2)
        self.tab5.setLayout(self.tab5.layout)

    def mytab6(self):
        self.tab6.layout = QGridLayout()
        nameLabel1 = QLabel('Data for 837:')
        self.textboxTab6_1 = QLineEdit()
        btnSelectTab6_1 = QPushButton('...')
        btnSelectTab6_1.clicked.connect(self.select_fileTab6_1)
        nameLabel2 = QLabel('837 Response 277:')
        self.textboxTab6_2 = QLineEdit()
        btnSelectTab6_2 = QPushButton('...')
        btnSelectTab6_2.clicked.connect(self.select_fileTab6_2)
        btnRun6 = QPushButton('Run')
        btnRun6.clicked.connect(self.generate_276)
        btnquit6 = QPushButton('Quit')
        btnquit6.clicked.connect(self.close_application)

        self.checkboxTab6 = QCheckBox('Process 277?', self)
        self.checkboxTab6.stateChanged.connect(self.checkbox276277)

        self.nameLabel3 = QLabel("Process 276's 277:")
        self.textboxTab6_3 = QLineEdit()
        self.btnSelectTab6_3 = QPushButton('...')
        self.btnSelectTab6_3.clicked.connect(self.select_fileTab6_3)
        self.btnProcess = QPushButton('Process')
        self.btnProcess.clicked.connect(self.process276277)

        self.nameLabel3.hide()
        self.textboxTab6_3.hide()
        self.btnSelectTab6_3.hide()
        self.btnProcess.hide()

        self.tab6.layout.addWidget(nameLabel1, 0, 0)
        self.tab6.layout.addWidget(self.textboxTab6_1, 0 ,1)
        self.tab6.layout.addWidget(btnSelectTab6_1, 0, 2)
        self.tab6.layout.addWidget(nameLabel2, 1, 0)
        self.tab6.layout.addWidget(self.textboxTab6_2, 1, 1)
        self.tab6.layout.addWidget(btnSelectTab6_2, 1, 2)
        self.tab6.layout.addWidget(btnRun6, 2, 2)
        self.tab6.layout.addWidget(self.checkboxTab6, 2, 0)
        self.tab6.layout.addWidget(self.nameLabel3, 3, 0)
        self.tab6.layout.addWidget(self.textboxTab6_3, 3, 1)
        self.tab6.layout.addWidget(self.btnSelectTab6_3, 3, 2)
        self.tab6.layout.addWidget(self.btnProcess, 3, 3)

        self.tab6.layout.addWidget(btnquit6, 4, 0)
        self.tab6.setLayout(self.tab6.layout)

    def select_file1(self):
        self.file_name1, _ = QFileDialog.getOpenFileName(self, 'Open File', options=QFileDialog.DontUseNativeDialog)
        self.textbox1.setText(self.file_name1)

    def select_fileTab2_1(self):
        self.file_name2_1, _ = QFileDialog.getOpenFileName(self, 'Open File', options=QFileDialog.DontUseNativeDialog)
        self.textboxTab2_1.setText(self.file_name2_1)

    def select_fileTab3_1(self):
        self.file_name3_1, _ = QFileDialog.getOpenFileName(self, 'Select File', options=QFileDialog.DontUseNativeDialog)
        self.textboxTab3_1.setText(self.file_name3_1)

    def select_fileTab5_1(self):
        self.file_name5_1, _ = QFileDialog.getOpenFileName(self, 'Select File', options=QFileDialog.DontUseNativeDialog)
        self.textboxTab5_1.setText(self.file_name5_1)

    def select_fileTab6_1(self):
        self.file_name6_1, _ = QFileDialog.getOpenFileName(self, 'Select File', options=QFileDialog.DontUseNativeDialog)
        self.textboxTab6_1.setText(self.file_name6_1)

    def select_fileTab6_2(self):
        self.file_name6_2, _ = QFileDialog.getOpenFileName(self, 'Select File', options=QFileDialog.DontUseNativeDialog)
        self.textboxTab6_2.setText(self.file_name6_2)

    def select_fileTab6_3(self):
        self.file_name6_3, _ = QFileDialog.getOpenFileName(self, 'Select File', options=QFileDialog.DontUseNativeDialog)
        self.textboxTab6_3.setText(self.file_name6_3)

    def close_application(self):
        choice = QMessageBox.question(self, 'Message',
                                      "Are you sure to quit?", QMessageBox.Yes |
                                      QMessageBox.No, QMessageBox.No)

        if choice == QMessageBox.Yes:
            sys.exit()
        else:
            pass

    def generate_837(self):
        choice = QMessageBox.question(self, 'Message', 'Are you sure to generate 837P?',
                                      QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

        if choice == QMessageBox.Yes:

            if not self.file_name1:
                QMessageBox.about(self, 'Message', 'Error!')

            else:
                edi = EDI837P(self.file_name1)
                prue_data_837 = edi.ISA_IEA()
                file_name = '837-' + edi.file_name + '.txt'

                P = Process_Method()
                P.write_txt(prue_data_837, file_name)
                P.transfer2lines(file_name, 'L'+file_name)
                QMessageBox.about(self, 'Message', 'File generated successfully!')
        else:
            pass

    def generate_270(self):
        choice = QMessageBox.question(self, 'Message', 'Are you sure to generate EDI 270?',
                                      QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

        if choice == QMessageBox.Yes:
            if not self.file_name2_1:
                QMessageBox.about(self, 'Message', 'Error!')

            else:
                edi = EDI270(self.file_name2_1)
                prue_data_270 = edi.ISA_IEA()
                file_name = edi.file_name

                P = Process_Method()
                P.write_txt(prue_data_270, file_name)
                P.transfer2lines(file_name)
                QMessageBox.about(self, 'Message', 'File generated successfully!')

        else:
            pass

    def generate_276(self):
        choice = QMessageBox.question(self, 'Message', 'Are you sure to generate EDI 276?',
                                      QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

        if choice == QMessageBox.Yes:
            if not self.file_name6_1 or not self.file_name6_2:
                QMessageBox.about(self, 'Message', 'Error!')

            else:
                P = Process_Method()
                data_for276 = P.ready_for_276_data(receipt837_file=self.file_name6_2, edi837_data=self.file_name6_1, lined_file=False)
                edi = EDI276(data_for276)
                prue_data276 = edi.ISA_IEA()
                file_name = edi.file_name
                P.write_txt(prue_data276, file_name)
                P.transfer2lines(file_name)
                QMessageBox.about(self, 'Message', 'File generated successfully!')
        else:
            pass

    def create_table(self, data):
        self.tableWidget = QTableWidget(self)
        countRow = data.__len__()
        countCol = data.shape[1]
        headers = data.columns.tolist()
        self.tableWidget.setRowCount(countRow)
        self.tableWidget.setColumnCount(countCol)
        for r in range(countRow):
            for c in range(countCol):
                self.tableWidget.setItem(r,c, QTableWidgetItem(str(data.ix[r,c])))

        self.tableWidget.setHorizontalHeaderLabels(headers)
        self.tableWidget.resizeColumnsToContents()
        self.tableWidget.resizeRowsToContents()
        self.tableWidget.move(0, 0)

        self.layout.addWidget(self.tableWidget)
        self.tab4.setLayout(self.tab4.layout)
        self.show()

    def switchToShow(self):

        if self.df.__len__() == 0:
            QMessageBox.about(self, 'Message', 'Process Data First!')
        else:
            # self.create_table(self.df)
            self.sub_win = EDI270data_subwindow(self.df)
            self.sub_win.show()

    def process_271(self):
        choice = QMessageBox.question(self, 'Message', 'Are you sure to process EDI 271?',
                                      QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

        if choice == QMessageBox.Yes:
            if not self.file_name3_1:
                QMessageBox.about(self, 'Message', 'Error!')
            else:
                P = Process_Method()
                SQ = mysqlite('EDI.db')

                self.df = P.process_270_receipt(self.file_name3_1, lined_file=False)
                SQ.upsert271(table='Eligibility271', data=self.df)
                QMessageBox.about(self, 'Message', 'File Processed Successfully!')

        else:
            pass

    def process276277(self):
        choice = QMessageBox.question(self, 'Message', "Are you sure to process EDI 276's 277?",
                                      QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

        if choice == QMessageBox.Yes:
            if not self.file_name6_3:
                QMessageBox.about(self, 'Message', 'Error!')

            else:
                P = Process_Method()
                P.process_276_receipt(self.file_name6_3, lined_file=False)
                QMessageBox.about(self, 'Message', 'File Processed Successfully!')

        else:
            pass

    def checkbox276277(self, state):
        if state == Qt.Checked:
            self.nameLabel3.show()
            self.textboxTab6_3.show()
            self.btnSelectTab6_3.show()
            self.btnProcess.show()

        else:
            self.nameLabel3.hide()
            self.textboxTab6_3.hide()
            self.btnSelectTab6_3.hide()
            self.btnProcess.hide()

    def AddUpdatePlancode(self):
        SQ = mysqlite('EDI.db')
        plancode = self.textboxTab4_2.text()
        providername = self.textboxTab4_3.text()
        tel = self.textboxTab4_4.text()
        plantype = self.textboxTab4_5.text()
        SQ.upsert_271_plancodes(table='PlanCodeLib', plancode=plancode, providername=providername,
                                tel=tel, plantype=plantype)

        QMessageBox.about(self, 'Message', 'Plan code {0} has been added now!'.format(plancode))

    def DeletePlancode(self):
        SQ = mysqlite('EDI.db')
        del_plancode = self.textboxTab4_7.text()
        SQ.delete_271_plancodes(table='PlanCodeLib', plancode=del_plancode)
        QMessageBox.about(self, 'Message', 'Plan code {0} has been deleted now!'.format(del_plancode))

    def ShowLib(self):
        # SQ = mysqlite('EDI.db')
        # data = SQ.get_data_from_271_plancode('PlanCodeLib')
        #
        # self.tableWidget = QTableWidget(self)
        # countRow = data.__len__()
        # countCol = data.shape[1]
        # headers = data.columns.tolist()
        # self.tableWidget.setRowCount(countRow)
        # self.tableWidget.setColumnCount(countCol)
        # for r in range(countRow):
        #     for c in range(countCol):
        #         self.tableWidget.setItem(r, c, QTableWidgetItem(str(data.ix[r, c])))
        #
        # self.tableWidget.setHorizontalHeaderLabels(headers)
        # self.tableWidget.resizeColumnsToContents()
        # self.tableWidget.resizeRowsToContents()
        # self.tableWidget.move(0, 0)
        #
        # self.layout.addWidget(self.tableWidget)
        # self.setLayout(self.layout)
        # self.show()
        self.second_win = ShowLib_subwindow()
        self.second_win.show()

    def transfer2lines(self):
        P = Process_Method()
        P.transfer2lines(self.file_name5_1)
        QMessageBox.about(self, 'Message', 'File generated successfully!')

    def transfer2stream(self):
        P = Process_Method()
        P.transfer2stream(self.file_name5_1)
        QMessageBox.about(self, 'Message', 'File generated successfully!')


class MyTabWidget(QTabWidget):
    def __init__(self, parent):
        super(QWidget, self).__init__(parent)
        self.layout = QGridLayout(self)
        # self.layout.setSpacing(2)

        self.tabs = QTabWidget()
        self.tab1 = QWidget()
        self.tab2 = QWidget()
        self.tab3 = QWidget()
        self.tab4 = QWidget()

        self.tabs.addTab(self.tab1, 'Process MAS')
        self.tabs.addTab(self.tab2, 'MAS Sign Off')
        self.tabs.addTab(self.tab3, 'Sign-off and PA Roster')
        self.tabs.addTab(self.tab4, 'Check Payment')

        self.bool_to837_file = False
        self.filenameTab3_3 = None
        self.ifcollect270 = False
        self.only270 = False

        self.mytab1()
        self.mytab2()
        self.mytab3()
        self.mytab4()

        ############### add tabs to Widget
        self.layout.addWidget(self.tabs)
        self.setLayout(self.layout)

################ tab 1  Process MAS from RAW DATA
    def mytab1(self):
        self.tab1.layout = QGridLayout()
        nameLabel = QLabel('MAS:')
        self.textbox = QLineEdit()
        btnSelect = QPushButton('...')
        btnSelect.clicked.connect(self.select_file)
        btnQuit = QPushButton('Quit')
        btnQuit.clicked.connect(self.close_application)
        btnRun1 = QPushButton('Run')
        btnRun1.clicked.connect(self.mas_raw_process)

        self.checkboxTab1 = QCheckBox('Collect Data For 270?', self)
        self.checkboxTab1.stateChanged.connect(self.SwitchToCollect270)

        self.checkboxTab1_2 = QCheckBox('Only Collect Data For 270', self)
        self.checkboxTab1_2.stateChanged.connect(self.OnlyCollect270)

        self.tab1.layout.addWidget(nameLabel, 0, 0)
        self.tab1.layout.addWidget(self.textbox, 0, 1)
        self.tab1.layout.addWidget(btnSelect, 0, 2)
        self.tab1.layout.addWidget(self.checkboxTab1, 1, 1)
        self.tab1.layout.addWidget(self.checkboxTab1_2, 2, 1)
        self.tab1.layout.addWidget(btnQuit, 3, 0)
        self.tab1.layout.addWidget(btnRun1, 0, 3)
        self.tab1.setLayout(self.tab1.layout)

################ tab 2 Sign off
    def mytab2(self):
        self.tab2.layout = QGridLayout()
        nameLabel1 = QLabel('Processed MAS:')
        self.textbox1 = QLineEdit()
        btnSelect1 = QPushButton('...')
        btnSelect1.clicked.connect(self.select_file1)
        nameLabel2 = QLabel('Total Jobs:')
        self.textbox2 = QLineEdit()
        btnSelect2 = QPushButton('...')
        btnSelect2.clicked.connect(self.select_file2)
        btnRun2 = QPushButton('Run')
        btnRun2.clicked.connect(self.mas_sign_off)
        btnQuit2 = QPushButton('Quit')
        btnQuit2.clicked.connect(self.close_application)

        # self.checkboxTab2 = QCheckBox('Also generate 837 file?', self)
        # self.checkboxTab2.stateChanged.connect(self.clickbox)

        self.tab2.layout.addWidget(nameLabel1, 0, 0)
        self.tab2.layout.addWidget(self.textbox1, 0, 1)
        self.tab2.layout.addWidget(btnSelect1, 0, 2)
        self.tab2.layout.addWidget(nameLabel2, 1, 0)
        self.tab2.layout.addWidget(self.textbox2, 1, 1)
        self.tab2.layout.addWidget(btnSelect2, 1, 2)
        self.tab2.layout.addWidget(btnRun2, 2, 1)

        self.tab2.layout.addWidget(btnQuit2, 3, 0)
        self.tab2.setLayout(self.tab2.layout)

################### tab3 SIGN OFF compares with PA roast ################
    def mytab3(self):

        self.tab3.layout = QGridLayout()
        nameLabelTab3_1 = QLabel('Sign-off:')
        self.textboxTab3_1 = QLineEdit()
        btnSelectTab3_1 = QPushButton('...')
        btnSelectTab3_1.clicked.connect(self.select_fileTab3_1)
        nameLabelTab3_2 = QLabel('PA Roster:')
        self.textboxTab3_2 = QLineEdit()
        btnSelectTab3_2 = QPushButton('...')
        btnSelectTab3_2.clicked.connect(self.select_fileTab3_2)
        btnRunTab3 = QPushButton('Run')
        btnRunTab3.clicked.connect(self.signoff_W_PA)
        btnQuitTab3 = QPushButton('Quit')
        btnQuitTab3.clicked.connect(self.close_application)

        self.checkboxTab3 = QCheckBox('Collect data for 837?', self)
        self.checkboxTab3.stateChanged.connect(self.clickbox)

        self.nameLabelTab3_3 = QLabel('Processed MAS:')
        self.textboxTab3_3 = QLineEdit()
        self.btnSelectTab3_3 = QPushButton('...')
        self.btnSelectTab3_3.clicked.connect(self.select_fileTab3_3)

        self.nameLabelTab3_3.hide()
        self.textboxTab3_3.hide()
        self.btnSelectTab3_3.hide()

        self.tab3.layout.addWidget(nameLabelTab3_1, 0, 0)
        self.tab3.layout.addWidget(self.textboxTab3_1, 0, 1)
        self.tab3.layout.addWidget(btnSelectTab3_1, 0, 2)
        self.tab3.layout.addWidget(nameLabelTab3_2, 1, 0)
        self.tab3.layout.addWidget(self.textboxTab3_2, 1, 1)
        self.tab3.layout.addWidget(btnSelectTab3_2, 1, 2)

        self.tab3.layout.addWidget(self.nameLabelTab3_3, 2, 0)
        self.tab3.layout.addWidget(self.textboxTab3_3, 2, 1)
        self.tab3.layout.addWidget(self.btnSelectTab3_3, 2, 2)

        self.tab3.layout.addWidget(btnRunTab3, 3, 1)
        self.tab3.layout.addWidget(self.checkboxTab3, 3, 0)
        self.tab3.layout.addWidget(btnQuitTab3, 4, 0)
        self.tab3.setLayout(self.tab3.layout)

    def mytab4(self):
        self.tab4.layout = QGridLayout()
        nameLabelTab4_1 = QLabel('MAS Correction:')
        self.textboxTab4_1 = QLineEdit()
        btnSelectTab4_1 = QPushButton('...')
        btnSelectTab4_1.clicked.connect(self.select_fileTab4_1)
        nameLabelTab4_2 = QLabel('Payment:')
        self.textboxTab4_2 = QLineEdit()
        btnSelectTab4_2 = QPushButton('...')
        btnSelectTab4_2.clicked.connect(self.select_fileTab4_2)
        btnRunTab4 = QPushButton('Run')
        btnRunTab4.clicked.connect(self.compare_after_payment)
        btnQuitTab4 = QPushButton('Quit')
        btnQuitTab4.clicked.connect(self.close_application)

        self.tab4.layout.addWidget(nameLabelTab4_1, 0, 0)
        self.tab4.layout.addWidget(self.textboxTab4_1, 0, 1)
        self.tab4.layout.addWidget(btnSelectTab4_1, 0, 2)
        self.tab4.layout.addWidget(nameLabelTab4_2, 1, 0)
        self.tab4.layout.addWidget(self.textboxTab4_2, 1, 1)
        self.tab4.layout.addWidget(btnSelectTab4_2, 1, 2)
        self.tab4.layout.addWidget(btnRunTab4, 3, 1)
        self.tab4.layout.addWidget(btnQuitTab4, 4, 0)
        self.tab4.setLayout(self.tab4.layout)

    def select_file(self):
        self.file_name, _ = QFileDialog.getOpenFileName(self, 'Select File', options=QFileDialog.DontUseNativeDialog)
        self.textbox.setText(self.file_name)

    def select_file1(self):
        self.file_name1, _ = QFileDialog.getOpenFileName(self, 'Select File', options=QFileDialog.DontUseNativeDialog)
        self.textbox1.setText(self.file_name1)

    def select_file2(self):
        self.file_name2, _ = QFileDialog.getOpenFileName(self, 'Select File', options=QFileDialog.DontUseNativeDialog)
        self.textbox2.setText(self.file_name2)

    def close_application(self):
        choice = QMessageBox.question(self, 'Message',
                                     "Are you sure to quit?", QMessageBox.Yes |
                                     QMessageBox.No, QMessageBox.No)

        if choice == QMessageBox.Yes:
            sys.exit()
        else:
            pass

    def SwitchToCollect270(self, state):
        if state == Qt.Checked:
            self.ifcollect270 = True
        else:
            self.ifcollect270 = False

    def OnlyCollect270(self, state):
        if state == Qt.Checked:
            self.only270 = True
        else:
            self.only270 = False


    def clickbox(self, state):
        if state == Qt.Checked:
            self.nameLabelTab3_3.show()
            self.textboxTab3_3.show()
            self.btnSelectTab3_3.show()
            self.bool_to837_file = True

        else:
            self.nameLabelTab3_3.hide()
            self.textboxTab3_3.hide()
            self.btnSelectTab3_3.hide()
            self.bool_to837_file = False

    def mas_raw_process(self):
        choice = QMessageBox.question(self, 'Message', 'Are you sure to process raw data?',
                                      QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

        if choice == QMessageBox.Yes:
            p = Process_MAS(self.file_name)

            if self.only270 == True:
                p.generate_270_data(tofile=True)

            elif self.ifcollect270 == True:
                p.generate_270_data(tofile=True)
                p.add_codes(tofile=True)

            sleep(0.5)
            QMessageBox.about(self, 'Message', 'File generated successfully!')

        else:
            pass

    def mas_sign_off(self):
        choice = QMessageBox.question(self, 'Message', 'Are you sure to process raw data?',
                                      QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

        if choice == QMessageBox.Yes:
            S = SignoffAndCompare()
            S.sign_off(self.file_name1, self.file_name2, tofile=True)
            sleep(0.5)
            QMessageBox.about(self, 'Message', 'File generated successfully!')

        else:
            pass

    def select_fileTab3_1(self):
        self.filenameTab3_1, _ = QFileDialog.getOpenFileName(self, 'Select File', options=QFileDialog.DontUseNativeDialog)
        self.textboxTab3_1.setText(self.filenameTab3_1)

    def select_fileTab3_2(self):
        self.filenameTab3_2, _ = QFileDialog.getOpenFileName(self, 'Select File', options=QFileDialog.DontUseNativeDialog)
        self.textboxTab3_2.setText(self.filenameTab3_2)

    def select_fileTab3_3(self):
        self.filenameTab3_3, _ = QFileDialog.getOpenFileName(self, 'Select File', options=QFileDialog.DontUseNativeDialog)
        self.textboxTab3_3.setText(self.filenameTab3_3)

    def select_fileTab4_1(self):
        self.filenameTab4_1, _ = QFileDialog.getOpenFileName(self, 'Select File', options=QFileDialog.DontUseNativeDialog)
        self.textboxTab4_1.setText(self.filenameTab4_1)

    def select_fileTab4_2(self):
        self.filenameTab4_2, _ = QFileDialog.getOpenFileName(self, 'Select File', options=QFileDialog.DontUseNativeDialog)
        self.textboxTab4_2.setText(self.filenameTab4_2)

    def compare_after_payment(self):
        choice = QMessageBox.question(self, 'Message', 'Are you sure to use payment file to compare?',
                                      QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

        if choice == QMessageBox.Yes:
            S = SignoffAndCompare()
            S.new_compare_after_payment(signoff_compare_PA_file=self.filenameTab4_1, payment_raw_file=self.filenameTab4_2)
            sleep(0.5)
            QMessageBox.about(self, 'Message', 'File generated successfully!')

        else:
            pass

    def signoff_W_PA(self):
        choice = QMessageBox.question(self, 'Message', 'Are you sure to compare two files?',
                                      QMessageBox.Yes | QMessageBox.No, QMessageBox.No)

        if choice == QMessageBox.Yes:
            S = SignoffAndCompare()
            S.compare_signoff_PA(self.filenameTab3_1, self.filenameTab3_2, tofile=True, to837=self.bool_to837_file, mas_2=self.filenameTab3_3)
            sleep(0.5)
            QMessageBox.about(self, 'Message', 'File Generated Successfully!')

        else:
            pass


class mysqlite():

    def __init__(self, BaseName):
        self.conn = sqlite3.connect(BaseName)
        self.cursor = self.conn.cursor()

    def create_table_271(self, table):
        self.cursor.execute('CREATE TABLE IF NOT EXISTS {0}(InvoiceNumber TEXT, EligibilityResult TEXT, ServiceDate DATE, PatientLN TEXT, PatientFN TEXT, PlanCode TEXT,\
                              Eligible TEXT, CIN TEXT, CoveredCodes TEXT,  DOB DATE, Gender TEXT, \
                               PayerName TEXT, PayerAddress TEXT, PayerTel TEXT, OtherPayer1Name TEXT, OtherPayer1Address TEXT, \
                               OtherPayer1Tel TEXT, OtherPayer1GroupNum TEXT, OtherPayer2Name TEXT, OtherPayer2Address TEXT, \
                               OtherPayer2Tel TEXT, OtherPayer2GroupNum TEXT, OtherPayerPolicyNum TEXT, UpdateDate DATE, PRIMARY KEY(InvoiceNumber))'.format(table))

    def upsert271(self, table, data):
        '''
        :param table: sql table name
        :param data: dataframe like
        :return: None
        '''
        self.create_table_271(table)
        data_len = data.__len__()

        for l in range(data_len):
            row_data = data.ix[l, :]

            invoice_num = row_data['Invoice number']
            eligibility_result = row_data['Eligibility Result']
            CIN = row_data['CIN']
            service_date = row_data['Service date']
            plan_code = row_data['Plan code']
            eligible = row_data['Eligible']
            covered_codes = row_data['Covered Codes']
            patient_ln = row_data['Patient firstname']
            patient_fn = row_data['Patient lastname']
            dob = row_data['Patient DOB']
            gender = row_data['Patient gender']
            payer_name = row_data['Payer name']
            payer_address = row_data['Payer address']
            payer_tel = row_data['Contact Tel.']
            otherpayer1name = row_data['Other Payer1 name']
            otherpayer1address = row_data['Other Payer1 address']
            otherpayer1tel = row_data['Other Payer1 tel.']
            otherpayer1groupnum = row_data['Other Payer1 group number']
            otherpayer2name = row_data['Other Payer2 name']
            otherpayer2address = row_data['Other Payer2 address']
            otherpayer2tel = row_data['Other Payer2 tel.']
            otherpayer2groupnum = row_data['Other Payer2 group number']
            otherpayerpolicynum = row_data['Other Payer policy number']
            update_date = datetime.today().date()


            self.cursor.execute('INSERT OR REPLACE INTO {0} (InvoiceNumber, EligibilityResult, ServiceDate, PatientLN, PatientFN, PlanCode, Eligible, CIN, CoveredCodes, DOB, \
                                    Gender, PayerName, PayerAddress, PayerTel, OtherPayer1Name, OtherPayer1Address, OtherPayer1Tel, OtherPayer1GroupNum, \
                                    OtherPayer2Name, OtherPayer2Address, OtherPayer2Tel, OtherPayer2GroupNum, OtherPayerPolicyNum, UpdateDate) \
                VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)'.format(table),
                (invoice_num, eligibility_result, service_date, patient_ln, patient_fn, plan_code, eligible, CIN, covered_codes, dob, gender, payer_name, payer_address, payer_tel,
                 otherpayer1name, otherpayer1address, otherpayer1tel, otherpayer1groupnum, otherpayer2name, otherpayer2address, otherpayer2tel, otherpayer2groupnum, otherpayerpolicynum, update_date))

        self.conn.commit()

    def create_table_manuallyCheck_lib(self, table):
        self.cursor.execute('CREATE TABLE IF NOT EXISTS {0}(Eligible TEXT, PatientLN TEXT, PatientFN TEXT, CIN TEXT, Description TEXT, UpdateDate DATE, PRIMARY KEY(CIN))'.format(table))

    def manuallyUpsert271Lib(self, table, eligible, patient_ln, patient_fn, cin, description):
        self.create_table_manuallyCheck_lib(table)
        update_date = datetime.today().date()
        self.cursor.execute('INSERT OR REPLACE INTO {0} (Eligible, PatientLN, PatientFN, CIN, Description, UpdateDate) VALUES (?,?,?,?,?,?)'.format(table),
                            (eligible, patient_ln, patient_fn, cin, description, update_date))
        self.conn.commit()

    def delete_manually271Lib(self, table, cin):
        self.cursor.execute('DELETE FROM {0} WHERE cin="{1}"'.format(table, cin))
        self.conn.commit()

    def delete_lastmonth_manually271Lib(self, table):
        self.cursor.execute(f'SELECT UpdateDate, CIN FROM {table}')
        response = self.cursor.fetchall()
        current_month = arrow.now().date().month
        
        for res in response:
            date, cin = res
            month_of_date = arrow.get(date).date().month
            if month_of_date != current_month:
                self.delete_manually271Lib(table, cin)
                print(f'CIN: {cin} is expired!')
            else:
                pass

    def generate_excel_from_manually271Lib(self, table, tofile=True):
        date = datetime.today().date()
        df = pd.read_sql('SELECT * FROM {0}'.format(table), con=self.conn)
        if tofile==True:

            current_path = os.getcwd()
            daily_folder = str(datetime.today().date())
            basename = info_locker.base_info['BaseName']
            file_saving_path = os.path.join(current_path, basename, daily_folder)
            if not os.path.exists(file_saving_path):
                os.makedirs(file_saving_path)
                print('Save files to {0}'.format(file_saving_path))
            df.to_excel('Manually Checking Lib-' + str(date) + '.xlsx', index=False)
        return df

    def create_table_271_plancodes(self, table):
        self.cursor.execute('CREATE TABLE IF NOT EXISTS {0}(PlanCode TEXT, ProviderName TEXT, Telephone TEXT, PlanType TEXT, PRIMARY KEY(PlanCode))'.format(table))

    def upsert_271_plancodes(self, table, plancode, providername, tel, plantype):
        '''
        :param table: table name in sqlite database
        :param data: string
        :return: insert or replace data in table
        '''
        # data_len = data.__len__()
        #
        # for l in range(data_len):
        #     row_data = data.ix[l, :]
        #     plancode = row_data['PlanCode']
        #     providername = row_data['ProviderName']
        #     tel = row_data['Telephone']
        #     plantype = row_data['PlanType']
        self.create_table_271_plancodes(table)
        self.cursor.execute('INSERT OR REPLACE INTO {0} (PlanCode, ProviderName, Telephone, PlanType) VALUES (?, ?, ?, ?)'.format(table),
              (plancode, providername, tel, plantype))

        self.conn.commit()

    def delete_271_plancodes(self, table, plancode):
        '''
        :param table: table name in sqlite database
        :param plancode: plan code, string type
        :return: delete plan code in table
        '''
        self.cursor.execute('DELETE FROM {0} WHERE PlanCode={1}'.format(table, plancode))
        self.conn.commit()

    def get_data_from_271_plancode(self, table):
        df = pd.read_sql('SELECT * FROM {0}'.format(table), con=self.conn)
        return df

    def IfplancodeInDB(self, table, plancode):
        self.cursor.execute('SELECT PlanCode FROM {0} WHERE PlanCode="{1}"'.format(table, plancode))
        res = self.cursor.fetchone()
        if not res:
            return False
        else:
            return True

    def create_table_276277(self, table):
        self.cursor.execute('CREATE TABLE IF NOT EXISTS {0}(Code TEXT, Description TEXT, PRIMARY KEY(Code))'.format(table))

    def upsert_276277_codes(self, table, code, description):
        self.create_table_276277(table)
        self.cursor.execute('INSERT OR REPLACE INTO {0} (Code, Description) VALUES (?, ?)'.format(table),
                            (code, description))

        self.conn.commit()

    def create_table_for_addbase(self, table):
        self.cursor.execute('CREATE TABLE IF NOT EXISTS {0}(BaseName TEXT, BaseAddress TEXT, City TEXT, State TEXT, zipcode TEXT, ETIN TEXT, NPI TEXT, MedicaidProviderNum TEXT, TaxID TEXT, ContactName TEXT, ContactTel TEXT, LocationCode TEXT, PRIMARY KEY(NPI))'.format(table))

    def upsert_newbase(self, table, basename, baseaddress, city, state, zipcode, etin, npi, medicaid_provider_num, taxid, contactname, contactTel, locationcode):
        self.create_table_for_addbase(table)
        self.cursor.execute('INSERT OR REPLACE INTO {0} (BaseName, BaseAddress, City, State, zipcode, ETIN, NPI, MedicaidProviderNum, TaxID, ContactName, ContactTel, LocationCode) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)'.format(table),
                            (basename, baseaddress.upper(), city.upper(), state, zipcode, etin, npi, medicaid_provider_num, taxid, contactname.upper(), contactTel, locationcode))
        self.conn.commit()

    def delete_newbase(self, table, npi):
        self.cursor.execute('DELETE FROM {0} WHERE NPI="{1}"'.format(table, npi))
        self.conn.commit()

    def create_table_for_driver(self, table):
        self.cursor.execute('CREATE TABLE IF NOT EXISTS {0}(Fleet TEXT, Base TEXT, FirstName TEXT, LastName TEXT, DRIVER_ID INTEGER, VEHICLE_ID TEXT, PRIMARY KEY(DRIVER_ID))'.format(table))

    def upsert_newdriver(self, table, fleet, base, firstname, lastname, driverid, vehicleid):
        # print(fleet, base, firstname, lastname, driverid, vehicleid)
        self.create_table_for_driver(table)
        self.cursor.execute('INSERT OR REPLACE INTO {0} (Fleet, Base, FirstName, LastName, DRIVER_ID, VEHICLE_ID) VALUES (?,?,?,?,?,?)'.format(table), (fleet.upper(), base, firstname.upper(), lastname.upper(), driverid, vehicleid.upper()))
        self.conn.commit()

    def delete_driver(self, table, fleet, base):
        self.cursor.execute('DELETE FROM {0} WHERE Fleet="{1}" and Base="{2}"'.format(table, fleet, base))
        self.conn.commit()

    def get_data_from_driver(self, table, base):
        df = pd.read_sql('SELECT * FROM {0} WHERE Base="{1}"'.format(table, base), con=self.conn)
        return df


if __name__ == '__main__':
    chineseDragon = '''
        ......................................&&.........................
        ....................................&&&..........................
        .................................&&&&............................
        ...............................&&&&..............................
        .............................&&&&&&..............................
        ...........................&&&&&&....&&&..&&&&&&&&&&&&&&&........
        ..................&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&..............
        ................&...&&&&&&&&&&&&&&&&&&&&&&&&&&&&.................
        .......................&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&.........
        ...................&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&...............
        ..................&&&   &&&&&&&&&&&&&&&&&&&&&&&&&&&&&............
        ...............&&&&&@  &&&&&&&&&&..&&&&&&&&&&&&&&&&&&&...........
        ..............&&&&&&&&&&&&&&&.&&....&&&&&&&&&&&&&..&&&&&.........
        ..........&&&&&&&&&&&&&&&&&&...&.....&&&&&&&&&&&&&...&&&&........
        ........&&&&&&&&&&&&&&&&&&&.........&&&&&&&&&&&&&&&....&&&.......
        .......&&&&&&&&.....................&&&&&&&&&&&&&&&&.....&&......
        ........&&&&&.....................&&&&&&&&&&&&&&&&&&.............
        ..........&...................&&&&&&&&&&&&&&&&&&&&&&&............
        ................&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&............
        ..................&&&&&&&&&&&&&&&&&&&&&&&&&&&&..&&&&&............
        ..............&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&....&&&&&............
        ...........&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&......&&&&............
        .........&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&.........&&&&............
        .......&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&...........&&&&............
        ......&&&&&&&&&&&&&&&&&&&...&&&&&&...............&&&.............
        .....&&&&&&&&&&&&&&&&............................&&..............
        ....&&&&&&&&&&&&&&&.................&&...........................
        ...&&&&&&&&&&&&&&&.....................&&&&......................
        ...&&&&&&&&&&.&&&........................&&&&&...................
        ..&&&&&&&&&&&..&&..........................&&&&&&&...............
        ..&&&&&&&&&&&&...&............&&&.....&&&&...&&&&&&&.............
        ..&&&&&&&&&&&&&.................&&&.....&&&&&&&&&&&&&&...........
        ..&&&&&&&&&&&&&&&&..............&&&&&&&&&&&&&&&&&&&&&&&&.........
        ..&&.&&&&&&&&&&&&&&&&&.........&&&&&&&&&&&&&&&&&&&&&&&&&&&.......
        ...&&..&&&&&&&&&&&&.........&&&&&&&&&&&&&&&&...&&&&&&&&&&&&......
        ....&..&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&...........&&&&&&&&.....
        .......&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&..............&&&&&&&....
        .......&&&&&.&&&&&&&&&&&&&&&&&&..&&&&&&&&...&..........&&&&&&....
        ........&&&.....&&&&&&&&&&&&&.....&&&&&&&&&&...........&..&&&&...
        .......&&&........&&&.&&&&&&&&&.....&&&&&.................&&&&...
        .......&&&...............&&&&&&&.......&&&&&&&&............&&&...
        ........&&...................&&&&&&.........................&&&..
        .........&.....................&&&&........................&&....
        ...............................&&&.......................&&......
        ................................&&......................&&.......
        .................................&&..............................
        ..................................&..............................

    '''
    doge = '''
                           ::
                          :;J7, :,                        ::;7:
                          ,ivYi, ,                       ;LLLFS:
                          :iv7Yi                       :7ri;j5PL
                         ,:ivYLvr                    ,ivrrirrY2X,
                         :;r@Wwz.7r:                :ivu@kexianli.
                        :iL7::,:::iiirii:ii;::::,,irvF7rvvLujL7ur
                       ri::,:,::i:iiiiiii:i:irrv177JX7rYXqZEkvv17
                    ;i:, , ::::iirrririi:i:::iiir2XXvii;L8OGJr71i
                  :,, ,,:   ,::ir@mingyi.irii:i:::j1jri7ZBOS7ivv,
                     ,::,    ::rv77iiiriii:iii:i::,rvLq@huhao.Li
                 ,,      ,, ,:ir7ir::,:::i;ir:::i:i::rSGGYri712:
               :::  ,v7r:: ::rrv77:, ,, ,:i7rrii:::::, ir7ri7Lri
              ,     2OBBOi,iiir;r::        ,irriiii::,, ,iv7Luur:
            ,,     i78MBBi,:,:::,:,  :7FSL: ,iriii:::i::,,:rLqXv::
            :      iuMMP: :,:::,:ii;2GY7OBB0viiii:i:iii:i:::iJqL;::
           ,     ::::i   ,,,,, ::LuBBu BBBBBErii:i:i:i:i:i:i:r77ii
          ,       :       , ,,:::rruBZ1MBBqi, :,,,:::,::::::iiriri:
         ,               ,,,,::::i:  @arqiao.       ,:,, ,:::ii;i7:
        :,       rjujLYLi   ,,:::::,:::::::::,,   ,:i,:,,,,,::i:iii
        ::      BBBBBBBBB0,    ,,::: , ,:::::: ,      ,,,, ,,:::::::
        i,  ,  ,8BMMBBBBBBi     ,,:,,     ,,, , ,   , , , :,::ii::i::
        :      iZMOMOMBBM2::::::::::,,,,     ,,,,,,:,,,::::i:irr:i:::,
        i   ,,:;u0MBMOG1L:::i::::::  ,,,::,   ,,, ::::::i:i:iirii:i:i:
        :    ,iuUuuXUkFu7i:iii:i:::, :,:,: ::::::::i:i:::::iirr7iiri::
        :     :rk@Yizero.i:::::, ,:ii:::::::i:::::i::,::::iirrriiiri::,
         :      5BMBBBBBBSr:,::rv2kuii:::iii::,:i:,, , ,,:,:i@petermu.,
              , :r50EZ8MBBBBGOBBBZP7::::i::,:::::,: :,:,::i;rrririiii::
                  :jujYY7LS0ujJL7r::,::i::,::::::::::::::iirirrrrrrr:ii:
               ,:  :@kevensun.:,:,,,::::i:i:::::,,::::::iir;ii;7v77;ii;i,
               ,,,     ,,:,::::::i:iiiii:i::::,, ::::iiiir@xingjief.r;7:i,
            , , ,,,:,,::::::::iiiiiiiiii:,:,:::::::::iiir;ri7vL77rrirri::
             :,, , ::::::::i:::i:::i:i::,,,,,:,::i:i:::iir;@Secbone.ii:::

    '''
    alpaca = '''
             ┌─┐       ┌─┐
          ┌──┘ ┴───────┘ ┴──┐
          │                 │
          │       ───       │
          │  ─┬┘       └┬─  │
          │                 │
          │       ─┴─       │
          │                 │
          └───┐         ┌───┘
              │         │
              │         │
              │         │
              │         └──────────────┐
              │                        │
              │                        ├─┐
              │                        ┌─┘
              │                        │
              └─┐  ┐  ┌───────┬──┐  ┌──┘
                │ ─┤ ─┤       │ ─┤ ─┤
                └──┴──┘       └──┴──┘

            '''
    dragon = '''
                  ___====-_  _-====___
            _--^^^#####//      \\#####^^^--_
         _-^##########// (    ) \\##########^-_
        -############//  |\^^/|  \\############-
      _/############//   (@::@)   \\############\_
     /#############((     /\//     ))#############
    -################\    (oo)    //###############-
   -##################\  / VV \  //#################-
  -####################\/      \//###################-
 _#/|##########/\######(   /\   )######/\##########|\#_
 |/ |#/\#/\#/\/  \#/\##\  |  |  /##/\#/  \/\#/\#/\#| \|
 `  |/  V  V  `   V  \#\| |  | |/#/  V   '  V  V  \|  '
    `   `  `      `   / | |  | | \   '      '  '   '
                     (  | |  | |  )
                    __\ | |  | | /__
                    (vvv(VVV)(VVV)vvv)
                    '''
    operr_billing = '''
      ______   .______    _______ .______      .______      
     /  __  \  |   _  \  |   ____||   _  \     |   _  \     
    |  |  |  | |  |_)  | |  |__   |  |_)  |    |  |_)  |    
    |  |  |  | |   ___/  |   __|  |      /     |      /     
    |  `--'  | |  |      |  |____ |  |\  \----.|  |\  \----.
     \______/  | _|      |_______|| _| `._____|| _| `._____|
                                                            
    .______    __   __       __       __  .__   __.   _______ 
    |   _  \  |  | |  |     |  |     |  | |  \ |  |  /  _____|
    |  |_)  | |  | |  |     |  |     |  | |   \|  | |  |  __  
    |   _  <  |  | |  |     |  |     |  | |  . `  | |  | |_ | 
    |  |_)  | |  | |  `----.|  `----.|  | |  |\   | |  |__| | 
    |______/  |__| |_______||_______||__| |__| \__|  \______| '''
    operr_billing3_D = '''
    :'#######::'########::'########:'########::'########::
    '##.... ##: ##.... ##: ##.....:: ##.... ##: ##.... ##:
     ##:::: ##: ##:::: ##: ##::::::: ##:::: ##: ##:::: ##:
     ##:::: ##: ########:: ######::: ########:: ########::
     ##:::: ##: ##.....::: ##...:::: ##.. ##::: ##.. ##:::
     ##:::: ##: ##:::::::: ##::::::: ##::. ##:: ##::. ##::
    . #######:: ##:::::::: ########: ##:::. ##: ##:::. ##:
    :.......:::..:::::::::........::..:::::..::..:::::..::
    '########::'####:'##:::::::'##:::::::'####:'##::: ##::'######:::
     ##.... ##:. ##:: ##::::::: ##:::::::. ##:: ###:: ##:'##... ##::
     ##:::: ##:: ##:: ##::::::: ##:::::::: ##:: ####: ##: ##:::..:::
     ########::: ##:: ##::::::: ##:::::::: ##:: ## ## ##: ##::'####:
     ##.... ##:: ##:: ##::::::: ##:::::::: ##:: ##. ####: ##::: ##::
     ##:::: ##:: ##:: ##::::::: ##:::::::: ##:: ##:. ###: ##::: ##::
     ########::'####: ########: ########:'####: ##::. ##:. ######:::
    ........:::....::........::........::....::..::::..:::......::::
    '''
    operr_billing_smisome1 = '''
        ___       ___       ___       ___       ___   
       /\  \     /\  \     /\  \     /\  \     /\  \  
      /::\  \   /::\  \   /::\  \   /::\  \   /::\  \ 
     /:/\:\__\ /::\:\__\ /::\:\__\ /::\:\__\ /::\:\__
     \:\/:/  / \/\::/  / \:\:\/  / \;:::/  / \;:::/  /
      \::/  /     \/__/   \:\/  /   |:\/__/   |:\/__/ 
       \/__/               \/__/     \|__|     \|__|  
        ___       ___       ___       ___       ___       ___       ___   
       /\  \     /\  \     /\__\     /\__\     /\  \     /\__\     /\  \  
      /::\  \   _\:\  \   /:/  /    /:/  /    _\:\  \   /:| _|_   /::\  \ 
     /::\:\__\ /\/::\__\ /:/__/    /:/__/    /\/::\__\ /::|/\__\ /:/\:\__
     \:\::/  / \::/\/__/ \:\  \    \:\  \    \::/\/__/ \/|::/  / \:\:\/__/
      \::/  /   \:\__\    \:\__\    \:\__\    \:\__\     |:/  /   \::/  / 
       \/__/     \/__/     \/__/     \/__/     \/__/     \/__/     \/__/  '''
    operr_billing_3d = '''
       *******   *******  ******** *******   *******  
      **/////** /**////**/**///// /**////** /**////** 
     **     //**/**   /**/**      /**   /** /**   /** 
    /**      /**/******* /******* /*******  /*******  
    /**      /**/**////  /**////  /**///**  /**///**  
    //**     ** /**      /**      /**  //** /**  //** 
     //*******  /**      /********/**   //**/**   //**
      ///////   //       //////// //     // //     // 
     ******   ** **       **       ** ****     **   ******** 
    /*////** /**/**      /**      /**/**/**   /**  **//////**
    /*   /** /**/**      /**      /**/**//**  /** **      // 
    /******  /**/**      /**      /**/** //** /**/**         
    /*//// **/**/**      /**      /**/**  //**/**/**    *****
    /*    /**/**/**      /**      /**/**   //****//**  ////**
    /******* /**/********/********/**/**    //*** //******** 
    ///////  // //////// //////// // //      ///   //////// 
    '''
    operr_billing_gothic = '''
        __                                         
      ,-||-,   -__ /\\    ,- _~, -__ /\   -__ /\   
     ('|||  )    ||  \\  (' /| /   || \,    || \,  
    (( |||--))  /||__|| ((  ||/=  /|| /    /|| /   
    (( |||--))  \||__|| ((  ||    \||/-    \||/-   
     ( / |  )    ||  |,  ( / |     ||  \    ||  \  
      -____-   _-||-_/    -____- _---_-|, _---_-|, 
                 ||                                
                                                   
                                            __       __ ,  
    _-_ _,,   _-_, _-_-    _-_-    _-_,    /  -,   ,-| ~   
       -/  )    //  /,      /,       //   ||   )  ('||/__, 
      ~||_<     ||  ||      ||       ||  ~||---) (( |||  | 
       || \\   ~|| ~||     ~||      ~||  ~||---, (( |||==| 
       ,/--||   ||  ||      ||       ||  ~||  /   ( / |  , 
      _--_-'  _-_, (  -__, (  -__, _-_,   |, /     -____/  
     (                                  -_-  --~           
                                                   '''
    operr_billing_coinstk = '''
        O))))     O)))))))  O))))))))O)))))))    O)))))))    
      O))    O))  O))    O))O))      O))    O))  O))    O))  
    O))        O))O))    O))O))      O))    O))  O))    O))  
    O))        O))O)))))))  O))))))  O) O))      O) O))      
    O))        O))O))       O))      O))  O))    O))  O))    
      O))     O)) O))       O))      O))    O))  O))    O))  
        O))))     O))       O))))))))O))      O))O))      O))
                                                             
    O)) O))   O))O))      O))      O))O)))     O))   O))))   
    O)    O)) O))O))      O))      O))O) O))   O)) O)    O)) 
    O)     O))O))O))      O))      O))O)) O))  O))O))        
    O))) O)   O))O))      O))      O))O))  O)) O))O))        
    O)     O))O))O))      O))      O))O))   O) O))O))   O))))
    O)      O)O))O))      O))      O))O))    O) )) O))    O) 
    O)))) O)) O))O))))))))O))))))))O))O))      O))  O))))) 
    '''
    operr_billing_dom = '''
     ___________ _________________  ______ _____ _      _     _____ _   _ _____ 
    |  _  | ___ \  ___| ___ \ ___ \ | ___ \_   _| |    | |   |_   _| \ | |  __ \
    | | | | |_/ / |__ | |_/ / |_/ / | |_/ / | | | |    | |     | | |  \| | |  \/
    | | | |  __/|  __||    /|    /  | ___ \ | | | |    | |     | | | . ` | | __ 
    \ \_/ / |   | |___| |\ \| |\ \  | |_/ /_| |_| |____| |_____| |_| |\  | |_\ \
     \___/\_|   \____/\_| \_\_| \_| \____/ \___/\_____/\_____/\___/\_| \_/\____/
    '''
    operr_billing_gra = '''
    ________ _________________________________________ 
    \_____  \______   \_   _____/\______   \______    \
     /   |   \|     ___/|    __)_  |       _/|       _/
    /    |    \    |    |        \ |    |   \|    |   \
    \_______  /____|   /_______  / |____|_  /|____|_  /
            \/                 \/         \/        \/ 
    __________.___.____    .____    .___ _______    ________ 
    \______   \   |    |   |    |   |   |\      \  /  _____/ 
     |    |  _/   |    |   |    |   |   |/   |   \/   \  ___ 
     |    |   \   |    |___|    |___|   /    |    \    \_\  \
     |______  /___|_______ \_______ \___\____|__  /\______  /
            \/            \/       \/           \/        \/ 
    '''

    fig_list = [operr_billing, operr_billing3_D, operr_billing_gothic, operr_billing_smisome1, operr_billing_3d,
                chineseDragon, doge, alpaca, dragon]
    fig_list = np.random.permutation(fig_list)
    _version = "0.6.20"

    print(fig_list[0])
    print('\n')
    print(f'OPERR BILLING VERISON: {_version}')

    def run():
        SQ = mysqlite('EDI.db')
        app = QApplication(sys.argv)
        Gui = window()
        SQ.cursor.close()
        SQ.conn.close()
        sys.exit(app.exec_())
    run()















